(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-3dd3b289","chunk-2d0d03a7","chunk-2d0d03a7","chunk-50b6f093","chunk-2d0d3e74","chunk-2d0d3e74"],{"07c7":function(e,t,r){"use strict";r.d(t,"a",(function(){return u})),r.d(t,"b",(function(){return S})),r.d(t,"c",(function(){return b})),r.d(t,"d",(function(){return d})),r.d(t,"e",(function(){return f})),r.d(t,"f",(function(){return p})),r.d(t,"g",(function(){return o})),r.d(t,"h",(function(){return y})),r.d(t,"i",(function(){return s})),r.d(t,"j",(function(){return l})),r.d(t,"k",(function(){return h}));var n=r("89da"),a=r("853c"),i=r("66a2");function s(e,t){return c(e.parseTree,t,e.parameters)}function l(e,t,r){return c(e,t,r)}function o(e,t,r,n){return i["WhereClause"].create(c(e.parseTree,a["a"].Standardised,e.parameters,t,r),n)}function u(e,t,r="AND"){return i["WhereClause"].create("(("+s(e,a["a"].Standardised)+")"+r+"("+s(t,a["a"].Standardised)+"))",e.fieldsIndex)}function c(e,t,r,n=null,a=null){let i,s,l,o;switch(e.type){case"interval":return S(c(e.value,t,r,n,a),e.qualifier,e.op);case"case_expression":{let i=" CASE ";"simple"===e.format&&(i+=c(e.operand,t,r,n,a));for(let s=0;s<e.clauses.length;s++)i+=" WHEN "+c(e.clauses[s].operand,t,r,n,a)+" THEN "+c(e.clauses[s].value,t,r,n,a);return null!==e.else&&(i+=" ELSE "+c(e.else,t,r,n,a)),i+=" END ",i}case"param":{const n=r[e.value.toLowerCase()];if("string"==typeof n)return"'"+r[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(n instanceof Date)return d(n,t);if(n instanceof Array){const e=[];for(let r=0;r<n.length;r++)"string"==typeof n[r]?e.push("'"+n[r].toString().replace(/'/g,"''")+"'"):n[r]instanceof Date?e.push(d(n[r],t)):e.push(n[r].toString());return e}return n.toString()}case"expr_list":s=[];for(const i of e.value)s.push(c(i,t,r,n,a));return s;case"unary_expr":return" ( NOT "+c(e.expr,t,r,n,a)+" ) ";case"binary_expr":switch(e.operator){case"AND":return" ("+c(e.left,t,r,n,a)+" AND "+c(e.right,t,r,n,a)+") ";case"OR":return" ("+c(e.left,t,r,n,a)+" OR "+c(e.right,t,r,n,a)+") ";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+c(e.left,t,r,n,a)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+c(e.left,t,r,n,a)+" IS NOT NULL )";case"IN":return i=[],"expr_list"===e.right.type?(i=c(e.right,t,r,n,a)," ("+c(e.left,t,r,n,a)+" IN ("+i.join(",")+")) "):(o=c(e.right,t,r,n,a),o instanceof Array?" ("+c(e.left,t,r,n,a)+" IN ("+o.join(",")+")) ":" ("+c(e.left,t,r,n,a)+" IN ("+o+")) ");case"NOT IN":return i=[],"expr_list"===e.right.type?(i=c(e.right,t,r,n,a)," ("+c(e.left,t,r,n,a)+" NOT IN ("+i.join(",")+")) "):(o=c(e.right,t,r,n,a),o instanceof Array?" ("+c(e.left,t,r,n,a)+" NOT IN ("+o.join(",")+")) ":" ("+c(e.left,t,r,n,a)+" NOT IN ("+o+")) ");case"BETWEEN":return l=c(e.right,t,r,n,a)," ("+c(e.left,t,r,n,a)+" BETWEEN "+l[0]+" AND "+l[1]+" ) ";case"NOTBETWEEN":return l=c(e.right,t,r,n,a)," ("+c(e.left,t,r,n,a)+" NOT BETWEEN "+l[0]+" AND "+l[1]+" ) ";case"LIKE":return""!==e.escape?" ("+c(e.left,t,r,n,a)+" LIKE "+c(e.right,t,r,n,a)+" ESCAPE '"+e.escape+"') ":" ("+c(e.left,t,r,n,a)+" LIKE "+c(e.right,t,r,n,a)+") ";case"NOT LIKE":return""!==e.escape?" ("+c(e.left,t,r,n,a)+" NOT LIKE "+c(e.right,t,r,n,a)+" ESCAPE '"+e.escape+"') ":" ("+c(e.left,t,r,n,a)+" NOT LIKE "+c(e.right,t,r,n,a)+") ";case"<>":case"<":case">":case">=":case"<=":case"=":case"*":case"-":case"+":case"/":return" ("+c(e.left,t,r,n,a)+" "+e.operator+" "+c(e.right,t,r,n,a)+") "}throw new Error("Not Supported Operator "+e.operator);case"null":return"null";case"bool":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return d(e.value,t);case"number":return e.value.toString();case"current_time":return f("date"===e.mode,t);case"column_ref":return n&&n.toLowerCase()===e.column.toLowerCase()?"("+a+")":e.column;case"function":{const i=c(e.args,t,r,n,a);return h(e.name,i,t)}}throw new Error("Unsupported sql syntax "+e.type)}function h(e,t,r){switch(e.toLowerCase().trim()){case"abs":if(1!==t.length)throw new Error("Invalid Parameter for call to ABS");return"abs("+t[0]+")";case"ceiling":case"ceil":if(1!==t.length)throw new Error("Invalid Parameter for call to CEILING");switch(r){case a["a"].Standardised:case a["a"].StandardisedNoInterval:default:return"CEILING("+t[0]+")"}case"floor":if(1!==t.length)throw new Error("Invalid Parameter for call to Floor");return"FLOOR("+t[0]+")";case"log":if(1!==t.length)throw new Error("Invalid Parameter for call to LOG");return"LOG("+t[0]+")";case"log10":if(1!==t.length)throw new Error("Invalid Parameter for call to LOG10");return"LOG10("+t[0]+")";case"power":if(2!==t.length)throw new Error("Invalid Parameter for call to POWER");return"POWER("+t[0]+","+t[1]+")";case"round":if(2===t.length)return"ROUND("+t[0]+","+t[1]+")";if(1===t.length)return"ROUND("+t[0]+")";throw new Error("Invalid Parameter for call to ROUND");case"truncate":if(t.length<1||t.length>2)throw new Error("Invalid Parameter for TRUNCATE function");switch(r){case a["a"].SqlServer:return"ROUND("+t[0]+(1===t.length?"0":","+t[1])+",1)";default:return"TRUNCATE("+t[0]+(1===t.length?")":","+t[1]+")")}case"char_length":case"len":if(1!==t.length)throw new Error("Invalid Parameter for CHAR_LENGTH function");switch(r){case a["a"].SqlServer:return"LEN("+t[0]+")";case a["a"].Oracle:return"LENGTH("+t[0]+")";default:return"CHAR_LENGTH("+t[0]+")"}case"concat":if(t.length<1)throw new Error("Invalid Parameter for CONCAT function");{let e="CONCAT(";for(let r=0;r<t.length;r++)0!==r&&(e+=","),e+=t[r];return e+=")",e}case"lower":case"lcase":if(1!==t.length)throw new Error("Invalid Parameter for Lower function");return"LOWER("+t[0]+")";case"upper":case"ucase":if(1!==t.length)throw new Error("Invalid Parameter for Upper function");return"UPPER("+t[0]+")";case"substring":{let e="";switch(r){case a["a"].Oracle:return e="SUBSTR("+t[0]+","+t[1],3===t.length&&(e+=","+t[2]),e+=")",e;case a["a"].SqlServer:return e=3===t.length?"SUBSTRING("+t[0]+","+t[1]+","+t[2]+")":"SUBSTRING("+t[0]+",  "+t[1]+", LEN("+t[0]+") - "+t[1]+")",e;default:return e="SUBSTRING("+t[0]+" FROM "+t[1],3===t.length&&(e+=" FOR "+t[2]),e+=")",e}}case"extract":return"EXTRACT("+t[0].replace(/\'/g,"")+" FROM "+t[1]+")"}throw new Error("Function Not Recognised")}function d(e,t){const r=n["m"].Moment(e),i=0===r.minute()&&0===r.hour()&&0===r.second()&&0===r.millisecond();switch(t){case a["a"].FILEGDB:case a["a"].Standardised:case a["a"].StandardisedNoInterval:return i?"date '"+r.format("YYYY-MM-DD")+"'":"date '"+r.format("YYYY-MM-DD HH:mm:ss")+"'";case a["a"].Oracle:return i?"TO_DATE('"+r.format("YYYY-MM-DD")+"','YYYY-MM-DD')":"TO_DATE('"+r.format("YYYY-MM-DD HH:mm:ss")+"','YYYY-MM-DD HH24:MI:SS')";case a["a"].SqlServer:return"'"+r.format(i?"YYYY-MM-DD":"YYYY-MM-DD HH:mm:ss")+"'";case a["a"].PGDB:return"#"+r.format(i?"MM-DD-YYYY":"MM-DD-YYYY HH:mm:ss")+"#";case a["a"].Postgres:return"TIMESTAMP '"+r.format(i?"YYYY-MM-DD":"YYYY-MM-DD HH:mm:ss")+"'";default:return"date '"+r.format("YYYY-MM-DD HH:mm:ss")+"'"}}function f(e,t){switch(t){case a["a"].FILEGDB:case a["a"].Standardised:case a["a"].StandardisedNoInterval:case a["a"].Oracle:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP";case a["a"].SqlServer:return e?"CAST(GETDATE() AS DATE)":"GETDATE()";case a["a"].PGDB:case a["a"].Postgres:default:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP"}}function p(e,t,r={}){const n={},a={},i={esriFieldTypeSmallInteger:"integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"double",esriFieldTypeDouble:"double",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"integer",oid:"integer",long:"integer","small-integer":"integer",integer:"integer",single:"double",double:"double",date:"date",string:"string"};for(const s of t){const e=i[s.type];n[s.name.toLowerCase()]=void 0===e?"":e}for(const s in r){const e=i[r[s]];a[s.toLowerCase()]=void 0===e?"":e}switch(_(n,e.parseTree,e.parameters,a)){case"double":return"double";case"integer":return"integer";case"double":return"double";case"date":return"date";case"string":return"string"}return""}function _(e,t,r,n){let a;switch(t.type){case"interval":return"integer";case"case_expression":{const a=[];if("simple"===t.format){for(let i=0;i<t.clauses.length;i++)a.push(_(e,t.clauses[i].value,r,n));null!==t.else&&a.push(_(e,t.else,r,n))}else{for(let i=0;i<t.clauses.length;i++)a.push(_(e,t.else,r,n));null!==t.else&&a.push(_(e,t.else,r,n))}return m(a)}case"param":{const e=n[t.value.toLowerCase()];if(void 0===e&&r){const e=r[t.value.toLowerCase()];if(void 0===e)return"";if(null===e)return"";if("string"==typeof e||e instanceof String)return"string";if("boolean"==typeof e)return"boolean";if(e instanceof Date)return"date";if("number"==typeof e)return e%1==0?"integer":"double"}return void 0===e?"":e}case"expr_list":{const a=[];for(const i of t.value)a.push(_(e,i,r,n));return a}case"unary_expr":return"boolean";case"binary_expr":switch(t.operator){case"AND":case"OR":return"boolean";case"IS":case"ISNOT":if("null"!==t.right.type)throw new Error("Unsupported RHS for IS");return"boolean";case"IN":case"NOT IN":case"BETWEEN":case"NOTBETWEEN":case"LIKE":case"NOT LIKE":return"boolean";case"<>":case"<":case">":case">=":case"<=":case"=":return"boolean";case"*":case"-":case"+":case"/":return m([_(e,t.left,r,n),_(e,t.right,r,n)]);default:throw new Error("Not Supported Operator "+t.operator)}case"null":return"";case"bool":return"boolean";case"string":return"string";case"number":return null===t.value?"":t.value%1==0?"integer":"double";case"date":case"timestamp":case"current_time":return"date";case"column_ref":{const r=e[t.column.toLowerCase()];return void 0===r?"":r}case"function":switch(t.name.toLowerCase()){case"position":case"extract":case"char_length":return"integer";case"round":return a=_(e,t.args,r,n),a instanceof Array?a.length>0?a[0]:"":a;case"sign":return a=_(e,t.args,r,n),a instanceof Array&&(a=m(a)),"integer"===a||"double"===a?a:"double";case"ceiling":case"floor":case"abs":{const a=_(e,t.args,r,n);return a instanceof Array?m(a):a}case"area":case"length":case"log":case"log10":case"sin":case"cos":case"tan":case"asin":case"acos":case"atan":case"power":return"double";case"substring":case"trim":case"concat":case"lower":case"upper":return"string";case"truncate":return"double";case"round":return a=_(e,t.args,r,n),a instanceof Array?a.length>0?a[0]:"":a}return""}throw new Error("Unsupported sql syntax "+t.type)}const g={boolean:1,string:2,integer:3,double:4,date:5};function m(e){if(e){let t="";for(const r of e)""!==r&&(t=""===t||g[t]<g[r]?r:t);return t}return""}function y(e,t){return w(e.parseTree,t)}function b(e){return"column_ref"===e.parseTree.type}function w(e,t){if(null==e)return!1;switch(e.type){case"when_clause":return w(e.operand,t)||w(e.value,t);case"case_expression":for(const r of e.clauses)if(w(r,t))return!0;return!("simple"!==e.format||!w(e.operand,t))||!(null===e.else||!w(e.else,t));case"param":return!1;case"expr_list":for(const r of e.value)if(w(r,t))return!0;return!1;case"unary_expr":return w(e.expr,t);case"binary_expr":return w(e.left,t)||w(e.right,t);case"null":case"bool":case"date":case"timestamp":case"string":case"number":return!1;case"column_ref":return t.toLowerCase()===e.column.toLowerCase();case"function":return w(e.args,t)}return!1}function v(e){let t="";return t+=e.period.toUpperCase(),t}function S(e,t,r){let n="";return n="interval-period"===t.type?v(t):v(t.start)+" TO "+v(t.end),"INTERVAL "+r+" "+e+" "+n}},"0816":function(e,t,r){"use strict";r.r(t),r.d(t,"registerFunctions",(function(){return x}));var n=r("f4cc"),a=r("89da"),i=r("0f90"),s=r("5dfc"),l=r("a1f3"),o=r("853c"),u=r("5eb8"),c=r("92a7"),h=r("94dc"),d=r("66a2"),f=r("07c7"),p=r("9c2d"),_=r("2cad"),g=r("96af"),m=r("5db9"),y=r("18df"),b=r("60fd"),w=r("5bd5"),v=r("3802"),S=r("e335");function F(e,t,r){const a=e.getVariables();if(a.length>0){const i=[];for(let e=0;e<a.length;e++){const n={name:a[e]};i.push(t.evaluateIdentifier(r,n))}return Object(n["b"])(i).then(t=>{const r={};for(let e=0;e<a.length;e++)r[a[e]]=t[e];return e.parameters=r,e})}return Object(n["u"])(e)}function O(e,t,r=null){for(const n in e)if(n.toLowerCase()===t.toLowerCase())return e[n];return r}function I(e){if(null===e)return null;const t={type:O(e,"type",""),name:O(e,"name","")};if("range"===t.type)t.range=O(e,"range",[]);else{t.codedValues=[];for(const r of O(e,"codedValues",[]))t.codedValues.push({name:O(r,"name",""),code:O(r,"code",null)})}return t}function j(e){if(null===e)return null;const t={},r=O(e,"wkt",null);null!==r&&(t.wkt=r);const n=O(e,"wkid",null);return null!==n&&(t.wkid=n),t}function T(e){if(null===e)return null;const t={hasZ:O(e,"hasz",!1),hasM:O(e,"hasm",!1)},r=O(e,"spatialreference",null);r&&(t.spatialReference=j(r));const n=O(e,"x",null);if(null!==n)return t.x=n,t.y=O(e,"y",null),t;const a=O(e,"rings",null);if(null!==a)return t.rings=a,t;const i=O(e,"paths",null);if(null!==i)return t.paths=i,t;const s=O(e,"points",null);if(null!==s)return t.points=s,t;for(const l of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const r=O(e,l,null);null!==r&&(t[l]=r)}return t}function x(e){"async"===e.mode&&(e.functions.getuser=function(t,r){return e.standardFunctionAsync(t,r,(e,r,n)=>{Object(a["J"])(n,1,2);let l=Object(a["c"])(n[1],""),o=!0===l;if(l=!0===l||!1===l?"":Object(a["y"])(l),n[0]instanceof s["a"]){let e=null;return t.services&&t.services.portal&&(e=t.services.portal),e=Object(S["getPortal"])(n[0],e),Object(S["lookupUser"])(e,l,o).then(e=>{if(e){const t=JSON.parse(JSON.stringify(e));for(const e of["lastLogin","created","modified"])void 0!==t[e]&&null!==t[e]&&(t[e]=new Date(t[e]));return i["a"].convertObjectToArcadeDictionary(t)}return null})}let u=null;if(Object(a["T"])(n[0])&&(u=n[0]),u)return o=!1,l?null:u.load().then(()=>u.getOwningSystemUrl()).then(e=>{if(!e)return l?null:u.getIdentityUser().then(e=>e?i["a"].convertObjectToArcadeDictionary({username:e}):null);let r=null;return t.services&&t.services.portal&&(r=t.services.portal),r=Object(S["getPortal"])(new s["a"](e),r),Object(S["lookupUser"])(r,l,o).then(e=>{if(e){const t=JSON.parse(JSON.stringify(e));for(const e of["lastLogin","created","modified"])void 0!==t[e]&&null!==t[e]&&(t[e]=new Date(t[e]));return i["a"].convertObjectToArcadeDictionary(t)}return null})});throw new Error("Invalid Parameter")})},e.signatures.push({name:"getuser",min:"1",max:"2"}),e.functions.featuresetbyid=function(t,r){return e.standardFunctionAsync(t,r,(e,t,r)=>{if(Object(a["J"])(r,2,4),r[0]instanceof h["a"]){const e=Object(a["y"])(r[1]);let t=Object(a["c"])(r[2],null);const n=Object(a["x"])(Object(a["c"])(r[3],!0));if(null===t&&(t=["*"]),!1===Object(a["B"])(t))throw new Error("Invalid Parameter");return r[0].featureSetById(e,n,t)}throw new Error("Invalid Parameter")})},e.signatures.push({name:"featuresetbyid",min:"2",max:"4"}),e.functions.featuresetbyportalitem=function(t,r){return e.standardFunctionAsync(t,r,(e,r,n)=>{if(Object(a["J"])(n,2,5),null===n[0])throw new Error("Portal is required");if(n[0]instanceof s["a"]){const e=Object(a["y"])(n[1]),r=Object(a["y"])(n[2]);let i=Object(a["c"])(n[3],null);const s=Object(a["x"])(Object(a["c"])(n[4],!0));if(null===i&&(i=["*"]),!1===Object(a["B"])(i))throw new Error("Invalid Parameter");let l=null;return t.services&&t.services.portal&&(l=t.services.portal),l=Object(S["getPortal"])(n[0],l),Object(S["constructFeatureSetFromPortalItem"])(e,r,t.spatialReference,i,s,l,t.lrucache)}if(!1===Object(a["v"])(n[0]))throw new Error("Portal is required");const i=Object(a["y"])(n[0]),l=Object(a["y"])(n[1]);let o=Object(a["c"])(n[2],null);const u=Object(a["x"])(Object(a["c"])(n[3],!0));if(null===o&&(o=["*"]),!1===Object(a["B"])(o))throw new Error("Invalid Parameter");if(t.services&&t.services.portal)return Object(S["constructFeatureSetFromPortalItem"])(i,l,t.spatialReference,o,u,t.services.portal,t.lrucache);throw new Error("Portal is required")})},e.signatures.push({name:"featuresetbyportalitem",min:"2",max:"5"}),e.functions.featuresetbyname=function(t,r){return e.standardFunctionAsync(t,r,(e,t,r)=>{if(Object(a["J"])(r,2,4),r[0]instanceof h["a"]){const e=Object(a["y"])(r[1]);let t=Object(a["c"])(r[2],null);const n=Object(a["x"])(Object(a["c"])(r[3],!0));if(null===t&&(t=["*"]),!1===Object(a["B"])(t))throw new Error("Invalid Parameter");return r[0].featureSetByName(e,n,t)}throw new Error("Invalid Parameter")})},e.signatures.push({name:"featuresetbyname",min:"2",max:"4"}),e.functions.featureset=function(t,r){return e.standardFunction(t,r,(e,r,n)=>{Object(a["J"])(n,1,1);let s=n[0];const l={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(Object(a["v"])(s))s=JSON.parse(s),void 0!==s.layerDefinition?(l.layerDefinition=s.layerDefinition,l.featureSet=s.featureSet,s.layerDefinition.spatialReference&&(l.layerDefinition.spatialReference=s.layerDefinition.spatialReference)):(l.featureSet.features=s.features,l.featureSet.geometryType=s.geometryType,l.layerDefinition.geometryType=l.featureSet.geometryType,l.layerDefinition.objectIdField=s.objectIdFieldName,l.layerDefinition.typeIdField=s.typeIdFieldName,l.layerDefinition.globalIdField=s.globalIdFieldName,l.layerDefinition.fields=s.fields,s.spatialReference&&(l.layerDefinition.spatialReference=s.spatialReference));else{if(!(n[0]instanceof i["a"]))throw new Error("Invalid Parameter");{s=JSON.parse(n[0].castToText());const e=O(s,"layerdefinition");if(null!==e){l.layerDefinition.geometryType=O(e,"geometrytype",""),l.featureSet.geometryType=l.layerDefinition.geometryType,l.layerDefinition.globalIdField=O(e,"globalidfield",""),l.layerDefinition.objectIdField=O(e,"objectidfield",""),l.layerDefinition.typeIdField=O(e,"typeidfield","");const t=O(e,"spatialreference",null);t&&(l.layerDefinition.spatialReference=j(t));for(const n of O(e,"fields",[])){const e={name:O(n,"name",""),alias:O(n,"alias",""),type:O(n,"type",""),nullable:O(n,"nullable",!0),editable:O(n,"editable",!0),length:O(n,"length",null),domain:I(O(n,"domain"))};l.layerDefinition.fields.push(e)}const r=O(s,"featureset",null);if(r){const e={};for(const t of l.layerDefinition.fields)e[t.name.toLowerCase()]=t.name;for(const t of O(r,"features",[])){const r={},n=O(t,"attributes",{});for(const t in n)r[e[t.toLowerCase()]]=n[t];l.featureSet.features.push({attributes:r,geometry:T(O(t,"geometry",null))})}}}else{l.layerDefinition.geometryType=O(s,"geometrytype",""),l.featureSet.geometryType=l.layerDefinition.geometryType,l.layerDefinition.objectIdField=O(s,"objectidfieldname",""),l.layerDefinition.typeIdField=O(s,"typeidfieldname","");const e=O(s,"spatialreference",null);e&&(l.layerDefinition.spatialReference=j(e));for(const r of O(s,"fields",[])){const e={name:O(r,"name",""),alias:O(r,"alias",""),type:O(r,"type",""),nullable:O(r,"nullable",!0),editable:O(r,"editable",!0),length:O(r,"length",null),domain:I(O(r,"domain"))};l.layerDefinition.fields.push(e)}const t={};for(const r of l.layerDefinition.fields)t[r.name.toLowerCase()]=r.name;for(const r of O(s,"features",[])){const e={},n=O(r,"attributes",{});for(const r in n)e[t[r.toLowerCase()]]=n[r];l.featureSet.features.push({attributes:e,geometry:T(O(r,"geometry",null))})}}}}if(0==(!!(o=l).layerDefinition&&!!o.featureSet&&!1!==function(e,t){for(const r of t)if(r===e)return!0;return!1}(o.layerDefinition.geometryType,["","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])&&null!==o.layerDefinition.objectIdField&&""!==o.layerDefinition.objectIdField&&!1!==Object(a["B"])(o.layerDefinition.fields)&&!1!==Object(a["B"])(o.featureSet.features)))throw new Error("Invalid Parameter");var o;return v["a"].create(l,t.spatialReference)})},e.signatures.push({name:"featureset",min:"1",max:"1"}),e.functions.filter=function(t,r){return e.standardFunctionAsync(t,r,(r,i,s)=>(Object(a["J"])(s,2,2),Object(a["T"])(s[0])?s[0].load().then(r=>{const a=d["WhereClause"].create(s[1],r.getFieldsIndex()),i=a.getVariables();if(i.length>0){const r=[];for(let n=0;n<i.length;n++){const a={name:i[n]};r.push(e.evaluateIdentifier(t,a))}return Object(n["b"])(r).then(e=>{const t={};for(let r=0;r<i.length;r++)t[i[r]]=e[r];return a.parameters=t,new p["a"]({parentfeatureset:s[0],whereclause:a})})}return Object(n["u"])(new p["a"]({parentfeatureset:s[0],whereclause:a}))}):e.failDefferred("Filter cannot accept this parameter type")))},e.signatures.push({name:"filter",min:"2",max:"2"}),e.functions.orderby=function(t,r){return e.standardFunctionAsync(t,r,(t,r,i)=>{if(Object(a["J"])(i,2,2),Object(a["T"])(i[0])){const e=new g["a"](i[1]);return Object(n["u"])(new m["a"]({parentfeatureset:i[0],orderbyclause:e}))}return e.failDefferred("Order cannot accept this parameter type")})},e.signatures.push({name:"orderby",min:"2",max:"2"}),e.functions.top=function(t,r){return e.standardFunctionAsync(t,r,(t,r,i)=>(Object(a["J"])(i,2,2),Object(a["T"])(i[0])?Object(n["u"])(new b["a"]({parentfeatureset:i[0],topnum:i[1]})):Object(a["B"])(i[0])?Object(a["w"])(i[1])>=i[0].length?i[0].slice(0):i[0].slice(0,Object(a["w"])(i[1])):Object(a["I"])(i[0])?Object(a["w"])(i[1])>=i[0].length()?i[0].slice(0):i[0].slice(0,Object(a["w"])(i[1])):e.failDefferred("Top cannot accept this parameter type")))},e.signatures.push({name:"top",min:"2",max:"2"}),e.functions.first=function(t,r){return e.standardFunctionAsync(t,r,(e,t,r)=>(Object(a["J"])(r,1,1),Object(a["T"])(r[0])?r[0].first(e.abortSignal).then(e=>{if(null!==e){const t=u["a"].createFromGraphicLikeObject(e.geometry,e.attributes,r[0]);t._underlyingGraphic=e,e=t}return e}):Object(a["B"])(r[0])?0===r[0].length?Object(n["u"])(null):Object(n["u"])(r[0][0]):Object(a["I"])(r[0])?0===r[0].length()?Object(n["u"])(null):Object(n["u"])(r[0].get(0)):null))},e.signatures.push({name:"first",min:"1",max:"1"}),e.functions.attachments=function(t,r){return e.standardFunctionAsync(t,r,(e,r,n)=>{Object(a["J"])(n,1,2);const s={minsize:-1,maxsize:-1,types:null};if(n.length>1)if(n[1]instanceof i["a"]){if(n[1].hasField("minsize")&&(s.minsize=Object(a["w"])(n[1].field("minsize"))),n[1].hasField("maxsize")&&(s.maxsize=Object(a["w"])(n[1].field("maxsize"))),n[1].hasField("types")){const e=Object(a["t"])(n[1].field("types"),!1);e.length>0&&(s.types=e)}}else if(null!==n[1])throw new Error("Invalid Parameter");if(n[0]instanceof u["a"]){let e=n[0]._layer;return e instanceof w["default"]&&(e=Object(S["constructFeatureSet"])(e,t.spatialReference,["*"],!0,t.lrucache)),null===e||!1===Object(a["T"])(e)?[]:e.load().then(()=>e.queryAttachments(n[0].field(e.objectIdField),s.minsize,s.maxsize,s.types))}if(null===n[0])return[];throw new Error("Invalid Parameter")})},e.signatures.push({name:"attachments",min:"1",max:"2"}),e.functions.featuresetbyrelationshipname=function(t,r){return e.standardFunctionAsync(t,r,(e,r,n)=>{Object(a["J"])(n,2,4);const i=n[0],s=Object(a["y"])(n[1]);let l=Object(a["c"])(n[2],null);const o=Object(a["x"])(Object(a["c"])(n[3],!0));if(null===l&&(l=["*"]),!1===Object(a["B"])(l))throw new Error("Invalid Parameter");if(null===n[0])return null;if(!(n[0]instanceof u["a"]))throw new Error("Invalid Parameter");let c=i._layer;return c instanceof w["default"]&&(c=Object(S["constructFeatureSet"])(c,t.spatialReference,["*"],!0,t.lrucache)),null===c||!1===Object(a["T"])(c)?null:c.load().then(e=>{const r=e.relationshipMetaData().filter(e=>e.name===s);if(0===r.length)return null;if(void 0!==r[0].relationshipTableId&&null!==r[0].relationshipTableId&&r[0].relationshipTableId>-1)return Object(S["constructFeatureSetFromRelationship"])(e,r[0],i.field(e.objectIdField),e.spatialReference,l,o,t.lrucache);let n=e.serviceUrl();return n?(n="/"===n.charAt(n.length-1)?n+r[0].relatedTableId.toString():n+"/"+r[0].relatedTableId.toString(),Object(S["constructFeatureSetFromUrl"])(n,e.spatialReference,l,o,t.lrucache).then(t=>t.load().then(()=>t.relationshipMetaData()).then(n=>{if(n=n.filter(e=>e.id===r[0].id),!1===i.hasField(r[0].keyField)||null===i.field(r[0].keyField))return e.getFeatureByObjectId(i.field(e.objectIdField),[r[0].keyField]).then(e=>{if(e){const a=d["WhereClause"].create(n[0].keyField+"= @id",t.getFieldsIndex());return a.parameters={id:e.attributes[r[0].keyField]},t.filter(a)}return new y["a"]({parentfeatureset:t})});const a=d["WhereClause"].create(n[0].keyField+"= @id",t.getFieldsIndex());return a.parameters={id:i.field(r[0].keyField)},t.filter(a)}))):null})})},e.signatures.push({name:"featuresetbyrelationshipname",min:"2",max:"4"}),e.functions.featuresetbyassociation=function(t,r){return e.standardFunctionAsync(t,r,(e,r,n)=>{Object(a["J"])(n,2,3);const i=n[0],s=Object(a["y"])(Object(a["c"])(n[1],"")).toLowerCase(),c=Object(a["v"])(n[2])?Object(a["y"])(n[2]):null;if(null===n[0])return null;if(!(n[0]instanceof u["a"]))throw new Error("Invalid Parameter");let h=i._layer;return h instanceof w["default"]&&(h=Object(S["constructFeatureSet"])(h,t.spatialReference,["*"],!0,t.lrucache)),null===h||!1===Object(a["T"])(h)?null:h.load().then(()=>{const e=h.serviceUrl();return Object(S["constructAssociationMetaDataFeatureSetFromUrl"])(e,t.spatialReference)}).then(e=>{let t=null,r=null,n=!1;if(null!==c&&""!==c&&void 0!==c){for(const t of e.terminals)t.terminalName===c&&(r=t.terminalId);null===r&&(n=!0)}const u=e.associations.getFieldsIndex(),f=u.get("TOGLOBALID").name,p=u.get("FROMGLOBALID").name,g=u.get("TOTERMINALID").name,m=u.get("FROMTERMINALID").name,y=u.get("FROMNETWORKSOURCEID").name,b=u.get("TONETWORKSOURCEID").name,w=u.get("ASSOCIATIONTYPE").name,v=u.get("ISCONTENTVISIBLE").name,S=u.get("OBJECTID").name;for(const a of h.fields)if("global-id"===a.type){t=i.field(a.name);break}let F=null,O=new _["d"](new l["a"]({name:"percentalong",alias:"percentalong",type:"double"}),d["WhereClause"].create("0",e.associations.getFieldsIndex())),I=new _["d"](new l["a"]({name:"side",alias:"side",type:"string"}),d["WhereClause"].create("''",e.associations.getFieldsIndex()));const j="globalid",T="globalId",x={};for(const a in e.lkp)x[a]=e.lkp[a].sourceId;const E=new _["e"](new l["a"]({name:"classname",alias:"classname",type:"string"}),null,x);let C="";switch(s){case"midspan":{C=`((${f}='${t}') OR ( ${p}='${t}')) AND (${w} IN (5))`,E.codefield=d["WhereClause"].create(`CASE WHEN (${f}='${t}') THEN ${y} ELSE ${b} END`,e.associations.getFieldsIndex());const r=Object(o["c"])(_["a"].findField(e.associations.fields,p));r.name=j,r.alias=j,F=new _["d"](r,d["WhereClause"].create(`CASE WHEN (${p}='${t}') THEN ${f} ELSE ${p} END`,e.associations.getFieldsIndex())),O=e.unVersion>=4?new _["c"](_["a"].findField(e.associations.fields,u.get("PERCENTALONG").name)):new _["d"](new l["a"]({name:"percentalong",alias:"percentalong",type:"double"}),d["WhereClause"].create("0",e.associations.getFieldsIndex()));break}case"junctionedge":{C=`((${f}='${t}') OR ( ${p}='${t}')) AND (${w} IN (4,6))`,E.codefield=d["WhereClause"].create(`CASE WHEN (${f}='${t}') THEN ${y} ELSE ${b} END`,e.associations.getFieldsIndex());const r=Object(o["c"])(_["a"].findField(e.associations.fields,p));r.name=j,r.alias=j,F=new _["d"](r,d["WhereClause"].create(`CASE WHEN (${p}='${t}') THEN ${f} ELSE ${p} END`,e.associations.getFieldsIndex())),I=new _["d"](new l["a"]({name:"side",alias:"side",type:"string"}),d["WhereClause"].create(`CASE WHEN (${w}=4) THEN 'from' ELSE 'to' END`,e.associations.getFieldsIndex()));break}case"connected":{let n=f+"='@T'",i=p+"='@T'";null!==r&&(n+=` AND ${g}=@A`,i+=` AND ${m}=@A`),C="(("+n+") OR ("+i+"))",C=Object(a["g"])(C,"@T",t),n=Object(a["g"])(n,"@T",t),null!==r&&(n=Object(a["g"])(n,"@A",r.toString()),C=Object(a["g"])(C,"@A",r.toString())),E.codefield=d["WhereClause"].create("CASE WHEN "+n+` THEN ${y} ELSE ${b} END`,e.associations.getFieldsIndex());const s=Object(o["c"])(_["a"].findField(e.associations.fields,p));s.name=j,s.alias=j,F=new _["d"](s,d["WhereClause"].create("CASE WHEN "+n+` THEN ${p} ELSE ${f} END`,e.associations.getFieldsIndex()));break}case"container":C=`${f}='${t}' AND ${w} = 2`,null!==r&&(C+=` AND ${g} = `+r.toString()),E.codefield=y,C="( "+C+" )",F=new _["b"](_["a"].findField(e.associations.fields,p),j,j);case"content":C=`(${p}='${t}' AND ${w} = 2)`,null!==r&&(C+=` AND ${m} = `+r.toString()),E.codefield=b,C="( "+C+" )",F=new _["b"](_["a"].findField(e.associations.fields,f),j,j);break;case"structure":C=`(${f}='${t}' AND ${w} = 3)`,null!==r&&(C+=` AND ${g} = `+r.toString()),E.codefield=y,C="( "+C+" )",F=new _["b"](_["a"].findField(e.associations.fields,p),j,T);break;case"attached":C=`(${p}='${t}' AND ${w} = 3)`,null!==r&&(C+=` AND ${m} = `+r.toString()),E.codefield=b,C="( "+C+" )",F=new _["b"](_["a"].findField(e.associations.fields,f),j,T);break;default:throw new Error("Invalid Parameter")}return n&&(C="1 <> 1"),new _["a"]({parentfeatureset:e.associations,adaptedFields:[new _["c"](_["a"].findField(e.associations.fields,S)),new _["c"](_["a"].findField(e.associations.fields,v)),F,I,E,O],extraFilter:C?d["WhereClause"].create(C,e.associations.getFieldsIndex()):null})})})},e.signatures.push({name:"featuresetbyassociation",min:"2",max:"6"}),e.functions.groupby=function(t,r){return e.standardFunctionAsync(t,r,(r,s,l)=>(Object(a["J"])(l,3,3),Object(a["T"])(l[0])?l[0].load().then(r=>{const s=[],o=[];let u=!1,c=[];if(Object(a["v"])(l[1]))c.push(l[1]);else if(l[1]instanceof i["a"])c.push(l[1]);else if(Object(a["B"])(l[1]))c=l[1];else{if(!Object(a["I"])(l[1]))return e.failDefferred("Illegal Value: GroupBy");c=l[1].toArray()}for(const t of c)if(Object(a["v"])(t)){const e=d["WhereClause"].create(Object(a["y"])(t),r.getFieldsIndex()),n=!0===Object(f["c"])(e)?Object(a["y"])(t):"%%%%FIELDNAME";s.push({name:n,expression:e}),"%%%%FIELDNAME"===n&&(u=!0)}else{if(!(t instanceof i["a"]))return e.failDefferred("Illegal Value: GroupBy");{const n=t.hasField("name")?t.field("name"):"%%%%FIELDNAME",a=t.hasField("expression")?t.field("expression"):"";if("%%%%FIELDNAME"===n&&(u=!0),!n)return e.failDefferred("Illegal Value: GroupBy");s.push({name:n,expression:d["WhereClause"].create(a||n,r.getFieldsIndex())})}}if(c=[],Object(a["v"])(l[2]))c.push(l[2]);else if(Object(a["B"])(l[2]))c=l[2];else if(Object(a["I"])(l[2]))c=l[2].toArray();else{if(!(l[2]instanceof i["a"]))return e.failDefferred("Illegal Value: GroupBy");c.push(l[2])}for(const t of c){if(!(t instanceof i["a"]))return e.failDefferred("Illegal Value: GroupBy");{const n=t.hasField("name")?t.field("name"):"",a=t.hasField("statistic")?t.field("statistic"):"",i=t.hasField("expression")?t.field("expression"):"";if(!n||!a||!i)return e.failDefferred("Illegal Value: GroupBy");o.push({name:n,statistic:a.toLowerCase(),expression:d["WhereClause"].create(i,r.getFieldsIndex())})}}if(u){const e={};for(const n of r.fields)e[n.name.toLowerCase()]=1;for(const r of s)"%%%%FIELDNAME"!==r.name&&(e[r.name.toLowerCase()]=1);for(const r of o)"%%%%FIELDNAME"!==r.name&&(e[r.name.toLowerCase()]=1);let t=0;for(const r of s)if("%%%%FIELDNAME"===r.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,r.name="FIELD_"+t.toString()}}const h=[];for(const n of s)h.push(F(n.expression,e,t));for(const n of o)h.push(F(n.expression,e,t));return h.length>0?Object(n["b"])(h).then(()=>Object(n["u"])(l[0].groupby(s,o))):Object(n["u"])(l[0].groupby(s,o))}):e.failDefferred("Illegal Value: GroupBy")))},e.signatures.push({name:"groupby",min:"3",max:"3"}),e.functions.distinct=function(t,r){return e.standardFunctionAsync(t,r,(r,s,l)=>Object(a["T"])(l[0])?(Object(a["J"])(l,2,2),l[0].load().then(r=>{const s=[];let o=[];if(Object(a["v"])(l[1]))o.push(l[1]);else if(l[1]instanceof i["a"])o.push(l[1]);else if(Object(a["B"])(l[1]))o=l[1];else{if(!Object(a["I"])(l[1]))return e.failDefferred("Illegal Value: GroupBy");o=l[1].toArray()}let u=!1;for(const t of o)if(Object(a["v"])(t)){const e=d["WhereClause"].create(Object(a["y"])(t),r.getFieldsIndex()),n=!0===Object(f["c"])(e)?Object(a["y"])(t):"%%%%FIELDNAME";s.push({name:n,expression:e}),"%%%%FIELDNAME"===n&&(u=!0)}else{if(!(t instanceof i["a"]))return e.failDefferred("Illegal Value: GroupBy");{const n=t.hasField("name")?t.field("name"):"%%%%FIELDNAME",a=t.hasField("expression")?t.field("expression"):"";if("%%%%FIELDNAME"===n&&(u=!0),!n)return e.failDefferred("Illegal Value: GroupBy");s.push({name:n,expression:d["WhereClause"].create(a||n,r.getFieldsIndex())})}}if(u){const e={};for(const n of r.fields)e[n.name.toLowerCase()]=1;for(const r of s)"%%%%FIELDNAME"!==r.name&&(e[r.name.toLowerCase()]=1);let t=0;for(const r of s)if("%%%%FIELDNAME"===r.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,r.name="FIELD_"+t.toString()}}const c=[];for(const n of s)c.push(F(n.expression,e,t));return c.length>0?Object(n["b"])(c).then(()=>Object(n["u"])(l[0].groupby(s,[]))):Object(n["u"])(l[0].groupby(s,[]))})):function(e,t,r,n){if(1===n.length){if(Object(a["B"])(n[0]))return Object(c["a"])(e,n[0],-1);if(Object(a["I"])(n[0]))return Object(c["a"])(e,n[0].toArray(),-1)}return Object(c["a"])(e,n,-1)}("distinct",0,0,l))})}},"0f1c":function(e,t,r){"use strict";r.d(t,"a",(function(){return _})),r.d(t,"b",(function(){return f})),r.d(t,"c",(function(){return p}));var n=r("b2b2"),a=r("4c37"),i=r("fc29"),s=r("2c4f");const l=["esri.Color","esri.portal.Portal","esri.symbols.support.Symbol3DAnchorPosition2D","esri.symbols.support.Symbol3DAnchorPosition3D"];function o(e){return e instanceof i["a"]}function u(e){return e instanceof s["a"]?Object.keys(e.items):o(e)?Object(a["a"])(e).keys():e?Object.keys(e):[]}function c(e,t){return e instanceof s["a"]?e.items[t]:e[t]}function h(e){return e?e.declaredClass:null}function d(e,t){const r=e.diff;if(r&&"function"==typeof r)return r(e,t);const a=u(e),i=u(t);if(0===a.length&&0===i.length)return;if(!a.length||!i.length||function(e,t){return!(!Array.isArray(e)||!Array.isArray(t))&&e.length!==t.length}(e,t))return{type:"complete",oldValue:e,newValue:t};const s=i.filter(e=>-1===a.indexOf(e)),f=a.filter(e=>-1===i.indexOf(e)),p=a.filter(r=>i.indexOf(r)>-1&&c(e,r)!==c(t,r)).concat(s,f).sort(),_=h(e);if(_&&l.indexOf(_)>-1&&p.length)return{type:"complete",oldValue:e,newValue:t};let g;const m=o(e)&&o(t);for(const l of p){const a=c(e,l),i=c(t,l);let s;(m||"function"!=typeof a&&"function"!=typeof i)&&a!==i&&(null==a&&null==i||(s=r&&r[l]&&"function"==typeof r[l]?r[l](a,i):"object"==typeof a&&"object"==typeof i&&h(a)===h(i)?d(a,i):{type:"complete",oldValue:a,newValue:i},Object(n["h"])(s)&&(Object(n["h"])(g)?g.diff[l]=s:g={type:"partial",diff:{[l]:s}})))}return g}function f(e,t){if(Object(n["g"])(e))return!1;const r=t.split(".");let a=e;for(const n of r){if("complete"===a.type)return!0;if("partial"!==a.type)return!1;{const e=a.diff[n];if(!e)return!1;a=e}}return!0}function p(e,t){for(const r of t)if(f(e,r))return!0;return!1}function _(e,t){if("function"!=typeof e&&"function"!=typeof t&&(e||t))return!e||!t||"object"==typeof e&&"object"==typeof t&&h(e)!==h(t)?{type:"complete",oldValue:e,newValue:t}:d(e,t)}},"18df":function(e,t,r){"use strict";var n=r("f4cc"),a=r("853c"),i=r("64fc"),s=r("4f73");t["a"]=class extends s["a"]{constructor(e){super(e),this.declaredClass="esri.layers.featureset.sources.Empty",this._maxProcessing=1e3,this._wset=new i["a"]([],[],!1,null),this._parent=e.parentfeatureset,this._databaseType=a["a"].Standardised}_getSet(){return Object(n["u"])(this._wset)}optimisePagingFeatureQueries(){}_isInFeatureSet(){return a["b"].NotInFeatureSet}_getFeature(){return Object(n["t"])(new Error("No Feature Found in EmptySet"))}queryAttachments(){return Object(n["u"])([])}_getFeatures(){return Object(n["u"])("success")}_featureFromCache(){return null}_fetchAndRefineFeatures(){return Object(n["t"])(new Error("Fetch and Refine should not be called in this featureset"))}_getFilteredSet(){return Object(n["u"])(new i["a"]([],[],!1,null))}_stat(e,t,r,n,a,i,s){return this._manualStat(e,t,i,s)}_canDoAggregates(){return Object(n["u"])(!1)}}},"1fbd":function(e,t,r){"use strict";class n{constructor(){this._databaseTypeMetaData={},this._layerInfo={}}clearDatabaseType(e){void 0===this._databaseTypeMetaData[e]&&delete this._databaseTypeMetaData[e]}getDatabaseType(e){return"MUSTBESET"===e||void 0===this._databaseTypeMetaData[e]?null:this._databaseTypeMetaData[e]}setDatabaseType(e,t){this._databaseTypeMetaData[e]=t}getLayerInfo(e){return void 0===this._layerInfo[e]?null:this._layerInfo[e]}setLayerInfo(e,t){this._layerInfo[e]=t}clearLayerInfo(e){void 0!==this._layerInfo[e]&&delete this._layerInfo[e]}}n.applicationCache=null,t["a"]=n},"2cad":function(e,t,r){"use strict";r.d(t,"a",(function(){return m})),r.d(t,"b",(function(){return p})),r.d(t,"c",(function(){return f})),r.d(t,"d",(function(){return g})),r.d(t,"e",(function(){return _}));var n=r("f4cc"),a=r("5996"),i=r("8d60"),s=r("853c"),l=r("8549"),o=r("64fc"),u=r("66a2"),c=r("07c7"),h=r("4f73");class d{constructor(){this.sqlRewritable=!1}postInitialization(e,t){}}class f extends d{constructor(e){super(),this.field=e,this.sqlRewritable=!0}extractValue(e){return e.attributes[this.field.name]}rewriteSql(e){return{rewritten:this.sqlRewritable,where:e}}}class p extends d{constructor(e,t,r){super(),this.originalField=e,this.sqlRewritable=!0,this.field=Object(s["c"])(e),this.field.name=t,this.field.alias=r}rewriteSql(e,t){return{rewritten:this.sqlRewritable,where:Object(c["g"])(e,this.field.name,this.originalField.name,t.getFieldsIndex())}}extractValue(e){return e.attributes[this.originalField.name]}}class _ extends d{constructor(e,t,r){super(),this.field=e,this.codefield=t,this.lkp=r,this.reverseLkp={};for(const n in r)this.reverseLkp[r[n]]=n;this.sqlRewritable=!0}rewriteSql(e,t){const r=this.evaluateNodeToWhereClause(e.parseTree,s["a"].Standardised,this.field.name,this.codefield instanceof u["WhereClause"]?Object(c["i"])(this.codefield,s["a"].Standardised):this.codefield,e.parameters);return r.indexOf(_.BADNESS)>=0?{rewritten:!1,where:e}:{rewritten:this.sqlRewritable,where:u["WhereClause"].create(r,t._parent.getFieldsIndex())}}evaluateNodeToWhereClause(e,t,r=null,n=null,a){let i,s,l,o;switch(e.type){case"interval":return Object(c["b"])(this.evaluateNodeToWhereClause(e.value,t,r,n,a),e.qualifier,e.op);case"case_expression":{let n=" CASE ";"simple"===e.format&&(n+=this.evaluateNodeToWhereClause(e.operand,t,r,_.BADNESS,a));for(let i=0;i<e.clauses.length;i++)n+=" WHEN "+this.evaluateNodeToWhereClause(e.clauses[i].operand,t,r,_.BADNESS,a)+" THEN "+this.evaluateNodeToWhereClause(e.clauses[i].value,t,r,_.BADNESS,a);return null!==e.else&&(n+=" ELSE "+this.evaluateNodeToWhereClause(e.else,t,r,_.BADNESS,a)),n+=" END ",n}case"param":{const r=a[e.value.toLowerCase()];if("string"==typeof r)return"'"+a[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(r instanceof Date)return Object(c["d"])(r,t);if(r instanceof Array){const e=[];for(let n=0;n<r.length;n++)"string"==typeof r[n]?e.push("'"+r[n].toString().replace(/'/g,"''")+"'"):r[n]instanceof Date?e.push(Object(c["d"])(r[n],t)):e.push(r[n].toString());return e}return r.toString()}case"expr_list":s=[];for(const i of e.value)s.push(this.evaluateNodeToWhereClause(i,t,r,n,a));return s;case"unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(e.expr,t,r,_.BADNESS,a)+" ) ";case"binary_expr":switch(e.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(e.left,t,r,n,a)+" AND "+this.evaluateNodeToWhereClause(e.right,t,r,n,a)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(e.left,t,r,n,a)+" OR "+this.evaluateNodeToWhereClause(e.right,t,r,n,a)+") ";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,t,r,n,a)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,t,r,n,a)+" IS NOT NULL )";case"IN":if(i=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){const i=[];let s=!0;for(const t of e.right.value){if("string"!==t.type){s=!1;break}if(void 0===this.lkp[t.value]){s=!1;break}i.push(this.lkp[t.value].toString())}if(s)return" ("+this.evaluateNodeToWhereClause(e.left,t,r,n,a)+" IN ("+i.join(",")+")) "}return i=this.evaluateNodeToWhereClause(e.right,t,r,n,a)," ("+this.evaluateNodeToWhereClause(e.left,t,r,n,a)+" IN ("+i.join(",")+")) "}return o=this.evaluateNodeToWhereClause(e.right,t,r,n,a),o instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,r,n,a)+" IN ("+o.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,r,n,a)+" IN ("+o+")) ";case"NOT IN":if(i=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){const i=[];let s=!0;for(const t of e.right.value){if("string"!==t.type){s=!1;break}if(void 0===this.lkp[t.value]){s=!1;break}i.push(this.lkp[t.value].toString())}if(s)return" ("+this.evaluateNodeToWhereClause(e.left,t,r,n,a)+" NOT IN ("+i.join(",")+")) "}return i=this.evaluateNodeToWhereClause(e.right,t,r,n,a)," ("+this.evaluateNodeToWhereClause(e.left,t,r,n,a)+" NOT IN ("+i.join(",")+")) "}return o=this.evaluateNodeToWhereClause(e.right,t,r,n,a),o instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,r,n,a)+" NOT IN ("+o.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,r,n,a)+" NOT IN ("+o+")) ";case"BETWEEN":return l=this.evaluateNodeToWhereClause(e.right,t,r,_.BADNESS,a)," ("+this.evaluateNodeToWhereClause(e.left,t,r,_.BADNESS,a)+" BETWEEN "+l[0]+" AND "+l[1]+" ) ";case"NOTBETWEEN":return l=this.evaluateNodeToWhereClause(e.right,t,r,_.BADNESS,a)," ("+this.evaluateNodeToWhereClause(e.left,t,r,_.BADNESS,a)+" NOT BETWEEN "+l[0]+" AND "+l[1]+" ) ";case"LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,r,_.BADNESS,a)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,r,_.BADNESS,a)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,r,_.BADNESS,a)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,r,_.BADNESS,a)+") ";case"NOT LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,r,_.BADNESS,a)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,r,_.BADNESS,a)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,r,_.BADNESS,a)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,r,_.BADNESS,a)+") ";case"<>":case"=":if("column_ref"===e.left.type&&"string"===e.right.type){if(e.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[e.right.value.toString()])return" ("+n+" "+e.operator+" "+this.lkp[e.right.value.toString()].toString()+") "}else if("column_ref"===e.right.type&&"string"===e.left.type&&e.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[e.right.value.toString()].toString()+" "+e.operator+" "+n+") ";return" ("+this.evaluateNodeToWhereClause(e.left,t,r,_.BADNESS,a)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,r,_.BADNESS,a)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(e.left,t,r,_.BADNESS,a)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,r,_.BADNESS,a)+") "}throw new Error("Not Supported Operator "+e.operator);case"null":return"null";case"bool":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return Object(c["d"])(e.value,t);case"number":return e.value.toString();case"current_time":return Object(c["e"])("date"===e.mode,t);case"column_ref":return r&&r.toLowerCase()===e.column.toLowerCase()?"("+n+")":e.column;case"function":{const n=this.evaluateNodeToWhereClause(e.args,t,r,_.BADNESS,a);return Object(c["k"])(e.name,n,t)}}throw new Error("Unsupported sql syntax "+e.type)}extractValue(e){return this.codefield instanceof u["WhereClause"]?this.reverseLkp[this.codefield.calculateValueCompiled(e)]:this.reverseLkp[e.attributes[this.codefield]]}}_.BADNESS="_!!!_BAD_LKP_!!!!";class g extends d{constructor(e,t){super(),this.field=e,this.sql=t}rewriteSql(e,t){return{rewritten:!0,where:Object(c["g"])(e,this.field.name,Object(c["i"])(this.sql,s["a"].Standardised),t.getFieldsIndex())}}extractValue(e){return this.sql.calculateValueCompiled(e)}}class m extends h["a"]{constructor(e){super(e),this._calcFunc=null,this.declaredClass="esri.arcade.featureset.actions.Adapted",this.adaptedFields=null,this._extraFilter=null,this._extraFilter=e.extraFilter,this._parent=e.parentfeatureset,this._maxProcessing=30,this.adaptedFields=e.adaptedFields}static findField(e,t){for(const r of e)if(r.name.toLowerCase()===t.toString().toLowerCase())return r;return null}_initialiseFeatureSet(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new a["a"]({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=s["m"].point,this.typeIdField="",this.types=null),this.fields=[];for(const e of this.adaptedFields)e.postInitialization(this,this._parent),this.fields.push(e.field)}_getSet(e){return null===this._wset?this._ensureLoaded().then(()=>this._extraFilter?this._getFilteredSet("",null,null,null,e):this._parent._getSet(e)).then(t=>(this._checkCancelled(e),this._wset=new o["a"](t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition)),this._wset)):Object(n["u"])(this._wset)}_isInFeatureSet(e){return this._parent._isInFeatureSet(e)}_getFeatures(e,t,r,a){const s=[];-1!==t&&void 0===this._featureCache[t]&&s.push(t);const u=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,u))return this._expandPagedSet(e,u,0,0,a).then(()=>this._getFeatures(e,t,r,a));let c=0;for(let n=e._lastFetchedIndex;n<e._known.length&&(c++,c<=r&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[n]]&&(e._known[n]!==t&&s.push(e._known[n]),s.length>=u-1)));n++);if(0===s.length)return Object(n["u"])("success");e=new o["a"]([],s,e._ordered,null);const h=Math.min(s.length,r);return this._parent._getFeatures(e,-1,h,a).then(()=>{this._checkCancelled(a);const e=[];for(let t=0;t<h;t++){const r=this._parent._featureFromCache(s[t]);void 0!==r&&e.push({geometry:r.geometry,attributes:r.attributes,id:s[t]})}for(const t of e){const e=[];for(const r of this.adaptedFields)e[r.field.name]=r.extractValue(t);this._featureCache[t.id]=new i["a"]({attributes:e,geometry:Object(l["a"])(t.geometry)})}return"success"})}_fetchAndRefineFeatures(){return Object(n["t"])(new Error("Fetch and Refine should not be called in this featureset"))}_getFilteredSet(e,t,r,n,a){let i=!1;const s=this.reformulateWithoutAdaptions(r);i=s.cannot,r=s.where;let l=!1;if(null!==n){l=!0;const e=[];for(const t of this.adaptedFields)if(!(t instanceof f)&&!0===n.scanForField(t.field.name)){if(!(t instanceof p)){n=null,l=!1;break}e.push({field:t.field.name,newfield:t.originalField.name})}n&&e.length>0&&(n=n.replaceFields(e))}return null!==r?null!==this._extraFilter&&(r=Object(c["a"])(this._extraFilter,r)):r=this._extraFilter,this._ensureLoaded().then(()=>this._parent._getFilteredSet(e,t,r,n,a)).then(e=>{let t;return this._checkCancelled(a),t=!0===i?new o["a"](e._candidates.slice(0).concat(e._known.slice(0)),[],!0===l&&e._ordered,this._clonePageDefinition(e.pagesDefinition)):new o["a"](e._candidates.slice(0),e._known.slice(0),!0===l&&e._ordered,this._clonePageDefinition(e.pagesDefinition)),t})}reformulateWithoutAdaptions(e){const t={cannot:!1,where:e};if(null!==e)for(const r of this.adaptedFields)if(!0===Object(c["h"])(e,r.field.name)){const n=r.rewriteSql(e,this);if(!0!==n.rewritten){t.cannot=!0,t.where=null;break}t.where=n.where}return t}_stat(e,t,r,a,i,s,l){let o=!1,u=this.reformulateWithoutAdaptions(t);return o=u.cannot,t=u.where,u=this.reformulateWithoutAdaptions(i),o=o||u.cannot,null!==(i=u.where)?null!==this._extraFilter&&(i=Object(c["a"])(this._extraFilter,i)):i=this._extraFilter,!0===o?null===i&&""===r&&null===a?this._manualStat(e,t,s,l):Object(n["u"])({calculated:!1}):this._parent._stat(e,t,r,a,i,s,l).then(n=>!1===n.calculated?null===i&&""===r&&null===a?this._manualStat(e,t,s,l):{calculated:!1}:n)}_canDoAggregates(e,t,r,a,i){if(null===this._parent)return Object(n["u"])(!1);for(let o=0;o<e.length;o++)for(const t of this.adaptedFields)if(e[o].toLowerCase()===t.field.name.toLowerCase()&&!(t instanceof f))return Object(n["u"])(!1);const s=[];for(let o=0;o<t.length;o++){const e=t[o];if(null!==e.workingexpr){const t=this.reformulateWithoutAdaptions(e.workingexpr);if(t.cannot)return Object(n["u"])(!1);const r=e.clone();r.workingexpr=t.where,s.push(r)}else s.push(e)}const l=this.reformulateWithoutAdaptions(i);return l.cannot?Object(n["u"])(!1):(null!==(i=l.where)?null!==this._extraFilter&&(i=Object(c["a"])(this._extraFilter,i)):i=this._extraFilter,this._parent._canDoAggregates(e,s,r,a,i))}_getAggregatePagesDataSourceDefinition(e,t,r,a,i,s,l){if(null===this._parent)return Object(n["t"])(new Error("Should never be called"));const o=[];for(let c=0;c<t.length;c++){const e=t[c];if(null!==e.workingexpr){const t=this.reformulateWithoutAdaptions(e.workingexpr);if(t.cannot)return Object(n["t"])(new Error("Should never be called"));const r=e.clone();r.workingexpr=t.where,o.push(r)}else o.push(e)}const u=this.reformulateWithoutAdaptions(i);return u.cannot?Object(n["t"])(new Error("Should never be called")):(null!==(i=u.where)?null!==this._extraFilter&&(i=Object(c["a"])(this._extraFilter,i)):i=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(e,o,r,a,i,s,l))}}},3802:function(e,t,r){"use strict";var n=r("f4cc"),a=r("3760"),i=r("8d60"),s=r("a1f3"),l=r("853c"),o=r("64fc"),u=r("07c7"),c=r("4f73"),h=r("a2b1"),d=r("c64f"),f=r("5bd5");class p extends c["a"]{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",this._removeGeometry=!1,this._overrideFields=null,this._forceIsTable=!1,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,!0===e.isTable&&(this._forceIsTable=!0),void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return l["f"]}end(){return this._layer}optimisePagingFeatureQueries(){}load(){return null===this._loadPromise&&(this._loadPromise=Object(n["c"])((e,t)=>{if(!0===this._layer.loaded)return this._initialiseFeatureSet(),void e(this);this._layer.when().then(()=>{try{this._initialiseFeatureSet(),e(this)}catch(e){t(e)}},t),this._layer.load()})),this._loadPromise}get gdbVersion(){return""}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{const e=[];for(const t of this.fields)if("oid"===t.type)e.push(t);else for(const r of this._layer.outFields)if(r.toLowerCase()===t.name.toLowerCase()){e.push(t);break}this.fields=e}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const r of this.fields)if("oid"===r.type)e.push(r),t.push(r.name);else for(const n of this._overrideFields)if(n.toLowerCase()===r.name.toLowerCase()){e.push(r),t.push(r.name);break}this.fields=e,this._overrideFields=t}this.objectIdField=this._layer.objectIdField;for(const e of this.fields)"global-id"===e.type&&(this.globalIdField=e.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=l["a"].Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}isTable(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}_isInFeatureSet(){return l["b"].InFeatureSet}_candidateIdTransform(e){return e}_getSet(e){return null===this._wset?this._ensureLoaded().then(()=>this._getFilteredSet("",null,null,null,e)).then(e=>(this._wset=e,e)):Object(n["u"])(this._wset)}_changeFeature(e){const t={};for(const r of this.fields)t[r.name]=e.attributes[r.name];return new i["a"]({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})}_getFilteredSet(e,t,r,a,i){let s="",c=!1;if(null!==a&&(s=a.constructClause(),c=!0),this.isTable()&&t&&null!==e&&""!==e){const e=new o["a"]([],[],!0,null);return Object(n["u"])(e)}const h=new d["a"];return h.where=null===r?null===t?"1=1":"":Object(u["i"])(r,l["a"].Standardised),h.spatialRelationship=this._makeRelationshipEnum(e),h.outSpatialReference=this.spatialReference,h.orderByFields=""!==s?s.split(","):null,h.geometry=null===t?null:t,h.returnGeometry=!0,h.relationParameter=this._makeRelationshipParam(e),this._layer.queryFeatures(h).then(e=>{if(null===e)return new o["a"]([],[],c,null);this._checkCancelled(i);const t=[];return e.features.forEach(e=>{const r=e.attributes[this._layer.objectIdField];t.push(r),this._featureCache[r]=this._changeFeature(e)}),new o["a"]([],t,c,null)})}_makeRelationshipEnum(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}_makeRelationshipParam(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""}_queryAllFeatures(){if(this._wset)return Object(n["u"])(this._wset);const e=new d["a"];return e.where="1=1",this._ensureLoaded().then(()=>{if(this._layer.source&&this._layer.source.items){const e=[];return this._layer.source.items.forEach(t=>{const r=t.attributes[this._layer.objectIdField];e.push(r),this._featureCache[r]=this._changeFeature(t)}),this._wset=new o["a"]([],e,!1,null),this._wset}return this._layer.queryFeatures(e).then(e=>{const t=[];return e.features.forEach(e=>{const r=e.attributes[this._layer.objectIdField];t.push(r),this._featureCache[r]=this._changeFeature(e)}),this._wset=new o["a"]([],t,!1,null),this._wset})})}_getFeatures(e,t,r){const a=[];-1!==t&&void 0===this._featureCache[t]&&a.push(t);for(let n=e._lastFetchedIndex;n<e._known.length&&(e._lastFetchedIndex+=1,!(void 0===this._featureCache[e._known[n]]&&(e._known[n]!==t&&a.push(e._known[n]),a.length>r)));n++);return 0===a.length?Object(n["u"])("success"):Object(n["t"])(new Error("Unaccounted for Features. Not in Feature Collection"))}_refineSetBlock(e){return Object(n["u"])(e)}_stat(){return Object(n["u"])({calculated:!1})}_canDoAggregates(){return Object(n["u"])(!1)}relationshipMetaData(){return[]}static _cloneAttr(e){const t={};for(const r in e)t[r]=e[r];return t}nativeCapabilities(){return{title:this._layer.title,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(e,t){let r=e.layerDefinition.objectIdField;const n=e.layerDefinition.typeIdField?e.layerDefinition.typeIdField:"",i=[];if(e.layerDefinition.types)for(const a of e.layerDefinition.types)i.push(h["a"].fromJSON(a));let l=e.layerDefinition.geometryType;void 0===l&&(l=e.featureSet.geometryType||"");let o=e.featureSet.features;const u=t.toJSON();if(""===r||void 0===r){let t=!1;for(const n of e.layerDefinition.fields)if("oid"===n.type||"esriFieldTypeOID"===n.type){r=n.name,t=!0;break}if(!1===t){let t="FID",n=!0,a=0;for(;n;){let r=!0;for(const n of e.layerDefinition.fields)if(n.name===t){r=!1;break}!0===r?n=!1:(a++,t="FID"+a.toString())}e.layerDefinition.fields.push({type:"esriFieldTypeOID",name:t,alias:t});const i=[];for(let r=0;r<o.length;r++)i.push({geometry:e.featureSet.features[r].geometry,attributes:e.featureSet.features[r].attributes?this._cloneAttr(e.featureSet.features[r].attributes):{}}),i[r].attributes[t]=r;o=i,r=t}}const c=[];for(const a of e.layerDefinition.fields)a instanceof s["a"]?c.push(a):c.push(s["a"].fromJSON(a));let d=l;switch(d){case"esriGeometryPoint":d="point";break;case"esriGeometryPolyline":d="polyline";break;case"esriGeometryPolygon":d="polygon";break;case"esriGeometryExtent":d="extent";break;case"esriGeometryMultipoint":d="multipoint"}for(const s of o)s.geometry&&s.geometry instanceof a["a"]==0&&(s.geometry.type=d,void 0===s.geometry.spatialReference&&(s.geometry.spatialReference=u));const _={outFields:["*"],source:o,fields:c,types:i,typeIdField:n,objectIdField:r,spatialReference:t};_.geometryType=d||"point";const g=new f["default"](_);return new p({layer:g,spatialReference:t,isTable:null===d||""===d})}queryAttachments(){return Object(n["u"])([])}getFeatureByObjectId(e){const t=new d["a"];return t.where=this.objectIdField+"="+e.toString(),this._layer.queryFeatures(t).then(e=>1===e.features.length?e.features[0]:null)}getOwningSystemUrl(){return Object(n["u"])("")}getIdentityUser(){return Object(n["u"])("")}}t["a"]=p},"4f73":function(e,t,r){"use strict";var n=r("f4cc"),a=r("5996"),i=r("853c"),s=r("bb51"),l=class{constructor(e,t){this._lastId=-1,this._progress=t,this._parent=e}reset(){this._lastId=-1}nextBatch(e){if(null!==this._parent._mainSetInUse)return this._parent._mainSetInUse.then(t=>this.nextBatch(e),t=>this.nextBatch(e));const t={returnpromise:null,hasset:!1},r=[];return t.returnpromise=Object(n["c"])((n,a)=>{this._parent._getSet(this._progress).then(i=>{let s=i._known.length-1;if("GETPAGES"===i._known[i._known.length-1]&&(s-=1),this._lastId+e>s&&i._known.length>0&&"GETPAGES"===i._known[i._known.length-1])this._parent._expandPagedSet(i,this._parent._maxQueryRate(),0,0,this._progress).then(r=>{t.hasset=!0,this._parent._mainSetInUse=null,this.nextBatch(e).then(n,a)},e=>{t.hasset=!0,this._parent._mainSetInUse=null,a(e)});else{if(s>=this._lastId+e||0===i._candidates.length){for(let t=0;t<e;t++){const e=t+this._lastId+1;if(e>=i._known.length)break;r[t]=i._known[e]}return this._lastId+=r.length,0===r.length&&(t.hasset=!0,this._parent._mainSetInUse=null,n([])),void this._parent._getFeatureBatch(r,this._progress).then(e=>{t.hasset=!0,this._parent._mainSetInUse=null,n(e)},e=>{t.hasset=!0,this._parent._mainSetInUse=null,a(e)})}this._parent._refineSetBlock(i,this._parent._maxProcessingRate(),this._progress).then(()=>{t.hasset=!0,this._parent._mainSetInUse=null,this.nextBatch(e).then(n,a)},e=>{t.hasset=!0,this._parent._mainSetInUse=null,a(e)})}},e=>{t.hasset=!0,this._parent._mainSetInUse=null,a(e)})}),!1===t.hasset&&(this._parent._mainSetInUse=t.returnpromise,t.hasset=!0),t.returnpromise}next(){if(null!==this._parent._mainSetInUse)return this._parent._mainSetInUse.then(e=>this.next(),e=>this.next());const e={returnpromise:null,hasset:!1};return e.returnpromise=Object(n["c"])((t,r)=>{this._parent._getSet(this._progress).then(n=>{this._lastId<n._known.length-1?"GETPAGES"===n._known[this._lastId+1]?this._parent._expandPagedSet(n,this._parent._maxQueryRate(),0,0,this._progress).then(t=>(e.hasset=!0,this._parent._mainSetInUse=null,this.next())).then(t,r):(this._lastId+=1,this._parent._getFeature(n,n._known[this._lastId],this._progress).then(r=>{e.hasset=!0,this._parent._mainSetInUse=null,t(r)},t=>{e.hasset=!0,this._parent._mainSetInUse=null,r(t)})):n._candidates.length>0?this._parent._refineSetBlock(n,this._parent._maxProcessingRate(),this._progress).then(()=>{e.hasset=!0,this._parent._mainSetInUse=null,this.next().then(t,r)},t=>{e.hasset=!0,this._parent._mainSetInUse=null,r(t)}):(e.hasset=!0,this._parent._mainSetInUse=null,t(null))},t=>{e.hasset=!0,this._parent._mainSetInUse=null,r(t)})}),!1===e.hasset&&(this._parent._mainSetInUse=e.returnpromise,e.hasset=!0),e.returnpromise}count(){return-1!==this._parent._totalCount?Object(n["u"])(this._parent._totalCount):this._parent._getSet(this._progress).then(e=>this._refineAllSets(e)).then(e=>(this._parent._totalCount=e._known.length,Object(n["u"])(this._parent._totalCount)))}_refineAllSets(e){return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]?this._parent._expandPagedSet(e,this._parent._maxQueryRate(),0,1,this._progress).then(t=>this._refineAllSets(e)).then(e=>Object(n["u"])(e)):e._candidates.length>0?"GETPAGES"===e._known[e._candidates.length-1]?this._parent._expandPagedSet(e,this._parent._maxQueryRate(),0,2,this._progress).then(t=>this._refineAllSets(e)).then(e=>Object(n["u"])(e)):this._parent._refineSetBlock(e,this._parent._maxProcessingRate(),this._progress).then(e=>e._candidates.length>0?this._refineAllSets(e):Object(n["u"])(e)):Object(n["u"])(e)}},o=r("64fc"),u=r("1fbd"),c=r("66a2"),h=r("b1dc"),d=r("80b7");class f{constructor(e){this.recentlyUsedQueries=null,this._idstates=[],this._parent=null,this._wset=null,this._mainSetInUse=null,this._maxProcessing=200,this._maxQuery=500,this._totalCount=-1,this._databaseType=i["a"].NotEvaluated,this._databaseTypeProbed=null,this.declaredRootClass="esri.arcade.featureset.support.FeatureSet",this._featureCache=[],this.types=null,this.fields=null,this.geometryType="",this.objectIdField="",this.globalIdField="",this.spatialReference=null,this.hasM=!1,this.hasZ=!1,this._transparent=!1,this.loaded=!1,this._loadPromise=null,this._fieldsIndex=null,e&&e.lrucache&&(this.recentlyUsedQueries=e.lrucache)}optimisePagingFeatureQueries(e){this._parent&&this._parent.optimisePagingFeatureQueries(e)}_hasMemorySource(){return!0}prop(e,t){return void 0===t?this[e]:(void 0!==this[e]&&(this[e]=t),this)}end(){return null!==this._parent&&!0===this._parent._transparent?this._parent.end():this._parent}_ensureLoaded(){return this.load()}load(){return null===this._loadPromise&&(this._loadPromise=Object(n["c"])((e,t)=>{if(!0===this._parent.loaded)return this._initialiseFeatureSet(),void e(this);this._parent.load().then(()=>{try{this._initialiseFeatureSet(),e(this)}catch(e){t(e)}},t)})),this._loadPromise}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new a["a"]({wkid:4326}),this.geometryType=i["m"].point)}getField(e,t){let r;return(t=t||this.fields)&&(e=e.toLowerCase(),t.some(t=>(t&&t.name.toLowerCase()===e&&(r=t),!!r))),r}getFieldsIndex(){return null===this._fieldsIndex&&(this._fieldsIndex=new d["a"](this.fields)),this._fieldsIndex}_maxProcessingRate(){return null!==this._parent?Math.min(this._maxProcessing,this._parent._maxProcessingRate()):Math.min(this._maxProcessing,this._maxQueryRate())}_maxQueryRate(){return null!==this._parent?Math.max(this._maxQuery,this._parent._maxQueryRate()):this._maxQuery}_checkCancelled(e){if(null!==e&&e.aborted)throw new Error("Operation has been cancelled.")}nativeCapabilities(){return this._parent.nativeCapabilities()}_canDoAggregates(e,t,r,a,i){return null===this._parent?Object(n["u"])(!1):this._parent._canDoAggregates(e,t,r,a,i)}_getAggregatePagesDataSourceDefinition(e,t,r,a,i,s,l){return null===this._parent?Object(n["t"])(new Error("Should never be called")):this._parent._getAggregatePagesDataSourceDefinition(e,t,r,a,i,s,l)}_getAgregagtePhysicalPage(e,t,r){return null===this._parent?Object(n["t"])(new Error("Should never be called")):this._parent._getAgregagtePhysicalPage(e,t,r)}databaseType(){if(this._databaseType===i["a"].NotEvaluated){if(null!==u["a"].applicationCache){const e=u["a"].applicationCache.getDatabaseType(this._cacheableFeatureSetSourceKey());if(null!==e)return e}if(null!==this._databaseTypeProbed)return this._databaseTypeProbed;const e=[{thetype:i["a"].SqlServer,testwhere:"(CAST( '2015-01-01' as DATETIME) = CAST( '2015-01-01' as DATETIME)) AND OBJECTID<0"},{thetype:i["a"].Oracle,testwhere:"(TO_DATE('2003-11-18','YYYY-MM-DD') = TO_DATE('2003-11-18','YYYY-MM-DD')) AND OBJECTID<0"},{thetype:i["a"].StandardisedNoInterval,testwhere:"(date '2015-01-01 10:10:10' = date '2015-01-01 10:10:10') AND OBJECTID<0"}];let t=Object(n["c"])((t,r)=>{this._getDatabaseTypeImpl(e,0).then(e=>{this._databaseType=e,t(this._databaseType)},e=>{r(e)})});return null!==u["a"].applicationCache&&(u["a"].applicationCache.setDatabaseType(this._cacheableFeatureSetSourceKey(),t),t=t.catch(e=>{throw u["a"].applicationCache.clearDatabaseType(this._cacheableFeatureSetSourceKey()),e})),this._databaseTypeProbed=t,this._databaseTypeProbed}return Object(n["u"])(this._databaseType)}_cacheableFeatureSetSourceKey(){return"MUSTBESET"}_getDatabaseTypeImpl(e,t){return t>=e.length?Object(n["u"])(i["a"].StandardisedNoInterval):this._runDatabaseProbe(e[t].testwhere).then(r=>!0===r?e[t].thetype:this._getDatabaseTypeImpl(e,t+1))}_runDatabaseProbe(e){return null!==this._parent?this._parent._runDatabaseProbe(e):Object(n["t"])(new Error("Not Implemented"))}isTable(){return this._parent.isTable()}_featureFromCache(e){if(void 0!==this._featureCache[e])return this._featureCache[e]}_isInFeatureSet(e){return i["b"].Unknown}_getSet(e){throw new Error("Not implemented in abstract class")}_getFeature(e,t,r){try{return this._checkCancelled(r),void 0!==this._featureFromCache(t)?Object(n["u"])(this._featureFromCache(t)):this._getFeatures(e,t,this._maxProcessingRate(),r).then(()=>(this._checkCancelled(r),void 0!==this._featureFromCache(t)?this._featureFromCache(t):Object(n["t"])(new Error("Feature Not Found"))))}catch(e){return Object(n["t"])(e)}}_getFeatureBatch(e,t){try{this._checkCancelled(t);const r=new o["a"]([],e,!1,null),n=[];return this._getFeatures(r,-1,e.length,t).then(()=>{this._checkCancelled(t);for(const t of e)void 0!==this._featureFromCache(t)&&n.push(this._featureFromCache(t));return n})}catch(e){return Object(n["t"])(e)}}_getFeatures(e,t,r,a){return Object(n["u"])("success")}_getFilteredSet(e,t,r,n,a){throw new Error("Not implemented in abstract class")}_refineSetBlock(e,t,r){try{if(!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQueryRate()))return this._expandPagedSet(e,this._maxQueryRate(),0,0,r).then(()=>this._refineSetBlock(e,t,r));this._checkCancelled(r);const a=e._candidates.length;this._refineKnowns(e,t);let i=a-e._candidates.length;return 0===e._candidates.length||i>=t?Object(n["u"])(e):this._refineIfParentKnown(e,t-i,r).then(()=>{if(this._checkCancelled(r),this._refineKnowns(e,t-i),i=a-e._candidates.length,i<t&&e._candidates.length>0){const n=t-i,a=this._prepareFetchAndRefineSet(e._candidates);return this._fetchAndRefineFeatures(a,a.length>n?n:e._candidates.length,r).then(()=>(this._checkCancelled(r),this._refineKnowns(e,t-i),e))}return e})}catch(e){return Object(n["t"])(e)}}_fetchAndRefineFeatures(e,t,r){return null}_prepareFetchAndRefineSet(e){const t=[];for(let r=0;r<e.length;r++)this._isPhysicalFeature(e[r])&&t.push(e[r]);return t}_isPhysicalFeature(e){return null===this._parent||this._parent._isPhysicalFeature(e)}_refineKnowns(e,t){let r=0,n=null;const a=[];t=this._maxQueryRate();for(let s=0;s<e._candidates.length&&"GETPAGES"!==e._candidates[s];s++){let l=!1;const o=this._candidateIdTransform(e._candidates[s]);o!==e._candidates[s]&&(l=!0);const u=this._isInFeatureSet(o);if(u===i["b"].InFeatureSet)!0===l?e._known.indexOf(o)<0&&(e._known.push(o),r+=1):(e._known.push(e._candidates[s]),r+=1),null===n?n={start:s,end:s}:n.end===s-1?n.end=s:(a.push(n),n={start:s,end:s});else if(u===i["b"].NotInFeatureSet)null===n?n={start:s,end:s}:n.end===s-1?n.end=s:(a.push(n),n={start:s,end:s}),r+=1;else if(u===i["b"].Unknown&&(r+=1,!0===e._ordered))break;if(r>=t)break}null!==n&&a.push(n);for(let i=a.length-1;i>=0;i--)e._candidates.splice(a[i].start,a[i].end-a[i].start+1)}_refineIfParentKnown(e,t,r){const n=new o["a"]([],[],e._ordered,null);return n._candidates=e._candidates.slice(0),this._parent._refineSetBlock(n,t,r)}_candidateIdTransform(e){return this._parent._candidateIdTransform(e)}_checkIfNeedToExpandKnownPage(e,t){if(null===e.pagesDefinition)return!1;let r=0;for(let n=e._lastFetchedIndex;n<e._known.length;n++){if("GETPAGES"===e._known[n])return!0;if(void 0===this._featureCache[e._known[n]]&&(r+=1,r>=t))break}return!1}_checkIfNeedToExpandCandidatePage(e,t){if(null===e.pagesDefinition)return!1;let r=0;for(let n=0;n<e._candidates.length;n++){if("GETPAGES"===e._candidates[n])return!0;if(r+=1,r>=t)break}return!1}_expandPagedSet(e,t,r,a,i){return null===this._parent?Object(n["t"])(new Error("Parent Paging not implemented")):this._parent._expandPagedSet(e,t,r,a,i)}_expandPagedSetFeatureSet(e,t,r,a,i){return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]&&(a=1),0===a&&e._candidates.length>0&&"GETPAGES"===e._candidates[e._candidates.length-1]&&(a=2),0===a?Object(n["u"])("finished"):this._getPage(e,a,i).then(n=>r+n<t?this._expandPagedSet(e,t,r+n,0,i):"success")}_getPage(e,t,r){const a=1===t?e._known:e._candidates;if(e.pagesDefinition.internal.set.length>e.pagesDefinition.resultOffset||!0===e.pagesDefinition.internal.fullyResolved){a.length=a.length-1;let t=0;for(let n=0;n<e.pagesDefinition.resultRecordCount&&!(e.pagesDefinition.resultOffset+n>=e.pagesDefinition.internal.set.length);n++)a[a.length]=e.pagesDefinition.internal.set[e.pagesDefinition.resultOffset+n],t++;e.pagesDefinition.resultOffset+=t;let r=!1;return!0===e.pagesDefinition.internal.fullyResolved&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset&&(r=!0),!1===r&&a.push("GETPAGES"),Object(n["u"])(t)}return this._getPhysicalPage(e,t,r).then(()=>this._getPage(e,t,r))}_getPhysicalPage(e,t,r){return null}_clonePageDefinition(e){return null===this._parent?null:this._parent._clonePageDefinition(e)}_first(e){return this.iterator(e).next()}first(e){return this._first(e)}calculateStatistic(e,t,r,n){return this._ensureLoaded().then(()=>this._stat(e,t,"",null,null,r,n).then(a=>!1===a.calculated?this._manualStat(e,t,r,n).then(e=>e.result):a.result))}_manualStat(e,t,r,a){switch(e.toLowerCase()){case"count":return Object(h["b"])(this,a).then(e=>({calculated:!0,result:e}));case"distinct":return Object(h["d"])(this,t,r).then(e=>({calculated:!0,result:e}));case"avg":case"mean":return Object(h["f"])(this,t,a).then(e=>({calculated:!0,result:e}));case"stdev":return Object(h["h"])(this,t,a).then(e=>({calculated:!0,result:e}));case"variance":return Object(h["j"])(this,t,a).then(e=>({calculated:!0,result:e}));case"sum":return Object(h["i"])(this,t,a).then(e=>({calculated:!0,result:e}));case"min":return Object(h["g"])(this,t,a).then(e=>({calculated:!0,result:e}));case"max":return Object(h["e"])(this,t,a).then(e=>({calculated:!0,result:e}));default:return Object(n["u"])({calculated:!0,result:0})}}_stat(e,t,r,n,a,i,s){return this._parent._stat(e,t,r,n,a,i,s).then(l=>!1===l.calculated?null===a&&""===r&&null===n?this._manualStat(e,t,i,s):{calculated:!1}:l)}_unionAllGeomSelf(e){const t=this.iterator(this._defaultTracker(e)),r=[];return Object(n["c"])((e,n)=>{this._unionShapeInBatches(r,t,e,n)})}_unionAllGeom(e){return Object(n["c"])((t,r)=>{const n=this.iterator(this._defaultTracker(e));this._unionShapeInBatches([],n,t,r)})}_unionShapeInBatches(e,t,r,n){t.next().then(a=>{try{null!==a&&null!==a.geometry&&e.push(a.geometry),e.length>30||null===a&&e.length>1?Object(s["B"])(e).then(i=>{try{null===a?r(i):(e=[i],this._unionShapeInBatches(e,t,r,n))}catch(e){n(e)}},n):null===a?1===e.length?r(e[0]):r(null):this._unionShapeInBatches(e,t,r,n)}catch(e){n(e)}},n)}iterator(e){return new l(this,e)}intersection(e,t=!1){return f._featuresetFunctions.intersection.bind(this)(e,t)}difference(e,t=!1,r=!0){return f._featuresetFunctions.difference.bind(this)(e,t,r)}symmetricDifference(e,t=!1,r=!0){return f._featuresetFunctions.symmetricDifference.bind(this)(e,t,r)}morphShape(e,t,r="unknown",n=null){return f._featuresetFunctions.morphShape.bind(this)(e,t,r,n)}morphShapeAndAttributes(e,t,r="unknown"){return f._featuresetFunctions.morphShapeAndAttributes.bind(this)(e,t,r)}union(e,t=!1){return f._featuresetFunctions.union.bind(this)(e,t)}intersects(e){return f._featuresetFunctions.intersects.bind(this)(e)}envelopeIntersects(e){return f._featuresetFunctions.envelopeIntersects.bind(this)(e)}contains(e){return f._featuresetFunctions.contains.bind(this)(e)}overlaps(e){return f._featuresetFunctions.overlaps.bind(this)(e)}relate(e,t){return f._featuresetFunctions.relate.bind(this)(e,t)}within(e){return f._featuresetFunctions.within.bind(this)(e)}touches(e){return f._featuresetFunctions.touches.bind(this)(e)}top(e){return f._featuresetFunctions.top.bind(this)(e)}crosses(e){return f._featuresetFunctions.crosses.bind(this)(e)}buffer(e,t,r,n=!0){return f._featuresetFunctions.buffer.bind(this)(e,t,r,n)}filter(e,t=null){return f._featuresetFunctions.filter.bind(this)(e,t)}orderBy(e){return f._featuresetFunctions.orderBy.bind(this)(e)}dissolve(e,t){return f._featuresetFunctions.dissolve.bind(this)(e,t)}groupby(e,t){return f._featuresetFunctions.groupby.bind(this)(e,t)}reduce(e,t=null,r){return Object(n["c"])((n,a)=>{this._reduceImpl(this.iterator(this._defaultTracker(r)),e,t,0,n,a,0)})}_reduceImpl(e,t,r,a,i,s,l){try{if(++l>1e3)return void setTimeout(()=>{l=0,this._reduceImpl(e,t,r,a,i,s,l)});e.next().then(o=>{try{if(null===o)i(r);else{const u=t(r,o,a,this);Object(n["p"])(u)?u.then(r=>{this._reduceImpl(e,t,r,a+1,i,s,l)},s):this._reduceImpl(e,t,u,a+1,i,s,l)}}catch(e){s(e)}},s)}catch(e){s(e)}}removeField(e){return f._featuresetFunctions.removeField.bind(this)(e)}addField(e,t,r=null){return f._featuresetFunctions.addField.bind(this)(e,t,r)}sumArea(e,t=!1,r){const n=Object(i["e"])(e);return this.reduce((e,r)=>null===r.geometry?0:t?Object(s["l"])(r.geometry,n).then(t=>e+t):Object(s["u"])(r.geometry,n).then(t=>e+t),0,r)}sumLength(e,t=!1,r){const n=Object(i["d"])(e);return this.reduce((e,r)=>null===r.geometry?0:t?Object(s["o"])(r.geometry,n).then(t=>e+t):Object(s["v"])(r.geometry,n).then(t=>e+t),0,r)}_substituteVars(e,t){if(null!==t){const r={};for(const e in t)r[e.toLowerCase()]=t[e];e.parameters=r}}distinct(e,t=1e3,r=null,n){return this.load().then(()=>{const a=c["WhereClause"].create(e,this.getFieldsIndex());return this._substituteVars(a,r),this.calculateStatistic("distinct",a,t,this._defaultTracker(n))})}min(e,t=null,r){return this.load().then(()=>{const n=c["WhereClause"].create(e,this.getFieldsIndex());return this._substituteVars(n,t),this.calculateStatistic("min",n,-1,this._defaultTracker(r))})}max(e,t=null,r){return this.load().then(()=>{const n=c["WhereClause"].create(e,this.getFieldsIndex());return this._substituteVars(n,t),this.calculateStatistic("max",n,-1,this._defaultTracker(r))})}avg(e,t=null,r){return this.load().then(()=>{const n=c["WhereClause"].create(e,this.getFieldsIndex());return this._substituteVars(n,t),this.calculateStatistic("avg",n,-1,this._defaultTracker(r))})}sum(e,t=null,r){return this.load().then(()=>{const n=c["WhereClause"].create(e,this.getFieldsIndex());return this._substituteVars(n,t),this.calculateStatistic("sum",n,-1,this._defaultTracker(r))})}stdev(e,t=null,r){return this.load().then(()=>{const n=c["WhereClause"].create(e,this.getFieldsIndex());return this._substituteVars(n,t),this.calculateStatistic("stdev",n,-1,this._defaultTracker(r))})}variance(e,t=null,r){return this.load().then(()=>{const n=c["WhereClause"].create(e,this.getFieldsIndex());return this._substituteVars(n,t),this.calculateStatistic("variance",n,-1,this._defaultTracker(r))})}count(e){return this.load().then(()=>this.calculateStatistic("count",c["WhereClause"].create("1",this.getFieldsIndex()),-1,this._defaultTracker(e)))}_defaultTracker(e){return e||{aborted:!1}}forEach(e,t){return Object(n["c"])((r,n)=>{this._forEachImpl(this.iterator(this._defaultTracker(t)),e,this,r,n,0)})}_forEachImpl(e,t,r,a,i,s){try{if(++s>1e3)return void setTimeout(()=>{s=0,this._forEachImpl(e,t,r,a,i,s)},0);e.next().then(l=>{try{if(null===l)a(r);else{const o=t(l);null==o?this._forEachImpl(e,t,r,a,i,s):Object(n["p"])(o)?o.then(()=>{try{this._forEachImpl(e,t,r,a,i,s)}catch(e){i(e)}},i):this._forEachImpl(e,t,r,a,i,s)}}catch(e){i(e)}},i)}catch(e){i(e)}}convertToJSON(e){const t={layerDefinition:{geometryType:this.geometryType,fields:[]},featureSet:{features:[],geometryType:this.geometryType}};for(let r=0;r<this.fields.length;r++)t.layerDefinition.fields.push(Object(i["h"])(this.fields[r]));return this.reduce((e,r)=>{const n={geometry:r.geometry&&r.geometry.toJSON(),attributes:{}};for(const t in r.attributes)n.attributes[t]=r.attributes[t];return t.featureSet.features.push(n),1},0,e).then(()=>t)}castToText(){return"object, FeatureSet"}queryAttachments(e,t,r,n){return this._parent.queryAttachments(e,t,r,n)}serviceUrl(){return this._parent.serviceUrl()}subtypes(){return this.typeIdField?{subtypeField:this.typeIdField,subtypes:this.types?this.types.map(e=>({name:e.name,code:e.id})):[]}:null}relationshipMetaData(){return this._parent.relationshipMetaData()}get gdbVersion(){return this._parent?this._parent.gdbVersion:""}schema(){const e=[];for(const t of this.fields)e.push(Object(i["h"])(t));return{objectIdField:this.objectIdField,globalIdField:this.globalIdField,geometryType:void 0===i["n"][this.geometryType]?"":i["n"][this.geometryType],fields:e}}convertToText(e,t){return"schema"===e?this._ensureLoaded().then(()=>JSON.stringify(this.schema())):"featureset"===e?this._ensureLoaded().then(()=>{const e=[];return this.reduce((t,r)=>{const n={geometry:r.geometry?r.geometry.toJSON():null,attributes:r.attributes};return null!==n.geometry&&n.geometry.spatialReference&&delete n.geometry.spatialReference,e.push(n),1},0,t).then(()=>{const t=this.schema();return t.features=e,t.spatialReference=this.spatialReference.toJSON(),JSON.stringify(t)})}):Object(n["u"])(this.castToText())}getFeatureByObjectId(e,t){return this._parent.getFeatureByObjectId(e,t)}getOwningSystemUrl(){return this._parent.getOwningSystemUrl()}getIdentityUser(){return this._parent.getIdentityUser()}}f._featuresetFunctions={};t["a"]=f},"5db9":function(e,t,r){"use strict";var n=r("f4cc"),a=r("89da"),i=r("64fc"),s=r("4f73"),l=r("96af");class o extends s["a"]{constructor(e){super(e),this._orderbyclause=null,this.declaredClass="esri.arcade.featureset.actions.OrderBy",this._maxProcessing=100,this._orderbyclause=e.orderbyclause,this._parent=e.parentfeatureset}_getSet(e){return null===this._wset?this._ensureLoaded().then(()=>this._getFilteredSet("",null,null,this._orderbyclause,e)).then(t=>(this._checkCancelled(e),this._wset=t,this._wset)):Object(n["u"])(this._wset)}manualOrderSet(e,t){return this.getIdColumnDictionary(e,[],-1,t).then(e=>{this._orderbyclause.order(e);const t=new i["a"]([],[],!0,null);for(let r=0;r<e.length;r++)t._known.push(e[r].id);return t})}getIdColumnDictionary(e,t,r,i){if(r<e._known.length-1){const n=this._maxQueryRate();if("GETPAGES"===e._known[r+1])return Object(a["q"])(this._parent._expandPagedSet(e,n,0,0,i)).then(()=>this.getIdColumnDictionary(e,t,r,i));let s=r+1;const l=[];for(;s<e._known.length&&"GETPAGES"!==e._known[s];)l.push(e._known[s]),s++;return r+=l.length,Object(a["q"])(this._parent._getFeatureBatch(l,i)).then(n=>{this._checkCancelled(i);for(const e of n)t.push({id:e.attributes[this.objectIdField],feature:e});return this.getIdColumnDictionary(e,t,r,i)})}return e._candidates.length>0?Object(a["q"])(this._refineSetBlock(e,this._maxProcessingRate(),i)).then(()=>(this._checkCancelled(i),this.getIdColumnDictionary(e,t,r,i))):Object(n["u"])(t)}_isInFeatureSet(e){return this._parent._isInFeatureSet(e)}_getFeatures(e,t,r,n){return this._parent._getFeatures(e,t,r,n)}_featureFromCache(e){if(void 0===this._featureCache[e]){const t=this._parent._featureFromCache(e);if(void 0===t)return;return null===t?null:(this._featureCache[e]=t,t)}return this._featureCache[e]}_fetchAndRefineFeatures(){return Object(n["t"])(new Error("Fetch and Refine should not be called in this featureset"))}_getFilteredSet(e,t,r,n,a){return this._ensureLoaded().then(()=>this._parent._getFilteredSet(e,t,r,null===n?this._orderbyclause:n,a)).then(e=>{let n;this._checkCancelled(a),n=new i["a"](e._candidates.slice(0),e._known.slice(0),e._ordered,this._clonePageDefinition(e.pagesDefinition));let s=!0;return e._candidates.length>0&&(s=!1),!1===n._ordered?this.manualOrderSet(n,a).then(e=>(!1===s&&(null===t&&null===r||(e=new i["a"](e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,this._clonePageDefinition(e.pagesDefinition)))),e)):n})}static registerAction(){s["a"]._featuresetFunctions.orderBy=function(e){return""===e?this:new o({parentfeatureset:this,orderbyclause:new l["a"](e)})}}}t["a"]=o},"5f6c":function(e,t,r){"use strict";(function(e){r.d(t,"a",(function(){return i})),r.d(t,"b",(function(){return a})),r.d(t,"c",(function(){return n}));"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof e||"undefined"!=typeof self&&self;function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function a(e,t,r){return e(r={path:t,exports:{},require:function(e,t){return i(null==t&&r.path)}},r.exports),r.exports}function i(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}}).call(this,r("c8ba"))},"60fd":function(e,t,r){"use strict";var n=r("f4cc"),a=r("853c"),i=r("64fc"),s=r("4f73");class l extends s["a"]{constructor(e){super(e),this._topnum=0,this.declaredClass="esri.arcade.featureset.actions.Top",this._countedin=0,this._maxProcessing=100,this._topnum=e.topnum,this._parent=e.parentfeatureset}_getSet(e){return null===this._wset?this._ensureLoaded().then(()=>this._parent._getSet(e)).then(e=>(this._wset=new i["a"](e._candidates.slice(0),e._known.slice(0),!1,this._clonePageDefinition(e.pagesDefinition)),this._setKnownLength(this._wset)>this._topnum&&(this._wset._known=this._wset._known.slice(0,this._topnum)),this._setKnownLength(this._wset)>=this._topnum&&(this._wset._candidates=[]),this._wset)):Object(n["u"])(this._wset)}_setKnownLength(e){return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]?e._known.length-1:e._known.length}_isInFeatureSet(e){const t=this._parent._isInFeatureSet(e);if(t===a["b"].NotInFeatureSet)return t;const r=this._idstates[e];return r===a["b"].InFeatureSet||r===a["b"].NotInFeatureSet?r:t===a["b"].InFeatureSet&&void 0===r?this._countedin<this._topnum?(this._idstates[e]=a["b"].InFeatureSet,this._countedin++,a["b"].InFeatureSet):(this._idstates[e]=a["b"].NotInFeatureSet,a["b"].NotInFeatureSet):a["b"].Unknown}_expandPagedSet(e,t,r,a,i){if(null===this._parent)return Object(n["t"])(new Error("Parent Paging not implemented"));if(t>this._topnum&&(t=this._topnum),this._countedin>=this._topnum&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset){let t=e._known.length;return t>0&&"GETPAGES"===e._known[t-1]&&(e._known.length=t-1),t=e._candidates.length,t>0&&"GETPAGES"===e._candidates[t-1]&&(e._candidates.length=t-1),Object(n["u"])("success")}return this._parent._expandPagedSet(e,t,r,a,i).then(t=>(this._setKnownLength(e)>this._topnum&&(e._known.length=this._topnum),this._setKnownLength(e)>=this._topnum&&(e._candidates.length=0),t))}_getFeatures(e,t,r,a){const s=[],l=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,l))return this._expandPagedSet(e,l,0,0,a).then(()=>this._getFeatures(e,t,r,a));-1!==t&&void 0===this._featureCache[t]&&s.push(t);let o=0;for(let n=e._lastFetchedIndex;n<e._known.length&&(o++,o<=r&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[n]]&&(e._known[n]!==t&&s.push(e._known[n]),s.length>l-1)));n++);if(0===s.length)return Object(n["u"])("success");const u=new i["a"]([],s,!1,null),c=Math.min(s.length,r);return this._parent._getFeatures(u,-1,c,a).then(()=>{for(let e=0;e<c;e++){const t=this._parent._featureFromCache(s[e]);void 0!==t&&(this._featureCache[s[e]]=t)}return"success"})}_getFilteredSet(e,t,r,n,a){return this._ensureLoaded().then(()=>this._getSet(a)).then(e=>new i["a"](e._candidates.slice(0).concat(e._known.slice(0)),[],!1,this._clonePageDefinition(e.pagesDefinition)))}_refineKnowns(e,t){let r=0,n=null;const i=[];for(let s=0;s<e._candidates.length;s++){const l=this._isInFeatureSet(e._candidates[s]);if(l===a["b"].InFeatureSet){if(e._known.push(e._candidates[s]),r+=1,null===n?n={start:s,end:s}:n.end===s-1?n.end=s:(i.push(n),n={start:s,end:s}),e._known.length>=this._topnum)break}else if(l===a["b"].NotInFeatureSet)null===n?n={start:s,end:s}:n.end===s-1?n.end=s:(i.push(n),n={start:s,end:s}),r+=1;else if(l===a["b"].Unknown)break;if(r>=t)break}null!==n&&i.push(n);for(let a=i.length-1;a>=0;a--)e._candidates.splice(i[a].start,i[a].end-i[a].start+1);this._setKnownLength(e)>this._topnum&&(e._known=e._known.slice(0,this._topnum)),this._setKnownLength(e)>=this._topnum&&(e._candidates=[])}_stat(){return Object(n["u"])({calculated:!1})}_canDoAggregates(){return Object(n["u"])(!1)}static registerAction(){s["a"]._featuresetFunctions.top=function(e){return new l({parentfeatureset:this,topnum:e})}}}t["a"]=l},"64fc":function(e,t,r){"use strict";t["a"]=class{constructor(e,t,r,n){this._candidates=null,this._known=null,this._lastFetchedIndex=0,this._ordered=!1,this.pagesDefinition=null,this._candidates=e,this._known=t,this._ordered=r,this.pagesDefinition=n}}},"66a2":function(e,t,r){"use strict";r.r(t),r.d(t,"WhereClause",(function(){return I})),r.d(t,"defaultAttributeAdapter",(function(){return B}));var n=r("c120");function a(e,t){const r=s[e.toLowerCase()];if(null==r)throw new Error("Function Not Recognised");if(t.length<r.minParams||t.length>r.maxParams)throw new Error("Invalid Parameter count for call to "+e.toUpperCase());return r.evaluate(t)}function i(e,t){const r=s[e.toLowerCase()];return null!=r&&t>=r.minParams&&t<=r.maxParams}const s={min:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.min.apply(Math,e[0])},max:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.max.apply(Math,e[0])},avg:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:l(e[0])},sum:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:function(e){let t=0;for(let r=0;r<e.length;r++)t+=e[r];return t}(e[0])},stddev:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.sqrt(o(e[0]))},count:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:e[0].length},var:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:o(e[0])}};function l(e){let t=0;for(let r=0;r<e.length;r++)t+=e[r];return t/e.length}function o(e){const t=l(e),r=e.length;let n=0;for(const a of e)n+=Math.pow(a-t,2);return r>1?n/(r-1):0}var u=r("b3b6");class c{constructor(){this.op="+",this.day=0,this.second=0,this.hour=0,this.month=0,this.year=0,this.minute=0}static fixDefaults(e){if(null!==e.precision||null!==e.secondary)throw new Error("Primary and Secondary SqlInterval qualifiers not supported")}static createFromMilliseconds(e){const t=new c;return t.second=e/1e3,t}static createFromValueAndQualifer(e,t,r){let n=null;const a=new c;if(a.op="-"===r?"-":"+","interval-period"===t.type){c.fixDefaults(t);const r=new RegExp("^[0-9]{1,}$");if("year"===t.period||"month"===t.period)throw new Error("Year-Month Intervals not supported");if(!r.test(e))throw new Error("Illegal Interval");a[t.period]=parseFloat(e)}else{if(c.fixDefaults(t.start),c.fixDefaults(t.end),"year"===t.start.period||"month"===t.start.period)throw new Error("Year-Month Intervals not supported");if("year"===t.end.period||"month"===t.end.period)throw new Error("Year-Month Intervals not supported");switch(t.start.period){case"day":switch(t.end.period){case"hour":if(n=new RegExp("^[0-9]{1,} [0-9]{1,}$"),!n.test(e))throw new Error("Illegal Interval");a[t.start.period]=parseFloat(e.split(" ")[0]),a[t.end.period]=parseFloat(e.split(" ")[1]);break;case"minute":if(n=new RegExp("^[0-9]{1,} [0-9]{1,2}:[0-9]{1,}$"),!n.test(e))throw new Error("Illegal Interval");{a[t.start.period]=parseFloat(e.split(" ")[0]);const r=e.split(" ")[1].split(":");a.hour=parseFloat(r[0]),a.minute=parseFloat(r[1])}break;case"second":if(n=new RegExp("^[0-9]{1,} [0-9]{1,2}:[0-9]{1,2}:[0-9]{1,}([.]{1}[0-9]{1,}){0,1}$"),!n.test(e))throw new Error("Illegal Interval");{a[t.start.period]=parseFloat(e.split(" ")[0]);const r=e.split(" ")[1].split(":");a.hour=parseFloat(r[0]),a.minute=parseFloat(r[1]),a.second=parseFloat(r[2])}break;default:throw"Invalid Interval."}break;case"hour":switch(t.end.period){case"minute":if(n=new RegExp("^[0-9]{1,}:[0-9]{1,}$"),!n.test(e))throw new Error("Illegal Interval");a.hour=parseFloat(e.split(":")[0]),a.minute=parseFloat(e.split(":")[1]);break;case"second":if(n=new RegExp("^[0-9]{1,}:[0-9]{1,2}:[0-9]{1,}([.]{1}[0-9]{1,}){0,1}$"),!n.test(e))throw new Error("Illegal Interval");{const t=e.split(":");a.hour=parseFloat(t[0]),a.minute=parseFloat(t[1]),a.second=parseFloat(t[2])}break;default:throw"Invalid Interval."}break;case"minute":switch(t.end.period){case"second":if(n=new RegExp("^[0-9]{1,}:[0-9]{1,}([.]{1}[0-9]{1,}){0,1}$"),!n.test(e))throw new Error("Illegal Interval");{const t=e.split(":");a.minute=parseFloat(t[0]),a.second=parseFloat(t[1])}break;default:throw"Invalid Interval."}break;default:throw"Invalid Interval."}}return a}valueInMilliseconds(){return("-"===this.op?-1:1)*(1e3*this.second+60*this.minute*1e3+60*this.hour*60*1e3+24*this.day*60*60*1e3+this.month*(365/12)*24*60*60*1e3+365*this.year*24*60*60*1e3)}}function h(e,t){const r=f[e.toLowerCase()];if(null==r)throw new Error("Function Not Recognised");if(t.length<r.minParams||t.length>r.maxParams)throw new Error("Invalid Parameter count for call to "+e.toUpperCase());return r.evaluate(t)}function d(e,t){const r=f[e.toLowerCase()];return null!=r&&t>=r.minParams&&t<=r.maxParams}const f={extract:{minParams:2,maxParams:2,evaluate:([e,t])=>{if(null==t)return null;if(t instanceof Date)switch(e.toUpperCase()){case"SECOND":return t.getSeconds();case"MINUTE":return t.getMinutes();case"HOUR":return t.getHours();case"DAY":return t.getDate();case"MONTH":return t.getMonth()+1;case"YEAR":return t.getFullYear()}throw new Error("Invalid Parameter for call to EXTRACT")}},substring:{minParams:2,maxParams:3,evaluate:e=>{if(2===e.length){const[t,r]=e;return null==t||null==r?null:t.toString().substring(r-1)}if(3===e.length){const[t,r,n]=e;return null==t||null==r||null==n?null:n<=0?"":t.toString().substring(r-1,r+n-1)}}},position:{minParams:2,maxParams:2,evaluate:([e,t])=>null==e||null==t?null:t.indexOf(e)+1},trim:{minParams:2,maxParams:3,evaluate:e=>{const t=3===e.length,r=t?e[1]:" ",n=t?e[2]:e[1];if(null==r||null==n)return null;const a=`(${Object(u["a"])(r)})`;switch(e[0]){case"BOTH":return n.replace(new RegExp(`^${a}*|${a}*$`,"g"),"");case"LEADING":return n.replace(new RegExp(`^${a}*`,"g"),"");case"TRAILING":return n.replace(new RegExp(a+"*$","g"),"")}throw new Error("Invalid Parameter for call to TRIM")}},abs:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.abs(e[0])},ceiling:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.ceil(e[0])},floor:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.floor(e[0])},log:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.log(e[0])},log10:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.log(e[0])*Math.LOG10E},sin:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.sin(e[0])},cos:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.cos(e[0])},tan:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.tan(e[0])},asin:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.asin(e[0])},acos:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.acos(e[0])},atan:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.atan(e[0])},sign:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:e[0]>0?1:e[1]<0?-1:0},power:{minParams:2,maxParams:2,evaluate:e=>null==e[0]||null==e[1]?null:Math.pow(e[0],e[1])},mod:{minParams:2,maxParams:2,evaluate:e=>null==e[0]||null==e[1]?null:e[0]%e[1]},round:{minParams:1,maxParams:2,evaluate:e=>{const t=e[0],r=2===e.length?Math.pow(10,e[1]):1;return null==t?null:Math.round(t*r)/r}},truncate:{minParams:1,maxParams:2,evaluate:e=>null==e[0]?null:1===e.length?parseInt(e[0].toFixed(0),10):parseFloat(e[0].toFixed(e[1]))},char_length:{minParams:1,maxParams:1,evaluate:e=>"string"==typeof e[0]||e[0]instanceof String?e[0].length:0},concat:{minParams:1,maxParams:1/0,evaluate:e=>{let t="";for(let r=0;r<e.length;r++){if(null==e[r])return null;t+=e[r].toString()}return t}},lower:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:e[0].toString().toLowerCase()},upper:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:e[0].toString().toUpperCase()}};var p=r("5f6c"),_=Object(p["b"])((function(e){e.exports&&(e.exports=function(){function e(e,t){function r(){this.constructor=e}r.prototype=t.prototype,e.prototype=new r}function t(e,r,n,a){this.message=e,this.expected=r,this.found=n,this.location=a,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,t)}function r(e,r){r=void 0!==r?r:{};var n,a={},i={start:kn},s=kn,l=function(e){return e},o=function(e,t){var r={type:"expr_list"},n=ki(e,t);return r.value=n,r},u=function(e,t){return Li(e,t)},c="!",h=En("!",!1),d="=",f=En("=",!1),p=function(e){return Ai("NOT",e)},_=function(e,t){return""==t||null==t||null==t?e:"arithmetic"==t.type?Li(e,t.tail):Ri(t.op,e,t.right,t.escape)},g=function(e){return{type:"arithmetic",tail:e}},m=">=",y=En(">=",!1),b=">",w=En(">",!1),v="<=",S=En("<=",!1),F="<>",O=En("<>",!1),I="<",j=En("<",!1),T="!=",x=En("!=",!1),E=function(e,t){return{op:e+"NOT",right:t}},C=function(e,t){return{op:e,right:t}},D=function(e,t,r){return{op:"NOT"+e,right:{type:"expr_list",value:[t,r]}}},N=function(e,t,r){return{op:e,right:{type:"expr_list",value:[t,r]}}},A=function(e){return e[0]+" "+e[2]},R=function(e,t,r){return{op:e,right:t,escape:r.value}},P=function(e,t){return{op:e,right:t,escape:""}},k=function(e,t){return{op:e,right:t}},L=function(e){return{op:e,right:{type:"expr_list",value:[]}}},M=function(e,t){return{op:e,right:t}},G="+",B=En("+",!1),U="-",q=En("-",!1),V=function(e,t){return Li(e,t)},W="*",z=En("*",!1),J="/",$=En("/",!1),H=function(e){return e.paren=!0,e},Y=function(e){return/^CURRENT_DATE$/i.test(e)?{type:"current_time",mode:"date"}:/^CURRENT_TIMESTAMP$/i.test(e)?{type:"current_time",mode:"timestamp"}:{type:"column_ref",table:"",column:e}},Q=function(e){return e},K=function(e,t){return e+t.join("")},Z=/^[A-Za-z_\x80-\uFFFF]/,X=Cn([["A","Z"],["a","z"],"_",["","￿"]],!1,!1),ee=/^[A-Za-z0-9_]/,te=Cn([["A","Z"],["a","z"],["0","9"],"_"],!1,!1),re=/^[A-Za-z0-9_.\x80-\uFFFF]/,ne=Cn([["A","Z"],["a","z"],["0","9"],"_",".",["","￿"]],!1,!1),ae="@",ie=En("@",!1),se=function(e){return{type:"param",value:e[1]}},le=function(e,t){return{type:"function",name:"extract",args:{type:"expr_list",value:[{type:"string",value:e},t]}}},oe=function(e,t,r){return{type:"function",name:"substring",args:{type:"expr_list",value:r?[e,t,r[2]]:[e,t]}}},ue=function(e,t,r){return{type:"function",name:"trim",args:{type:"expr_list",value:[{type:"string",value:null==e?"BOTH":e},t,r]}}},ce=function(e,t){return{type:"function",name:"trim",args:{type:"expr_list",value:[{type:"string",value:null==e?"BOTH":e},t]}}},he=function(e,t){return{type:"function",name:"position",args:{type:"expr_list",value:[e,t]}}},de=function(e,t){return{type:"function",name:e,args:t||{type:"expr_list",value:[]}}},fe=function(e){return{type:"timestamp",value:e.value}},pe=function(e,t,r){return{type:"interval",value:t,qualifier:r,op:e}},_e=function(e,t){return{type:"interval",value:e,qualifier:t,op:""}},ge=function(e,t){return{type:"interval-qualifier",start:e,end:t}},me=function(e,t){return{type:"interval-period",period:e.value,precision:t,secondary:null}},ye=function(e){return{type:"interval-period",period:e.value,precision:null,secondary:null}},be=function(e){return{type:"interval-period",period:e.value,precision:null,secondary:null}},we=function(e,t){return{type:"interval-period",period:"second",precision:e,secondary:t}},ve=function(e){return{type:"interval-period",period:"second",precision:e,secondary:null}},Se=function(){return{type:"interval-period",period:"second",precision:null,secondary:null}},Fe=function(e,t){return{type:"interval-period",period:e.value,precision:t,secondary:null}},Oe=function(e){return{type:"interval-period",period:"second",precision:e,secondary:null}},Ie=function(){return{type:"interval-period",period:"second",precision:null,secondary:null}},je=function(){return{type:"string",value:"day"}},Te=function(){return{type:"string",value:"hour"}},xe=function(){return{type:"string",value:"minute"}},Ee=function(){return{type:"string",value:"month"}},Ce=function(){return{type:"string",value:"year"}},De=function(e){return parseFloat(e)},Ne=function(e){return{type:"date",value:e.value}},Ae=function(){return{type:"null",value:null}},Re=function(){return{type:"bool",value:!0}},Pe=function(){return{type:"bool",value:!1}},ke="'",Le=En("'",!1),Me="N'",Ge=En("N'",!1),Be="''",Ue=En("''",!1),qe=function(){return"'"},Ve=/^[^']/,We=Cn(["'"],!0,!1),ze=function(e){return{type:"string",value:e.join("")}},Je=function(e,t){return{type:"case_expression",format:"simple",operand:e,clauses:t,else:null}},$e=function(e,t,r){return{type:"case_expression",format:"simple",operand:e,clauses:t,else:r.value}},He=function(e){return{type:"case_expression",format:"searched",clauses:e,else:null}},Ye=function(e,t){return{type:"case_expression",format:"searched",clauses:e,else:t.value}},Qe=function(e,t){return{type:"when_clause",operand:e,value:t}},Ke=function(e){return{type:"else_clause",value:e}},Ze=function(e){return{type:"number",value:e}},Xe=function(e,t,r){return parseFloat(e+t+r)},et=function(e,t){return parseFloat(e+t)},tt=function(e,t){return parseFloat(e+t)},rt=function(e){return parseFloat(e)},nt=function(e,t){return e[0]+t},at=".",it=En(".",!1),st=function(e){return"."+(null!=e?e:"")},lt=function(e,t){return e+t},ot=function(e){return e.join("")},ut=/^[0-9]/,ct=Cn([["0","9"]],!1,!1),ht=/^[eE]/,dt=Cn(["e","E"],!1,!1),ft=/^[+\-]/,pt=Cn(["+","-"],!1,!1),_t=function(e,t){return"e"+(null===t?"":t)},gt="null",mt=En("NULL",!0),yt="true",bt=En("TRUE",!0),wt="false",vt=En("FALSE",!0),St="in",Ft=En("IN",!0),Ot=function(){return"IN"},It="is",jt=En("IS",!0),Tt=function(){return"IS"},xt="like",Et=En("LIKE",!0),Ct=function(){return"LIKE"},Dt="escape",Nt=En("ESCAPE",!0),At=function(){return"ESCAPE"},Rt="not",Pt=En("NOT",!0),kt=function(){return"NOT"},Lt="and",Mt=En("AND",!0),Gt=function(){return"AND"},Bt="or",Ut=En("OR",!0),qt=function(){return"OR"},Vt="between",Wt=En("BETWEEN",!0),zt=function(){return"BETWEEN"},Jt="from",$t=En("FROM",!0),Ht=function(){return"FROM"},Yt="for",Qt=En("FOR",!0),Kt=function(){return"FOR"},Zt="substring",Xt=En("SUBSTRING",!0),er=function(){return"SUBSTRING"},tr="extract",rr=En("EXTRACT",!0),nr=function(){return"EXTRACT"},ar="trim",ir=En("TRIM",!0),sr=function(){return"TRIM"},lr="position",or=En("POSITION",!0),ur=function(){return"POSITION"},cr="timestamp",hr=En("TIMESTAMP",!0),dr=function(){return"TIMESTAMP"},fr="date",pr=En("DATE",!0),_r=function(){return"DATE"},gr="leading",mr=En("LEADING",!0),yr=function(){return"LEADING"},br="trailing",wr=En("TRAILING",!0),vr=function(){return"TRAILING"},Sr="both",Fr=En("BOTH",!0),Or=function(){return"BOTH"},Ir="to",jr=En("TO",!0),Tr=function(){return"TO"},xr="interval",Er=En("INTERVAL",!0),Cr=function(){return"INTERVAL"},Dr="year",Nr=En("YEAR",!0),Ar=function(){return"YEAR"},Rr="month",Pr=En("MONTH",!0),kr=function(){return"MONTH"},Lr="day",Mr=En("DAY",!0),Gr=function(){return"DAY"},Br="hour",Ur=En("HOUR",!0),qr=function(){return"HOUR"},Vr="minute",Wr=En("MINUTE",!0),zr=function(){return"MINUTE"},Jr="second",$r=En("SECOND",!0),Hr=function(){return"SECOND"},Yr="case",Qr=En("CASE",!0),Kr=function(){return"CASE"},Zr="end",Xr=En("END",!0),en=function(){return"END"},tn="when",rn=En("WHEN",!0),nn=function(){return"WHEN"},an="then",sn=En("THEN",!0),ln=function(){return"THEN"},on="else",un=En("ELSE",!0),cn=function(){return"ELSE"},hn=",",dn=En(",",!1),fn="(",pn=En("(",!1),_n=")",gn=En(")",!1),mn=/^[ \t\n\r]/,yn=Cn([" ","\t","\n","\r"],!1,!1),bn="`",wn=En("`",!1),vn=/^[^`]/,Sn=Cn(["`"],!0,!1),Fn=function(e){return e.join("")},On=0,In=[{line:1,column:1}],jn=0,Tn=[],xn=0;if("startRule"in r){if(!(r.startRule in i))throw new Error("Can't start parsing from rule \""+r.startRule+'".');s=i[r.startRule]}function En(e,t){return{type:"literal",text:e,ignoreCase:t}}function Cn(e,t,r){return{type:"class",parts:e,inverted:t,ignoreCase:r}}function Dn(){return{type:"end"}}function Nn(t){var r,n=In[t];if(n)return n;for(r=t-1;!In[r];)r--;for(n={line:(n=In[r]).line,column:n.column};r<t;)10===e.charCodeAt(r)?(n.line++,n.column=1):n.column++,r++;return In[t]=n,n}function An(e,t){var r=Nn(e),n=Nn(t);return{start:{offset:e,line:r.line,column:r.column},end:{offset:t,line:n.line,column:n.column}}}function Rn(e){On<jn||(On>jn&&(jn=On,Tn=[]),Tn.push(e))}function Pn(e,r,n){return new t(t.buildMessage(e,r),e,r,n)}function kn(){var e,t;return e=On,Ci()!==a&&(t=Mn())!==a&&Ci()!==a?e=l(t):(On=e,e=a),e}function Ln(){var e,t,r,n,i,s,l,u;if(e=On,(t=Mn())!==a){for(r=[],n=On,(i=Ci())!==a&&(s=Ti())!==a&&(l=Ci())!==a&&(u=Mn())!==a?n=i=[i,s,l,u]:(On=n,n=a);n!==a;)r.push(n),n=On,(i=Ci())!==a&&(s=Ti())!==a&&(l=Ci())!==a&&(u=Mn())!==a?n=i=[i,s,l,u]:(On=n,n=a);r!==a?e=t=o(t,r):(On=e,e=a)}else On=e,e=a;return e}function Mn(){var e,t,r,n,i,s,l,o;if(e=On,(t=Gn())!==a){for(r=[],n=On,(i=Ci())!==a&&(s=ti())!==a&&(l=Ci())!==a&&(o=Gn())!==a?n=i=[i,s,l,o]:(On=n,n=a);n!==a;)r.push(n),n=On,(i=Ci())!==a&&(s=ti())!==a&&(l=Ci())!==a&&(o=Gn())!==a?n=i=[i,s,l,o]:(On=n,n=a);r!==a?e=t=u(t,r):(On=e,e=a)}else On=e,e=a;return e}function Gn(){var e,t,r,n,i,s,l,o;if(e=On,(t=Bn())!==a){for(r=[],n=On,(i=Ci())!==a&&(s=ei())!==a&&(l=Ci())!==a&&(o=Bn())!==a?n=i=[i,s,l,o]:(On=n,n=a);n!==a;)r.push(n),n=On,(i=Ci())!==a&&(s=ei())!==a&&(l=Ci())!==a&&(o=Bn())!==a?n=i=[i,s,l,o]:(On=n,n=a);r!==a?e=t=u(t,r):(On=e,e=a)}else On=e,e=a;return e}function Bn(){var t,r,n,i,s;return t=On,(r=Xa())===a&&(r=On,33===e.charCodeAt(On)?(n=c,On++):(n=a,0===xn&&Rn(h)),n!==a?(i=On,xn++,61===e.charCodeAt(On)?(s=d,On++):(s=a,0===xn&&Rn(f)),xn--,s===a?i=void 0:(On=i,i=a),i!==a?r=n=[n,i]:(On=r,r=a)):(On=r,r=a)),r!==a&&(n=Ci())!==a&&(i=Bn())!==a?t=r=p(i):(On=t,t=a),t===a&&(t=Un()),t}function Un(){var e,t,r;return e=On,(t=Kn())!==a&&Ci()!==a?((r=qn())===a&&(r=null),r!==a?e=t=_(t,r):(On=e,e=a)):(On=e,e=a),e}function qn(){var e;return(e=Vn())===a&&(e=Qn())===a&&(e=Jn())===a&&(e=zn())===a&&(e=Yn()),e}function Vn(){var e,t,r,n,i,s;if(e=[],t=On,(r=Ci())!==a&&(n=Wn())!==a&&(i=Ci())!==a&&(s=Kn())!==a?t=r=[r,n,i,s]:(On=t,t=a),t!==a)for(;t!==a;)e.push(t),t=On,(r=Ci())!==a&&(n=Wn())!==a&&(i=Ci())!==a&&(s=Kn())!==a?t=r=[r,n,i,s]:(On=t,t=a);else e=a;return e!==a&&(e=g(e)),e}function Wn(){var t;return e.substr(On,2)===m?(t=m,On+=2):(t=a,0===xn&&Rn(y)),t===a&&(62===e.charCodeAt(On)?(t=b,On++):(t=a,0===xn&&Rn(w)),t===a&&(e.substr(On,2)===v?(t=v,On+=2):(t=a,0===xn&&Rn(S)),t===a&&(e.substr(On,2)===F?(t=F,On+=2):(t=a,0===xn&&Rn(O)),t===a&&(60===e.charCodeAt(On)?(t=I,On++):(t=a,0===xn&&Rn(j)),t===a&&(61===e.charCodeAt(On)?(t=d,On++):(t=a,0===xn&&Rn(f)),t===a&&(e.substr(On,2)===T?(t=T,On+=2):(t=a,0===xn&&Rn(x)))))))),t}function zn(){var e,t,r,n;return e=On,(t=Qa())!==a&&Ci()!==a&&(r=Xa())!==a&&Ci()!==a&&(n=Kn())!==a?e=t=E(t,n):(On=e,e=a),e===a&&(e=On,(t=Qa())!==a&&Ci()!==a&&(r=Kn())!==a?e=t=C(t,r):(On=e,e=a)),e}function Jn(){var e,t,r,n,i,s;return e=On,(t=Xa())!==a&&Ci()!==a&&(r=ri())!==a&&Ci()!==a&&(n=Kn())!==a&&Ci()!==a&&(i=ei())!==a&&Ci()!==a&&(s=Kn())!==a?e=t=D(r,n,s):(On=e,e=a),e===a&&(e=On,(t=ri())!==a&&Ci()!==a&&(r=Kn())!==a&&Ci()!==a&&(n=ei())!==a&&Ci()!==a&&(i=Kn())!==a?e=t=N(t,r,i):(On=e,e=a)),e}function $n(){var e,t,r,n,i;return e=On,t=On,(r=Xa())!==a&&(n=Ci())!==a&&(i=Ka())!==a?t=r=[r,n,i]:(On=t,t=a),t!==a&&(t=A(t)),(e=t)===a&&(e=Ka()),e}function Hn(){var e,t,r,n,i;return e=On,t=On,(r=Xa())!==a&&(n=Ci())!==a&&(i=Ya())!==a?t=r=[r,n,i]:(On=t,t=a),t!==a&&(t=A(t)),(e=t)===a&&(e=Ya()),e}function Yn(){var e,t,r,n;return e=On,(t=$n())!==a&&Ci()!==a&&(r=Ca())!==a&&Ci()!==a&&Za()!==a&&Ci()!==a&&(n=Da())!==a?e=t=R(t,r,n):(On=e,e=a),e===a&&(e=On,(t=$n())!==a&&Ci()!==a&&(r=Ca())!==a?e=t=P(t,r):(On=e,e=a)),e}function Qn(){var e,t,r,n;return e=On,(t=Hn())!==a&&Ci()!==a&&(r=xi())!==a&&Ci()!==a&&(n=Ln())!==a&&Ci()!==a&&Ei()!==a?e=t=k(t,n):(On=e,e=a),e===a&&(e=On,(t=Hn())!==a&&Ci()!==a&&(r=xi())!==a&&Ci()!==a&&(n=Ei())!==a?e=t=L(t):(On=e,e=a),e===a&&(e=On,(t=Hn())!==a&&Ci()!==a&&(r=ua())!==a?e=t=M(t,r):(On=e,e=a))),e}function Kn(){var e,t,r,n,i,s,l,o;if(e=On,(t=Xn())!==a){for(r=[],n=On,(i=Ci())!==a&&(s=Zn())!==a&&(l=Ci())!==a&&(o=Xn())!==a?n=i=[i,s,l,o]:(On=n,n=a);n!==a;)r.push(n),n=On,(i=Ci())!==a&&(s=Zn())!==a&&(l=Ci())!==a&&(o=Xn())!==a?n=i=[i,s,l,o]:(On=n,n=a);r!==a?e=t=u(t,r):(On=e,e=a)}else On=e,e=a;return e}function Zn(){var t;return 43===e.charCodeAt(On)?(t=G,On++):(t=a,0===xn&&Rn(B)),t===a&&(45===e.charCodeAt(On)?(t=U,On++):(t=a,0===xn&&Rn(q))),t}function Xn(){var e,t,r,n,i,s,l,o;if(e=On,(t=ta())!==a){for(r=[],n=On,(i=Ci())!==a&&(s=ea())!==a&&(l=Ci())!==a&&(o=ta())!==a?n=i=[i,s,l,o]:(On=n,n=a);n!==a;)r.push(n),n=On,(i=Ci())!==a&&(s=ea())!==a&&(l=Ci())!==a&&(o=ta())!==a?n=i=[i,s,l,o]:(On=n,n=a);r!==a?e=t=V(t,r):(On=e,e=a)}else On=e,e=a;return e}function ea(){var t;return 42===e.charCodeAt(On)?(t=W,On++):(t=a,0===xn&&Rn(z)),t===a&&(47===e.charCodeAt(On)?(t=J,On++):(t=a,0===xn&&Rn($))),t}function ta(){var e,t;return(e=ma())===a&&(e=ca())===a&&(e=ha())===a&&(e=da())===a&&(e=pa())===a&&(e=_a())===a&&(e=Na())===a&&(e=ra())===a&&(e=ua())===a&&(e=On,xi()!==a&&Ci()!==a&&(t=Mn())!==a&&Ci()!==a&&Ei()!==a?e=H(t):(On=e,e=a)),e}function ra(){var e;return(e=na())!==a&&(e=Y(e)),e}function na(){var e;return(e=aa())!==a&&(e=Q(e)),e}function aa(){var e,t,r,n;if(e=On,(t=sa())!==a){for(r=[],n=oa();n!==a;)r.push(n),n=oa();r!==a?e=t=K(t,r):(On=e,e=a)}else On=e,e=a;return e}function ia(){var e,t,r,n;if(e=On,(t=sa())!==a){for(r=[],n=la();n!==a;)r.push(n),n=la();r!==a?e=t=K(t,r):(On=e,e=a)}else On=e,e=a;return e}function sa(){var t;return Z.test(e.charAt(On))?(t=e.charAt(On),On++):(t=a,0===xn&&Rn(X)),t}function la(){var t;return ee.test(e.charAt(On))?(t=e.charAt(On),On++):(t=a,0===xn&&Rn(te)),t}function oa(){var t;return re.test(e.charAt(On))?(t=e.charAt(On),On++):(t=a,0===xn&&Rn(ne)),t}function ua(){var t,r,n;return t=On,64===e.charCodeAt(On)?(r=ae,On++):(r=a,0===xn&&Rn(ie)),r!==a&&(n=ia())!==a?t=r=[r,n]:(On=t,t=a),t!==a&&(t=se(t)),t}function ca(){var e,t,r;return e=On,si()!==a&&Ci()!==a&&xi()!==a&&Ci()!==a&&(t=ga())!==a&&Ci()!==a&&ni()!==a&&Ci()!==a&&(r=Mn())!==a&&Ci()!==a&&Ei()!==a?e=le(t,r):(On=e,e=a),e}function ha(){var e,t,r,n,i,s,l,o;return e=On,ii()!==a&&Ci()!==a&&xi()!==a&&Ci()!==a&&(t=Mn())!==a&&Ci()!==a&&ni()!==a&&Ci()!==a&&(r=Mn())!==a&&Ci()!==a?(n=On,(i=ai())!==a&&(s=Ci())!==a&&(l=Mn())!==a&&(o=Ci())!==a?n=i=[i,s,l,o]:(On=n,n=a),n===a&&(n=null),n!==a&&(i=Ei())!==a?e=oe(t,r,n):(On=e,e=a)):(On=e,e=a),e}function da(){var e,t,r,n;return e=On,li()!==a&&Ci()!==a&&xi()!==a&&Ci()!==a?((t=fa())===a&&(t=null),t!==a&&Ci()!==a&&(r=Mn())!==a&&Ci()!==a&&ni()!==a&&Ci()!==a&&(n=Mn())!==a&&Ci()!==a&&Ei()!==a?e=ue(t,r,n):(On=e,e=a)):(On=e,e=a),e===a&&(e=On,li()!==a&&Ci()!==a&&xi()!==a&&Ci()!==a?((t=fa())===a&&(t=null),t!==a&&Ci()!==a&&(r=Mn())!==a&&Ci()!==a&&Ei()!==a?e=ce(t,r):(On=e,e=a)):(On=e,e=a)),e}function fa(){var e;return(e=hi())===a&&(e=di())===a&&(e=fi()),e}function pa(){var e,t,r;return e=On,oi()!==a&&Ci()!==a&&xi()!==a&&Ci()!==a&&(t=Mn())!==a&&Ci()!==a&&Ya()!==a&&Ci()!==a&&(r=Mn())!==a&&Ci()!==a&&Ei()!==a?e=he(t,r):(On=e,e=a),e}function _a(){var e,t,r;return e=On,(t=Ni())!==a&&Ci()!==a&&xi()!==a&&Ci()!==a?((r=Ln())===a&&(r=null),r!==a&&Ci()!==a&&Ei()!==a?e=t=de(t,r):(On=e,e=a)):(On=e,e=a),e}function ga(){var e;return(e=gi())===a&&(e=mi())===a&&(e=yi())===a&&(e=bi())===a&&(e=wi())===a&&(e=vi()),e}function ma(){var e;return(e=Da())===a&&(e=Ma())===a&&(e=Ea())===a&&(e=xa())===a&&(e=Ta())===a&&(e=ya())===a&&(e=ba()),e}function ya(){var e,t;return e=On,ui()!==a&&Ci()!==a&&(t=Ca())!==a?e=fe(t):(On=e,e=a),e}function ba(){var t,r,n,i;return t=On,_i()!==a&&Ci()!==a?(45===e.charCodeAt(On)?(r=U,On++):(r=a,0===xn&&Rn(q)),r===a&&(43===e.charCodeAt(On)?(r=G,On++):(r=a,0===xn&&Rn(B))),r!==a&&Ci()!==a&&(n=Ca())!==a&&Ci()!==a&&(i=wa())!==a?t=pe(r,n,i):(On=t,t=a)):(On=t,t=a),t===a&&(t=On,_i()!==a&&Ci()!==a&&(r=Ca())!==a&&Ci()!==a&&(n=wa())!==a?t=_e(r,n):(On=t,t=a)),t}function wa(){var e,t,r;return e=On,(t=va())!==a&&Ci()!==a&&pi()!==a&&Ci()!==a&&(r=Sa())!==a?e=t=ge(t,r):(On=e,e=a),e===a&&(e=Fa()),e}function va(){var e,t,r;return e=On,(t=Oa())!==a&&Ci()!==a&&xi()!==a&&Ci()!==a&&(r=ja())!==a&&Ci()!==a&&Ei()!==a?e=t=me(t,r):(On=e,e=a),e===a&&(e=On,(t=Oa())!==a&&(t=ye(t)),e=t),e}function Sa(){var e,t,r,n;return e=On,(t=Oa())!==a&&(t=be(t)),(e=t)===a&&(e=On,(t=vi())!==a&&Ci()!==a&&xi()!==a&&Ci()!==a&&(r=ja())!==a&&Ci()!==a&&Ti()!==a&&Ci()!==a&&(n=Ia())!==a&&Ci()!==a&&Ei()!==a?e=t=we(r,n):(On=e,e=a),e===a&&(e=On,(t=vi())!==a&&Ci()!==a&&xi()!==a&&Ci()!==a&&(r=ja())!==a&&Ci()!==a&&Ei()!==a?e=t=ve(r):(On=e,e=a),e===a&&(e=On,(t=vi())!==a&&(t=Se()),e=t))),e}function Fa(){var e,t,r,n;return e=On,(t=Oa())!==a&&Ci()!==a&&xi()!==a&&Ci()!==a&&(r=Ia())!==a&&Ci()!==a&&Ei()!==a?e=t=Fe(t,r):(On=e,e=a),e===a&&(e=On,(t=Oa())!==a&&(t=ye(t)),(e=t)===a&&(e=On,(t=vi())!==a&&Ci()!==a&&xi()!==a&&Ci()!==a&&(r=ja())!==a&&Ci()!==a&&Ti()!==a&&Ci()!==a&&(n=Ia())!==a&&Ci()!==a&&Ei()!==a?e=t=we(r,n):(On=e,e=a),e===a&&(e=On,(t=vi())!==a&&Ci()!==a&&xi()!==a&&Ci()!==a&&(r=Ia())!==a&&Ci()!==a&&Ei()!==a?e=t=Oe(r):(On=e,e=a),e===a&&(e=On,(t=vi())!==a&&(t=Ie()),e=t)))),e}function Oa(){var e,t;return e=On,(t=yi())!==a&&(t=je()),(e=t)===a&&(e=On,(t=bi())!==a&&(t=Te()),(e=t)===a&&(e=On,(t=wi())!==a&&(t=xe()),(e=t)===a&&(e=On,(t=mi())!==a&&(t=Ee()),(e=t)===a&&(e=On,(t=gi())!==a&&(t=Ce()),e=t)))),e}function Ia(){var e;return(e=Va())!==a&&(e=De(e)),e}function ja(){var e;return(e=Va())!==a&&(e=De(e)),e}function Ta(){var e,t;return e=On,ci()!==a&&Ci()!==a&&(t=Ca())!==a?e=Ne(t):(On=e,e=a),e}function xa(){var e;return(e=Ja())!==a&&(e=Ae()),e}function Ea(){var e,t;return e=On,(t=$a())!==a&&(t=Re()),(e=t)===a&&(e=On,(t=Ha())!==a&&(t=Pe()),e=t),e}function Ca(){var e;return(e=Da())===a&&(e=ua()),e}function Da(){var t,r,n,i,s;if(t=On,39===e.charCodeAt(On)?(r=ke,On++):(r=a,0===xn&&Rn(Le)),r===a&&(e.substr(On,2)===Me?(r=Me,On+=2):(r=a,0===xn&&Rn(Ge))),r!==a){for(n=[],i=On,e.substr(On,2)===Be?(s=Be,On+=2):(s=a,0===xn&&Rn(Ue)),s!==a&&(s=qe()),(i=s)===a&&(Ve.test(e.charAt(On))?(i=e.charAt(On),On++):(i=a,0===xn&&Rn(We)));i!==a;)n.push(i),i=On,e.substr(On,2)===Be?(s=Be,On+=2):(s=a,0===xn&&Rn(Ue)),s!==a&&(s=qe()),(i=s)===a&&(Ve.test(e.charAt(On))?(i=e.charAt(On),On++):(i=a,0===xn&&Rn(We)));n!==a?(39===e.charCodeAt(On)?(i=ke,On++):(i=a,0===xn&&Rn(Le)),i!==a?t=r=ze(n):(On=t,t=a)):(On=t,t=a)}else On=t,t=a;return t}function Na(){var e;return(e=Aa())===a&&(e=Ra()),e}function Aa(){var e,t,r,n,i;if(e=On,Si()!==a)if(Ci()!==a)if((t=Mn())!==a)if(Ci()!==a){for(r=[],n=ka();n!==a;)r.push(n),n=ka();r!==a&&(n=Ci())!==a&&(i=Fi())!==a?e=Je(t,r):(On=e,e=a)}else On=e,e=a;else On=e,e=a;else On=e,e=a;else On=e,e=a;if(e===a)if(e=On,Si()!==a)if(Ci()!==a)if((t=Mn())!==a)if(Ci()!==a){for(r=[],n=ka();n!==a;)r.push(n),n=ka();r!==a&&(n=Ci())!==a&&(i=La())!==a&&Ci()!==a&&Fi()!==a?e=$e(t,r,i):(On=e,e=a)}else On=e,e=a;else On=e,e=a;else On=e,e=a;else On=e,e=a;return e}function Ra(){var e,t,r,n;if(e=On,Si()!==a)if(Ci()!==a){for(t=[],r=Pa();r!==a;)t.push(r),r=Pa();t!==a&&(r=Ci())!==a&&(n=Fi())!==a?e=He(t):(On=e,e=a)}else On=e,e=a;else On=e,e=a;if(e===a)if(e=On,Si()!==a)if(Ci()!==a){for(t=[],r=Pa();r!==a;)t.push(r),r=Pa();t!==a&&(r=Ci())!==a&&(n=La())!==a&&Ci()!==a&&Fi()!==a?e=Ye(t,n):(On=e,e=a)}else On=e,e=a;else On=e,e=a;return e}function Pa(){var e,t,r;return e=On,Oi()!==a&&Ci()!==a&&(t=Mn())!==a&&Ci()!==a&&Ii()!==a&&Ci()!==a&&(r=Mn())!==a?e=Qe(t,r):(On=e,e=a),e}function ka(){var e,t,r;return e=On,Oi()!==a&&Ci()!==a&&(t=Mn())!==a&&Ci()!==a&&Ii()!==a&&Ci()!==a&&(r=Mn())!==a?e=Qe(t,r):(On=e,e=a),e}function La(){var e,t;return e=On,ji()!==a&&Ci()!==a&&(t=Mn())!==a?e=Ke(t):(On=e,e=a),e}function Ma(){var e,t,r,n;return e=On,(t=Ga())!==a?(r=On,xn++,n=sa(),xn--,n===a?r=void 0:(On=r,r=a),r!==a?e=t=Ze(t):(On=e,e=a)):(On=e,e=a),e}function Ga(){var e,t,r,n;return e=On,(t=Ba())!==a&&(r=Ua())!==a&&(n=qa())!==a?e=t=Xe(t,r,n):(On=e,e=a),e===a&&(e=On,(t=Ba())!==a&&(r=Ua())!==a?e=t=et(t,r):(On=e,e=a),e===a&&(e=On,(t=Ba())!==a&&(r=qa())!==a?e=t=tt(t,r):(On=e,e=a),e===a&&(e=On,(t=Ba())!==a&&(t=rt(t)),e=t))),e}function Ba(){var t,r,n;return(t=Va())===a&&(t=On,45===e.charCodeAt(On)?(r=U,On++):(r=a,0===xn&&Rn(q)),r===a&&(43===e.charCodeAt(On)?(r=G,On++):(r=a,0===xn&&Rn(B))),r!==a&&(n=Va())!==a?t=r=nt(r,n):(On=t,t=a)),t}function Ua(){var t,r,n;return t=On,46===e.charCodeAt(On)?(r=at,On++):(r=a,0===xn&&Rn(it)),r!==a?((n=Va())===a&&(n=null),n!==a?t=r=st(n):(On=t,t=a)):(On=t,t=a),t}function qa(){var e,t,r;return e=On,(t=za())!==a&&(r=Va())!==a?e=t=lt(t,r):(On=e,e=a),e}function Va(){var e,t;if(e=[],(t=Wa())!==a)for(;t!==a;)e.push(t),t=Wa();else e=a;return e!==a&&(e=ot(e)),e}function Wa(){var t;return ut.test(e.charAt(On))?(t=e.charAt(On),On++):(t=a,0===xn&&Rn(ct)),t}function za(){var t,r,n;return t=On,ht.test(e.charAt(On))?(r=e.charAt(On),On++):(r=a,0===xn&&Rn(dt)),r!==a?(ft.test(e.charAt(On))?(n=e.charAt(On),On++):(n=a,0===xn&&Rn(pt)),n===a&&(n=null),n!==a?t=r=_t(r,n):(On=t,t=a)):(On=t,t=a),t}function Ja(){var t,r,n,i;return t=On,e.substr(On,4).toLowerCase()===gt?(r=e.substr(On,4),On+=4):(r=a,0===xn&&Rn(mt)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=[r,n]:(On=t,t=a)):(On=t,t=a),t}function $a(){var t,r,n,i;return t=On,e.substr(On,4).toLowerCase()===yt?(r=e.substr(On,4),On+=4):(r=a,0===xn&&Rn(bt)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=[r,n]:(On=t,t=a)):(On=t,t=a),t}function Ha(){var t,r,n,i;return t=On,e.substr(On,5).toLowerCase()===wt?(r=e.substr(On,5),On+=5):(r=a,0===xn&&Rn(vt)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=[r,n]:(On=t,t=a)):(On=t,t=a),t}function Ya(){var t,r,n,i;return t=On,e.substr(On,2).toLowerCase()===St?(r=e.substr(On,2),On+=2):(r=a,0===xn&&Rn(Ft)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=Ot():(On=t,t=a)):(On=t,t=a),t}function Qa(){var t,r,n,i;return t=On,e.substr(On,2).toLowerCase()===It?(r=e.substr(On,2),On+=2):(r=a,0===xn&&Rn(jt)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=Tt():(On=t,t=a)):(On=t,t=a),t}function Ka(){var t,r,n,i;return t=On,e.substr(On,4).toLowerCase()===xt?(r=e.substr(On,4),On+=4):(r=a,0===xn&&Rn(Et)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=Ct():(On=t,t=a)):(On=t,t=a),t}function Za(){var t,r,n,i;return t=On,e.substr(On,6).toLowerCase()===Dt?(r=e.substr(On,6),On+=6):(r=a,0===xn&&Rn(Nt)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=At():(On=t,t=a)):(On=t,t=a),t}function Xa(){var t,r,n,i;return t=On,e.substr(On,3).toLowerCase()===Rt?(r=e.substr(On,3),On+=3):(r=a,0===xn&&Rn(Pt)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=kt():(On=t,t=a)):(On=t,t=a),t}function ei(){var t,r,n,i;return t=On,e.substr(On,3).toLowerCase()===Lt?(r=e.substr(On,3),On+=3):(r=a,0===xn&&Rn(Mt)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=Gt():(On=t,t=a)):(On=t,t=a),t}function ti(){var t,r,n,i;return t=On,e.substr(On,2).toLowerCase()===Bt?(r=e.substr(On,2),On+=2):(r=a,0===xn&&Rn(Ut)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=qt():(On=t,t=a)):(On=t,t=a),t}function ri(){var t,r,n,i;return t=On,e.substr(On,7).toLowerCase()===Vt?(r=e.substr(On,7),On+=7):(r=a,0===xn&&Rn(Wt)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=zt():(On=t,t=a)):(On=t,t=a),t}function ni(){var t,r,n,i;return t=On,e.substr(On,4).toLowerCase()===Jt?(r=e.substr(On,4),On+=4):(r=a,0===xn&&Rn($t)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=Ht():(On=t,t=a)):(On=t,t=a),t}function ai(){var t,r,n,i;return t=On,e.substr(On,3).toLowerCase()===Yt?(r=e.substr(On,3),On+=3):(r=a,0===xn&&Rn(Qt)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=Kt():(On=t,t=a)):(On=t,t=a),t}function ii(){var t,r,n,i;return t=On,e.substr(On,9).toLowerCase()===Zt?(r=e.substr(On,9),On+=9):(r=a,0===xn&&Rn(Xt)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=er():(On=t,t=a)):(On=t,t=a),t}function si(){var t,r,n,i;return t=On,e.substr(On,7).toLowerCase()===tr?(r=e.substr(On,7),On+=7):(r=a,0===xn&&Rn(rr)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=nr():(On=t,t=a)):(On=t,t=a),t}function li(){var t,r,n,i;return t=On,e.substr(On,4).toLowerCase()===ar?(r=e.substr(On,4),On+=4):(r=a,0===xn&&Rn(ir)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=sr():(On=t,t=a)):(On=t,t=a),t}function oi(){var t,r,n,i;return t=On,e.substr(On,8).toLowerCase()===lr?(r=e.substr(On,8),On+=8):(r=a,0===xn&&Rn(or)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=ur():(On=t,t=a)):(On=t,t=a),t}function ui(){var t,r,n,i;return t=On,e.substr(On,9).toLowerCase()===cr?(r=e.substr(On,9),On+=9):(r=a,0===xn&&Rn(hr)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=dr():(On=t,t=a)):(On=t,t=a),t}function ci(){var t,r,n,i;return t=On,e.substr(On,4).toLowerCase()===fr?(r=e.substr(On,4),On+=4):(r=a,0===xn&&Rn(pr)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=_r():(On=t,t=a)):(On=t,t=a),t}function hi(){var t,r,n,i;return t=On,e.substr(On,7).toLowerCase()===gr?(r=e.substr(On,7),On+=7):(r=a,0===xn&&Rn(mr)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=yr():(On=t,t=a)):(On=t,t=a),t}function di(){var t,r,n,i;return t=On,e.substr(On,8).toLowerCase()===br?(r=e.substr(On,8),On+=8):(r=a,0===xn&&Rn(wr)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=vr():(On=t,t=a)):(On=t,t=a),t}function fi(){var t,r,n,i;return t=On,e.substr(On,4).toLowerCase()===Sr?(r=e.substr(On,4),On+=4):(r=a,0===xn&&Rn(Fr)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=Or():(On=t,t=a)):(On=t,t=a),t}function pi(){var t,r,n,i;return t=On,e.substr(On,2).toLowerCase()===Ir?(r=e.substr(On,2),On+=2):(r=a,0===xn&&Rn(jr)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=Tr():(On=t,t=a)):(On=t,t=a),t}function _i(){var t,r,n,i;return t=On,e.substr(On,8).toLowerCase()===xr?(r=e.substr(On,8),On+=8):(r=a,0===xn&&Rn(Er)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=Cr():(On=t,t=a)):(On=t,t=a),t}function gi(){var t,r,n,i;return t=On,e.substr(On,4).toLowerCase()===Dr?(r=e.substr(On,4),On+=4):(r=a,0===xn&&Rn(Nr)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=Ar():(On=t,t=a)):(On=t,t=a),t}function mi(){var t,r,n,i;return t=On,e.substr(On,5).toLowerCase()===Rr?(r=e.substr(On,5),On+=5):(r=a,0===xn&&Rn(Pr)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=kr():(On=t,t=a)):(On=t,t=a),t}function yi(){var t,r,n,i;return t=On,e.substr(On,3).toLowerCase()===Lr?(r=e.substr(On,3),On+=3):(r=a,0===xn&&Rn(Mr)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=Gr():(On=t,t=a)):(On=t,t=a),t}function bi(){var t,r,n,i;return t=On,e.substr(On,4).toLowerCase()===Br?(r=e.substr(On,4),On+=4):(r=a,0===xn&&Rn(Ur)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=qr():(On=t,t=a)):(On=t,t=a),t}function wi(){var t,r,n,i;return t=On,e.substr(On,6).toLowerCase()===Vr?(r=e.substr(On,6),On+=6):(r=a,0===xn&&Rn(Wr)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=zr():(On=t,t=a)):(On=t,t=a),t}function vi(){var t,r,n,i;return t=On,e.substr(On,6).toLowerCase()===Jr?(r=e.substr(On,6),On+=6):(r=a,0===xn&&Rn($r)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=Hr():(On=t,t=a)):(On=t,t=a),t}function Si(){var t,r,n,i;return t=On,e.substr(On,4).toLowerCase()===Yr?(r=e.substr(On,4),On+=4):(r=a,0===xn&&Rn(Qr)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=Kr():(On=t,t=a)):(On=t,t=a),t}function Fi(){var t,r,n,i;return t=On,e.substr(On,3).toLowerCase()===Zr?(r=e.substr(On,3),On+=3):(r=a,0===xn&&Rn(Xr)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=en():(On=t,t=a)):(On=t,t=a),t}function Oi(){var t,r,n,i;return t=On,e.substr(On,4).toLowerCase()===tn?(r=e.substr(On,4),On+=4):(r=a,0===xn&&Rn(rn)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=nn():(On=t,t=a)):(On=t,t=a),t}function Ii(){var t,r,n,i;return t=On,e.substr(On,4).toLowerCase()===an?(r=e.substr(On,4),On+=4):(r=a,0===xn&&Rn(sn)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=ln():(On=t,t=a)):(On=t,t=a),t}function ji(){var t,r,n,i;return t=On,e.substr(On,4).toLowerCase()===on?(r=e.substr(On,4),On+=4):(r=a,0===xn&&Rn(un)),r!==a?(n=On,xn++,i=la(),xn--,i===a?n=void 0:(On=n,n=a),n!==a?t=r=cn():(On=t,t=a)):(On=t,t=a),t}function Ti(){var t;return 44===e.charCodeAt(On)?(t=hn,On++):(t=a,0===xn&&Rn(dn)),t}function xi(){var t;return 40===e.charCodeAt(On)?(t=fn,On++):(t=a,0===xn&&Rn(pn)),t}function Ei(){var t;return 41===e.charCodeAt(On)?(t=_n,On++):(t=a,0===xn&&Rn(gn)),t}function Ci(){var e,t;for(e=[],t=Di();t!==a;)e.push(t),t=Di();return e}function Di(){var t;return mn.test(e.charAt(On))?(t=e.charAt(On),On++):(t=a,0===xn&&Rn(yn)),t}function Ni(){var t,r,n,i;if(t=On,(r=ia())!==a&&(r=Q(r)),(t=r)===a)if(t=On,96===e.charCodeAt(On)?(r=bn,On++):(r=a,0===xn&&Rn(wn)),r!==a){if(n=[],vn.test(e.charAt(On))?(i=e.charAt(On),On++):(i=a,0===xn&&Rn(Sn)),i!==a)for(;i!==a;)n.push(i),vn.test(e.charAt(On))?(i=e.charAt(On),On++):(i=a,0===xn&&Rn(Sn));else n=a;n!==a?(96===e.charCodeAt(On)?(i=bn,On++):(i=a,0===xn&&Rn(wn)),i!==a?t=r=Fn(n):(On=t,t=a)):(On=t,t=a)}else On=t,t=a;return t}function Ai(e,t){return{type:"unary_expr",operator:e,expr:t}}function Ri(e,t,r,n){var a={type:"binary_expr",operator:e,left:t,right:r};return void 0!==n&&(a.escape=n),a}function Pi(e,t){for(var r=[e],n=0;n<t.length;n++)r.push(t[n][3]);return r}function ki(e,t,r){return Pi(e,t)}function Li(e,t){for(var r=e,n=0;n<t.length;n++)r=Ri(t[n][1],r,t[n][3]);return r}if((n=s())!==a&&On===e.length)return n;throw n!==a&&On<e.length&&Rn(Dn()),Pn(Tn,jn<e.length?e.charAt(jn):null,jn<e.length?An(jn,jn+1):An(jn,jn))}return e(t,Error),t.buildMessage=function(e,t){var r={literal:function(e){return'"'+a(e.text)+'"'},class:function(e){var t,r="";for(t=0;t<e.parts.length;t++)r+=e.parts[t]instanceof Array?i(e.parts[t][0])+"-"+i(e.parts[t][1]):i(e.parts[t]);return"["+(e.inverted?"^":"")+r+"]"},any:function(e){return"any character"},end:function(e){return"end of input"},other:function(e){return e.description}};function n(e){return e.charCodeAt(0).toString(16).toUpperCase()}function a(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(e){return"\\x0"+n(e)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(e){return"\\x"+n(e)}))}function i(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(e){return"\\x0"+n(e)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(e){return"\\x"+n(e)}))}function s(e){return r[e.type](e)}function l(e){var t,r,n=new Array(e.length);for(t=0;t<e.length;t++)n[t]=s(e[t]);if(n.sort(),n.length>0){for(t=1,r=1;t<n.length;t++)n[t-1]!==n[t]&&(n[r]=n[t],r++);n.length=r}switch(n.length){case 1:return n[0];case 2:return n[0]+" or "+n[1];default:return n.slice(0,-1).join(", ")+", or "+n[n.length-1]}}function o(e){return e?'"'+a(e)+'"':"end of input"}return"Expected "+l(e)+" but "+o(t)+" found."},{SyntaxError:t,parse:r}}())}));class g{static parse(e){return _.parse(e)}}const m=/^(\d{4})-(\d{1,2})-(\d{1,2})$/,y=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2}(\.[0-9]+)?)$/,b=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2}(\.[0-9]+)?)(\+|\-)(\d{1,2}):(\d{1,2})$/,w=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})(\+|\-)(\d{1,2}):(\d{1,2})$/,v=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})$/;function S(e,t){return(e+="").length>=t?e:new Array(t-e.length+1).join("0")+e}function F(e,t,r="0",n="0",a="0",i="0",s="",l="0",o="0"){if("+"===s||"-"===s){const u=`${S(parseInt(e,10),4)}-${S(parseInt(t,10),2)}-${S(parseInt(r,10),2)}`;let c="";parseFloat(i)<10&&(c="0");const h=`${S(parseInt(n,10),2)}:${S(parseInt(a,10),2)}:${c+parseFloat(i).toString()}`,d=`${s}${S(parseInt(l,10),2)}:${S(parseInt(o,10),2)}`;return new Date(u+"T"+h+d)}return new Date(parseInt(e,10),parseInt(t,10)-1,parseInt(r,10),parseInt(n,10),parseInt(a,10),parseFloat(i))}class O{static makeBool(e){return x(e)}static featureValue(e,t,r,n){return G(e,t,r,n)}static equalsNull(e){return null===e}static applyLike(e,t,r){return R(e,t,r)}static ensureArray(e){return E(e)}static applyIn(e,t){return A(e,t)}static currentDate(){const e=new Date;return e.setHours(0,0,0,0),e}static makeSqlInterval(e,t,r){return c.createFromValueAndQualifer(e,t,r)}static convertInterval(e){return e instanceof c?e.valueInMilliseconds():e}static currentTimestamp(){return new Date}static compare(e,t,r){return k(e,t,r)}static calculate(e,t,r){return M(e,t,r)}static makeComparable(e){return P(e)}static evaluateFunction(e,t){return h(e,t)}static lookup(e,t){const r=t[e];return void 0===r?null:r}static between(e,t){return null==e||null==t[0]||null==t[1]?null:e>=t[0]&&e<=t[1]}static notbetween(e,t){return null==e||null==t[0]||null==t[1]?null:e<t[0]||e>t[1]}static ternaryNot(e){return C(e)}static ternaryAnd(e,t){return D(e,t)}static ternaryOr(e,t){return N(e,t)}}class I{constructor(e,t){this.fieldsIndex=t,this.datefields={},this.parameters={},this.parseTree=g.parse(e);const{isStandardized:r,isAggregate:n,referencedFieldNames:a}=this.extractExpressionInfo(t);this.referencedFieldNames=a,this.isStandardized=r,this.isAggregate=n}static create(e,t){return new I(e,t)}get fieldNames(){return this.referencedFieldNames}testSet(e,t=B){const r={};for(const n of this.fieldNames)r[n]=e.map(e=>t.getAttribute(e,n));return!!this.evaluateNode(this.parseTree,{attributes:r},B)}calculateValue(e,t=B){const r=this.evaluateNode(this.parseTree,e,t);return r instanceof c?r.valueInMilliseconds()/864e5:r}calculateValueCompiled(e,t=B){return null!=this.parseTree._compiledVersion?this.parseTree._compiledVersion(e,this.parameters,t,this.datefields):Object(n["a"])("csp-restrictions")?this.calculateValue(e,t):(this.compileMe(),this.parseTree._compiledVersion(e,this.parameters,t,this.datefields))}testFeature(e,t=B){return!!this.evaluateNode(this.parseTree,e,t)}testFeatureCompiled(e,t=B){return null!=this.parseTree._compiledVersion?!!this.parseTree._compiledVersion(e,this.parameters,t,this.datefields):Object(n["a"])("csp-restrictions")?this.testFeature(e,t):(this.compileMe(),!!this.parseTree._compiledVersion(e,this.parameters,t,this.datefields))}getFunctions(){const e=[];return this.visitAll(this.parseTree,t=>{"function"===t.type&&e.push(t.name.toLowerCase())}),L(e)}getExpressions(){const e=new Map;return this.visitAll(this.parseTree,t=>{if("function"===t.type){const r=t.name.toLowerCase(),n=t.args.value[0];if("column_ref"===n.type){const t=n.column,a=`${r}-${t}`;e.has(a)||e.set(a,{aggregateType:r,field:t})}}}),[...e.values()]}getVariables(){const e=[];return this.visitAll(this.parseTree,t=>{"param"===t.type&&e.push(t.value.toLowerCase())}),L(e)}compileMe(){const e="return this.convertInterval("+this.evaluateNodeToJavaScript(this.parseTree)+")";this.parseTree._compiledVersion=new Function("feature","lookups","attributeAdapter","datefields",e).bind(O)}extractExpressionInfo(e){const t=[];let r=!0,n=!0;return this.visitAll(this.parseTree,a=>{switch(a.type){case"column_ref":{const r=e.get(a.column),n=r&&r.name;!r||"date"!==r.type&&"esriFieldTypeDate"!==r.type||(this.datefields[r.name]=1),void 0!==n?(t.push(n),a.column=n):t.push(a.column);break}case"function":{const{name:e,args:t}=a,s=t.value.length;r&&(r=d(e,s)),n&&(n=i(e,s));break}}}),{referencedFieldNames:L(t),isStandardized:r,isAggregate:n}}visitAll(e,t){if(null!=e)switch(t(e),e.type){case"when_clause":this.visitAll(e.operand,t),this.visitAll(e.value,t);break;case"case_expression":for(const r of e.clauses)this.visitAll(r,t);"simple"===e.format&&this.visitAll(e.operand,t),null!==e.else&&this.visitAll(e.else,t);break;case"expr_list":for(const r of e.value)this.visitAll(r,t);break;case"unary_expr":this.visitAll(e.expr,t);break;case"binary_expr":this.visitAll(e.left,t),this.visitAll(e.right,t);break;case"function":this.visitAll(e.args,t)}}evaluateNodeToJavaScript(e){switch(e.type){case"interval":return"this.makeSqlInterval("+this.evaluateNodeToJavaScript(e.value)+", "+JSON.stringify(e.qualifier)+","+JSON.stringify(e.op)+")";case"case_expression":{let t="";if("simple"===e.format){const r="this.makeComparable("+this.evaluateNodeToJavaScript(e.operand)+")";t="( ";for(let n=0;n<e.clauses.length;n++)t+=" ("+r+" === this.makeComparable("+this.evaluateNodeToJavaScript(e.clauses[n].operand)+")) ? ("+this.evaluateNodeToJavaScript(e.clauses[n].value)+") : ";null!==e.else?t+=this.evaluateNodeToJavaScript(e.else):t+="null",t+=" )"}else{t="( ";for(let r=0;r<e.clauses.length;r++)t+=" this.makeBool("+this.evaluateNodeToJavaScript(e.clauses[r].operand)+")===true ? ("+this.evaluateNodeToJavaScript(e.clauses[r].value)+") : ";null!==e.else?t+=this.evaluateNodeToJavaScript(e.else):t+="null",t+=" )"}return t}case"param":return"this.lookup("+JSON.stringify(e.value.toLowerCase())+",lookups)";case"expr_list":{let t="[";for(const r of e.value)"["!==t&&(t+=","),t+=this.evaluateNodeToJavaScript(r);return t+="]",t}case"unary_expr":return"this.ternaryNot("+this.evaluateNodeToJavaScript(e.expr)+")";case"binary_expr":switch(e.operator){case"AND":return"this.ternaryAnd("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+" )";case"OR":return"this.ternaryOr("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+" )";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return"this.equalsNull("+this.evaluateNodeToJavaScript(e.left)+")";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return"(!(this.equalsNull("+this.evaluateNodeToJavaScript(e.left)+")))";case"IN":return"this.applyIn("+this.evaluateNodeToJavaScript(e.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(e.right)+"))";case"NOT IN":return"this.ternaryNot(this.applyIn("+this.evaluateNodeToJavaScript(e.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(e.right)+")))";case"BETWEEN":return"this.between("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")";case"NOTBETWEEN":return"this.notbetween("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")";case"LIKE":return"this.applyLike("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+","+JSON.stringify(e.escape)+")";case"NOT LIKE":return"this.ternaryNot(this.applyLike("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+","+JSON.stringify(e.escape)+"))";case"<>":case"<":case">":case">=":case"<=":case"=":return"this.compare("+JSON.stringify(e.operator)+","+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")";case"*":case"-":case"+":case"/":return"this.calculate("+JSON.stringify(e.operator)+","+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")"}throw new Error("Not Supported Operator "+e.operator);case"null":case"bool":case"string":case"number":return JSON.stringify(e.value);case"date":return"(new Date("+T(e.value).getTime().toString()+"))";case"timestamp":return"(new Date("+j(e.value).getTime().toString()+"))";case"current_time":return"date"===e.mode?"this.currentDate()":"this.currentTimestamp()";case"column_ref":return"this.featureValue(feature,"+JSON.stringify(e.column)+",datefields,attributeAdapter)";case"function":return"this.evaluateFunction("+JSON.stringify(e.name)+","+this.evaluateNodeToJavaScript(e.args)+")"}throw new Error("Unsupported sql syntax "+e.type)}evaluateNode(e,t,r){switch(e.type){case"interval":{const n=this.evaluateNode(e.value,t,r);return c.createFromValueAndQualifer(n,e.qualifier,e.op)}case"case_expression":if("simple"===e.format){const n=P(this.evaluateNode(e.operand,t,r));for(let a=0;a<e.clauses.length;a++)if(n===P(this.evaluateNode(e.clauses[a].operand,t,r)))return this.evaluateNode(e.clauses[a].value,t,r);if(null!==e.else)return this.evaluateNode(e.else,t,r)}else{for(let n=0;n<e.clauses.length;n++)if(x(this.evaluateNode(e.clauses[n].operand,t,r)))return this.evaluateNode(e.clauses[n].value,t,r);if(null!==e.else)return this.evaluateNode(e.else,t,r)}return null;case"param":return this.parameters[e.value.toLowerCase()];case"expr_list":{const n=[];for(const a of e.value)n.push(this.evaluateNode(a,t,r));return n}case"unary_expr":return C(this.evaluateNode(e.expr,t,r));case"binary_expr":switch(e.operator){case"AND":return D(this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r));case"OR":return N(this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r));case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return null===this.evaluateNode(e.left,t,r);case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return null!==this.evaluateNode(e.left,t,r);case"IN":{const n=E(this.evaluateNode(e.right,t,r));return A(this.evaluateNode(e.left,t,r),n)}case"NOT IN":{const n=E(this.evaluateNode(e.right,t,r));return C(A(this.evaluateNode(e.left,t,r),n))}case"BETWEEN":{const n=this.evaluateNode(e.left,t,r),a=this.evaluateNode(e.right,t,r);return null==n||null==a[0]||null==a[1]?null:n>=P(a[0])&&n<=P(a[1])}case"NOTBETWEEN":{const n=this.evaluateNode(e.left,t,r),a=this.evaluateNode(e.right,t,r);return null==n||null==a[0]||null==a[1]?null:n<P(a[0])||n>P(a[1])}case"LIKE":return R(this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r),e.escape);case"NOT LIKE":return C(R(this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r),e.escape));case"<>":case"<":case">":case">=":case"<=":case"=":return k(e.operator,this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r));case"-":case"+":case"*":case"/":return M(e.operator,this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r))}case"null":case"bool":case"string":case"number":return e.value;case"date":return T(e.value);case"timestamp":return j(e.value);case"current_time":{const t=new Date;return"date"===e.mode&&t.setHours(0,0,0,0),t}case"column_ref":return G(t,e.column,this.datefields,r);case"function":{const n=this.evaluateNode(e.args,t,r);return this.isAggregate?a(e.name,n):h(e.name,n)}}throw new Error("Unsupported sql syntax "+e.type)}}function j(e){let t=y.exec(e);if(null!==t){const[,e,r,n,a,i,s]=t;return F(e,r,n,a,i,s)}if(t=b.exec(e),null!==t){const[,e,r,n,a,i,s,l,o,u]=t;return F(e,r,n,a,i,s,l,o,u)}if(t=w.exec(e),null!==t){const[,e,r,n,a,i,s,l,o]=t;return F(e,r,n,a,i,"0",s,l,o)}if(t=v.exec(e),null!==t){const[,e,r,n,a,i]=t;return F(e,r,n,a,i)}if(t=m.exec(e),null!==t){const[,e,r,n]=t;return F(e,r,n)}throw new Error("SQL Invalid Timestamp")}function T(e){const t=m.exec(e);if(null===t)throw new Error("SQL Invalid Date");const[,r,n,a]=t;return new Date(parseInt(r,10),parseInt(n,10)-1,parseInt(a,10))}function x(e){return!0===e}function E(e){return Array.isArray(e)?e:[e]}function C(e){return null!==e?!0!==e:null}function D(e,t){return null!=e&&null!=t?!0===e&&!0===t:!1!==e&&!1!==t&&null}function N(e,t){return null!=e&&null!=t?!0===e||!0===t:!0===e||!0===t||null}function A(e,t){if(null==e)return null;let r=!1;for(const n of t)if(null==n)r=null;else if(e===n){r=!0;break}return r}function R(e,t,r){if(null==e)return null;const n=t,a=r;let i="";const s="-[]/{}()*+?.\\^$|";let l=0;for(let o=0;o<n.length;o++){const e=n.charAt(o);switch(l){case 0:e===a?l=1:s.indexOf(e)>=0?i+="\\"+e:i+="%"===e?".*":"_"===e?".":e;break;case 1:s.indexOf(e)>=0?i+="\\"+e:i+=e,l=0}}return new RegExp("^"+i+"$").test(e)}function P(e){return e instanceof Date?e.valueOf():e}function k(e,t,r){if(null==t||null==r)return null;const n=P(t),a=P(r);switch(e){case"<>":return n!==a;case"=":return n===a;case">":return n>a;case"<":return n<a;case">=":return n>=a;case"<=":return n<=a}}function L(e){const t=[],r={};for(const n of e){const e=n.toLowerCase();void 0===r[e]&&(t.push(n),r[e]=1)}return t}function M(e,t,r){if(t instanceof c)if(r instanceof Date)switch(e){case"+":return new Date(t.valueInMilliseconds()+r.getTime());case"-":return t.valueInMilliseconds()-r.getTime();case"*":return t.valueInMilliseconds()*r.getTime();case"/":return t.valueInMilliseconds()/r.getTime()}else if(r instanceof c)switch(e){case"+":return c.createFromMilliseconds(t.valueInMilliseconds()+r.valueInMilliseconds());case"-":return c.createFromMilliseconds(t.valueInMilliseconds()-r.valueInMilliseconds());case"*":return t.valueInMilliseconds()*r.valueInMilliseconds();case"/":return t.valueInMilliseconds()/r.valueInMilliseconds()}else t=t.valueInMilliseconds();else if(r instanceof c)if(t instanceof Date)switch(e){case"+":return new Date(r.valueInMilliseconds()+t.getTime());case"-":return new Date(t.getTime()-r.valueInMilliseconds());case"*":return t.getTime()*r.valueInMilliseconds();case"/":return t.getTime()/r.valueInMilliseconds()}else r=r.valueInMilliseconds();else if(t instanceof Date&&"number"==typeof r)switch(r=24*r*60*60*1e3,t=t.getTime(),e){case"+":return new Date(t+r);case"-":return new Date(t-r);case"*":return new Date(t*r);case"/":return new Date(t/r)}else if(r instanceof Date&&"number"==typeof t)switch(t=24*t*60*60*1e3,r=r.getTime(),e){case"+":return new Date(t+r);case"-":return new Date(t-r);case"*":return new Date(t*r);case"/":return new Date(t/r)}switch(e){case"+":return t+r;case"-":return t-r;case"*":return t*r;case"/":return t/r}}function G(e,t,r,n){const a=n.getAttribute(e,t);return null!=a&&1===r[t]?new Date(a):a}const B={getAttribute(e,t){var r;return((r=e)&&"object"==typeof r.attributes?e.attributes:e)[t]}}},"7efa":function(e,t,r){"use strict";r.d(t,"a",(function(){return c})),r.d(t,"b",(function(){return n}));const n={Base64:0,Hex:1,String:2,Raw:3};function a(e,t){const r=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(r>>16)<<16|65535&r}function i(e,t,r,n,i,s){return a((l=a(a(t,e),a(n,s)))<<(o=i)|l>>>32-o,r);var l,o}function s(e,t,r,n,a,s,l){return i(t&r|~t&n,e,t,a,s,l)}function l(e,t,r,n,a,s,l){return i(t&n|r&~n,e,t,a,s,l)}function o(e,t,r,n,a,s,l){return i(t^r^n,e,t,a,s,l)}function u(e,t,r,n,a,s,l){return i(r^(t|~n),e,t,a,s,l)}function c(e,t=n.Hex){const r=t||n.Base64,i=function(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;let r=1732584193,n=-271733879,i=-1732584194,c=271733878;for(let h=0;h<e.length;h+=16){const t=r,d=n,f=i,p=c;r=s(r,n,i,c,e[h+0],7,-680876936),c=s(c,r,n,i,e[h+1],12,-389564586),i=s(i,c,r,n,e[h+2],17,606105819),n=s(n,i,c,r,e[h+3],22,-1044525330),r=s(r,n,i,c,e[h+4],7,-176418897),c=s(c,r,n,i,e[h+5],12,1200080426),i=s(i,c,r,n,e[h+6],17,-1473231341),n=s(n,i,c,r,e[h+7],22,-45705983),r=s(r,n,i,c,e[h+8],7,1770035416),c=s(c,r,n,i,e[h+9],12,-1958414417),i=s(i,c,r,n,e[h+10],17,-42063),n=s(n,i,c,r,e[h+11],22,-1990404162),r=s(r,n,i,c,e[h+12],7,1804603682),c=s(c,r,n,i,e[h+13],12,-40341101),i=s(i,c,r,n,e[h+14],17,-1502002290),n=s(n,i,c,r,e[h+15],22,1236535329),r=l(r,n,i,c,e[h+1],5,-165796510),c=l(c,r,n,i,e[h+6],9,-1069501632),i=l(i,c,r,n,e[h+11],14,643717713),n=l(n,i,c,r,e[h+0],20,-373897302),r=l(r,n,i,c,e[h+5],5,-701558691),c=l(c,r,n,i,e[h+10],9,38016083),i=l(i,c,r,n,e[h+15],14,-660478335),n=l(n,i,c,r,e[h+4],20,-405537848),r=l(r,n,i,c,e[h+9],5,568446438),c=l(c,r,n,i,e[h+14],9,-1019803690),i=l(i,c,r,n,e[h+3],14,-187363961),n=l(n,i,c,r,e[h+8],20,1163531501),r=l(r,n,i,c,e[h+13],5,-1444681467),c=l(c,r,n,i,e[h+2],9,-51403784),i=l(i,c,r,n,e[h+7],14,1735328473),n=l(n,i,c,r,e[h+12],20,-1926607734),r=o(r,n,i,c,e[h+5],4,-378558),c=o(c,r,n,i,e[h+8],11,-2022574463),i=o(i,c,r,n,e[h+11],16,1839030562),n=o(n,i,c,r,e[h+14],23,-35309556),r=o(r,n,i,c,e[h+1],4,-1530992060),c=o(c,r,n,i,e[h+4],11,1272893353),i=o(i,c,r,n,e[h+7],16,-155497632),n=o(n,i,c,r,e[h+10],23,-1094730640),r=o(r,n,i,c,e[h+13],4,681279174),c=o(c,r,n,i,e[h+0],11,-358537222),i=o(i,c,r,n,e[h+3],16,-722521979),n=o(n,i,c,r,e[h+6],23,76029189),r=o(r,n,i,c,e[h+9],4,-640364487),c=o(c,r,n,i,e[h+12],11,-421815835),i=o(i,c,r,n,e[h+15],16,530742520),n=o(n,i,c,r,e[h+2],23,-995338651),r=u(r,n,i,c,e[h+0],6,-198630844),c=u(c,r,n,i,e[h+7],10,1126891415),i=u(i,c,r,n,e[h+14],15,-1416354905),n=u(n,i,c,r,e[h+5],21,-57434055),r=u(r,n,i,c,e[h+12],6,1700485571),c=u(c,r,n,i,e[h+3],10,-1894986606),i=u(i,c,r,n,e[h+10],15,-1051523),n=u(n,i,c,r,e[h+1],21,-2054922799),r=u(r,n,i,c,e[h+8],6,1873313359),c=u(c,r,n,i,e[h+15],10,-30611744),i=u(i,c,r,n,e[h+6],15,-1560198380),n=u(n,i,c,r,e[h+13],21,1309151649),r=u(r,n,i,c,e[h+4],6,-145523070),c=u(c,r,n,i,e[h+11],10,-1120210379),i=u(i,c,r,n,e[h+2],15,718787259),n=u(n,i,c,r,e[h+9],21,-343485551),r=a(r,t),n=a(n,d),i=a(i,f),c=a(c,p)}return[r,n,i,c]}(function(e){const t=[];for(let r=0,n=8*e.length;r<n;r+=8)t[r>>5]|=(255&e.charCodeAt(r/8))<<r%32;return t}(e),8*e.length);switch(r){case n.Raw:return i;case n.Hex:return function(e){const t="0123456789abcdef",r=[];for(let n=0,a=4*e.length;n<a;n++)r.push(t.charAt(e[n>>2]>>n%4*8+4&15)+t.charAt(e[n>>2]>>n%4*8&15));return r.join("")}(i);case n.String:return function(e){const t=[];for(let r=0,n=32*e.length;r<n;r+=8)t.push(String.fromCharCode(e[r>>5]>>>r%32&255));return t.join("")}(i);case n.Base64:return function(e){const t=[];for(let r=0,n=4*e.length;r<n;r+=3){const n=(e[r>>2]>>r%4*8&255)<<16|(e[r+1>>2]>>(r+1)%4*8&255)<<8|e[r+2>>2]>>(r+2)%4*8&255;for(let a=0;a<4;a++)8*r+6*a>32*e.length?t.push("="):t.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(n>>6*(3-a)&63))}return t.join("")}(i)}}},8016:function(e,t,r){"use strict";var n=r("f4cc"),a=r("853c"),i=r("bb51"),s=r("64fc"),l=r("4f73"),o=r("18df");class u extends l["a"]{constructor(e){super(e),this._relation="",this._relationGeom=null,this._relationString="",this.declaredClass="esri.arcade.featureset.actions.SpatialFilter",this._relationString=e.relationString,this._parent=e.parentfeatureset,this._maxProcessing=40,this._relation=e.relation,this._relationGeom=e.relationGeom}_getSet(e){return null===this._wset?this._ensureLoaded().then(()=>this._parent._getFilteredSet("esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,null,null,e)).then(t=>(this._checkCancelled(e),this._wset=new s["a"](t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition)),this._wset)):Object(n["u"])(this._wset)}_isInFeatureSet(e){let t=this._parent._isInFeatureSet(e);return t===a["b"].NotInFeatureSet?t:(t=this._idstates[e],void 0===t?a["b"].Unknown:t)}_getFeature(e,t,r){return this._parent._getFeature(e,t,r)}_getFeatures(e,t,r,n){return this._parent._getFeatures(e,t,r,n)}_featureFromCache(e){return this._parent._featureFromCache(e)}executeSpatialRelationTest(e){if(null===e.geometry)return Object(n["u"])(!1);switch(this._relation){case"esriSpatialRelEnvelopeIntersects":{const t=Object(a["p"])(this._relationGeom),r=Object(a["p"])(e.geometry);return Object(i["q"])(t,r)}case"esriSpatialRelIntersects":return Object(i["q"])(this._relationGeom,e.geometry);case"esriSpatialRelContains":return Object(i["c"])(this._relationGeom,e.geometry);case"esriSpatialRelOverlaps":return Object(i["t"])(this._relationGeom,e.geometry);case"esriSpatialRelWithin":return Object(i["C"])(this._relationGeom,e.geometry);case"esriSpatialRelTouches":return Object(i["A"])(this._relationGeom,e.geometry);case"esriSpatialRelCrosses":return Object(i["d"])(this._relationGeom,e.geometry);case"esriSpatialRelRelation":return Object(i["w"])(this._relationGeom,e.geometry,this._relationString)}}_fetchAndRefineFeatures(e,t,r){const i=new s["a"]([],e,!1,null),l=Math.min(t,e.length);return this._parent._getFeatures(i,-1,l,r).then(()=>{this._checkCancelled(r);const t=[];for(let r=0;r<l;r++){const n=this._parent._featureFromCache(e[r]);t.push(this.executeSpatialRelationTest(n))}return Object(n["b"])(t)}).then(r=>{for(let n=0;n<t;n++)!0===r[n]?this._idstates[e[n]]=a["b"].InFeatureSet:this._idstates[e[n]]=a["b"].NotInFeatureSet;return"success"})}_getFilteredSet(e,t,r,n,a){return this._ensureLoaded().then(()=>this._parent._getFilteredSet("esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,r,n,a)).then(e=>{let r;return this._checkCancelled(a),r=null!==t?new s["a"](e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,this._clonePageDefinition(e.pagesDefinition)):new s["a"](e._candidates.slice(0),e._known.slice(0),e._ordered,this._clonePageDefinition(e.pagesDefinition)),r})}_stat(e,t,r,a,i,s,l){return""!==r?Object(n["u"])({calculated:!1}):this._parent._stat(e,t,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,i,s,l).then(n=>!1===n.calculated?null===i&&""===r&&null===a?this._manualStat(e,t,s,l):{calculated:!1}:n)}_canDoAggregates(e,t,r,a,i){return""!==r||null!==a||null===this._parent?Object(n["u"])(!1):this._parent._canDoAggregates(e,t,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,i)}_getAggregatePagesDataSourceDefinition(e,t,r,a,i,s,l){return null===this._parent?Object(n["t"])(new Error("Should never be called")):this._parent._getAggregatePagesDataSourceDefinition(e,t,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,i,s,l)}static registerAction(){l["a"]._featuresetFunctions.intersects=function(e){return null==e?new o["a"]({parentfeatureset:this}):new u({parentfeatureset:this,relation:"esriSpatialRelIntersects",relationGeom:e})},l["a"]._featuresetFunctions.envelopeIntersects=function(e){return null==e?new o["a"]({parentfeatureset:this}):new u({parentfeatureset:this,relation:"esriSpatialRelEnvelopeIntersects",relationGeom:e})},l["a"]._featuresetFunctions.contains=function(e){return null==e?new o["a"]({parentfeatureset:this}):new u({parentfeatureset:this,relation:"esriSpatialRelContains",relationGeom:e})},l["a"]._featuresetFunctions.overlaps=function(e){return null==e?new o["a"]({parentfeatureset:this}):new u({parentfeatureset:this,relation:"esriSpatialRelOverlaps",relationGeom:e})},l["a"]._featuresetFunctions.within=function(e){return null==e?new o["a"]({parentfeatureset:this}):new u({parentfeatureset:this,relation:"esriSpatialRelWithin",relationGeom:e})},l["a"]._featuresetFunctions.touches=function(e){return null==e?new o["a"]({parentfeatureset:this}):new u({parentfeatureset:this,relation:"esriSpatialRelTouches",relationGeom:e})},l["a"]._featuresetFunctions.crosses=function(e){return null==e?new o["a"]({parentfeatureset:this}):new u({parentfeatureset:this,relation:"esriSpatialRelCrosses",relationGeom:e})},l["a"]._featuresetFunctions.relate=function(e,t){return null==e?new o["a"]({parentfeatureset:this}):new u({parentfeatureset:this,relation:"esriSpatialRelRelation",relationGeom:e,relationString:t})}}}t["a"]=u},"80b7":function(e,t,r){"use strict";function n(e){return"date"===e.type||"esriFieldTypeDate"===e.type}function a(e){return e.toLowerCase().trim()}t["a"]=class{constructor(e){if(this.fields=e,this._fieldsMap=new Map,this._dateFieldsSet=new Set,this.dateFields=[],!e)return;const t=[];for(const r of e){const e=r&&r.name;if(e){const i=a(e);this._fieldsMap.set(e,r),this._fieldsMap.set(i,r),t.push(i),n(r)&&(this.dateFields.push(r),this._dateFieldsSet.add(r))}}t.sort(),this.uid=t.join(",")}destroy(){this._fieldsMap.clear()}has(e){return null!=this.get(e)}get(e){return null!=e?this._fieldsMap.get(e)||this._fieldsMap.get(a(e)):void 0}isDateField(e){return this._dateFieldsSet.has(this.get(e))}normalizeFieldName(e){const t=this.get(e);if(t)return t.name}}},8246:function(e,t,r){"use strict";r.d(t,"a",(function(){return a})),r.d(t,"b",(function(){return s})),r.d(t,"c",(function(){return i})),r.d(t,"d",(function(){return l})),r.d(t,"e",(function(){return o})),r.d(t,"f",(function(){return c})),r.d(t,"g",(function(){return u}));const n=[252,146,31,255],a={type:"esriSMS",style:"esriSMSCircle",size:6,color:n,outline:{type:"esriSLS",style:"esriSLSSolid",width:.75,color:[153,153,153,255]}},i={type:"esriSLS",style:"esriSLSSolid",width:.75,color:n},s={type:"esriSFS",style:"esriSFSSolid",color:[252,146,31,196],outline:{type:"esriSLS",style:"esriSLSSolid",width:.75,color:[255,255,255,191]}},l={type:"esriTS",color:[255,255,255,255],font:{family:"arial-unicode-ms",size:10,weight:"bold"},horizontalAlignment:"center",kerning:!0,haloColor:[0,0,0,255],haloSize:1,rotated:!1,text:"",xoffset:0,yoffset:0,angle:0},o={type:"esriSMS",style:"esriSMSCircle",color:[0,0,0,255],outline:null,size:10.5},u={type:"esriSLS",style:"esriSLSSolid",color:[0,0,0,255],width:1.5},c={type:"esriSFS",style:"esriSFSSolid",color:[0,0,0,255],outline:null}},"8b28":function(e,t,r){"use strict";r.d(t,"a",(function(){return s}));var n=r("a4ee"),a=(r("c120"),r("e92d"),r("cea0"),r("59b2")),i=r("d386");r("e041"),r("8eed"),r("f402");const s=e=>{let t=class extends e{constructor(){super(...arguments),this.customParameters=null}};return Object(n["a"])([Object(a["b"])({json:{write:!0,origins:{"web-scene":{write:!1}}}})],t.prototype,"customParameters",void 0),t=Object(n["a"])([Object(i["a"])("esri.layers.mixins.CustomParametersMixin")],t),t}},"94dc":function(e,t,r){"use strict";var n=r("f4cc");t["a"]=class{constructor(){this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}add(e,t,r){this._layerById[t]=r,this._layerByName[e]=r}featureSetByName(e,t=!0,r=["*"]){return void 0===this._layerByName[e]?this.resolvePromise(null):this.resolvePromise(this._layerByName[e])}featureSetById(e,t=!0,r=["*"]){return void 0===this._layerById[e]?this.resolvePromise(null):this.resolvePromise(this._layerById[e])}castToText(){return"object, FeatureSetCollection"}resolvePromise(e){return Object(n["u"])(e)}}},"96af":function(e,t,r){"use strict";function n(e,t){return e===t?0:null===e?-1:null===t?1:e<t?-1:1}class a{constructor(e){const t=e.split(",");this._fields=[],this._directions=[];for(let r=0;r<t.length;r++){const e=t[r].match(/\S+/g);this._fields.push(e[0]),2===e.length?"asc"===e[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let e="";for(let t=0;t<this._fields.length;t++)0!==t&&(e+=","),e+=this._fields[t],1===this._directions[t]?e+=" ASC":e+=" DESC";return e}order(e){e.sort((e,t)=>{for(let r=0;r<this._fields.length;r++){const a=this.featureValue(e.feature,this._fields[r],r),i=this.featureValue(t.feature,this._fields[r],r);let s=0;if(s=1===this._directions[r]?n(a,i):-1*n(a,i),0!==s)return s}return 0})}scanForField(e){for(let t=0;t<this._fields.length;t++)if(this._fields[t].toLowerCase().trim()===e.toLowerCase().trim())return!0;return!1}replaceFields(e){let t="";for(let r=0;r<this._fields.length;r++){0!==r&&(t+=",");let n=this._fields[r];for(const t of e)if(n.toLowerCase()===t.field.toLowerCase()){n=t.newfield;break}t+=n,1===this._directions[r]?t+=" ASC":t+=" DESC"}return new a(t)}featureValue(e,t,r){const n=e.attributes[t];if(void 0!==n)return n;for(const a in e.attributes)if(t.toLowerCase()===a.toLowerCase())return this._fields[r]=a,e.attributes[a];return null}}t["a"]=a},"9b40":function(e,t,r){"use strict";r.d(t,"a",(function(){return i}));var n=r("2255"),a=r("8048");const i={inches:Object(a["a"])(1,"meters","inches"),feet:Object(a["a"])(1,"meters","feet"),"us-feet":Object(a["a"])(1,"meters","us-feet"),yards:Object(a["a"])(1,"meters","yards"),miles:Object(a["a"])(1,"meters","miles"),"nautical-miles":Object(a["a"])(1,"meters","nautical-miles"),millimeters:Object(a["a"])(1,"meters","millimeters"),centimeters:Object(a["a"])(1,"meters","centimeters"),decimeters:Object(a["a"])(1,"meters","decimeters"),meters:Object(a["a"])(1,"meters","meters"),kilometers:Object(a["a"])(1,"meters","kilometers"),"decimal-degrees":1/Object(a["h"])(1,"meters",n["a"].radius)}},"9c2d":function(e,t,r){"use strict";var n=r("f4cc"),a=r("5996"),i=r("853c"),s=r("64fc"),l=r("66a2"),o=r("07c7"),u=r("4f73");class c extends u["a"]{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.actions.AttributeFilter",this._maxProcessing=1e3,this._parent=e.parentfeatureset,e.whereclause instanceof l["WhereClause"]?(this._whereclause=e.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=e.whereclause,this._whereclause=null)}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new a["a"]({wkid:4326}),this.geometryType=i["m"].point)}_getSet(e){return null===this._wset?this._ensureLoaded().then(()=>this._parent._getFilteredSet("",null,this._whereclause,null,e)).then(t=>(this._checkCancelled(e),null!==this._whereClauseFunction?this._wset=new s["a"](t._candidates.slice(0).concat(t._known.slice(0)),[],t._ordered,this._clonePageDefinition(t.pagesDefinition)):this._wset=new s["a"](t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition)),this._wset)):Object(n["u"])(this._wset)}_isInFeatureSet(e){let t=this._parent._isInFeatureSet(e);return t===i["b"].NotInFeatureSet?t:(t=this._idstates[e],void 0===t?i["b"].Unknown:t)}_getFeature(e,t,r){return this._parent._getFeature(e,t,r)}_getFeatures(e,t,r,n){return this._parent._getFeatures(e,t,r,n)}_featureFromCache(e){return this._parent._featureFromCache(e)}executeWhereClause(e){return this._whereclause.testFeature(e)}executeWhereClauseDeferred(e){if(null!==this._whereClauseFunction)try{const t=this._whereClauseFunction(e);return Object(n["p"])(t)?t:Object(n["u"])(t)}catch(t){return Object(n["t"])(t)}return Object(n["u"])(this.executeWhereClause(e))}_fetchAndRefineFeatures(e,t,r){const a=new s["a"]([],e,!1,null),l=Math.min(t,e.length);return this._parent._getFeatures(a,-1,l,r).then(()=>{if(this._checkCancelled(r),null==this._whereClauseFunction){for(let t=0;t<l;t++){const r=this._parent._featureFromCache(e[t]);!0===this.executeWhereClause(r)?this._idstates[e[t]]=i["b"].InFeatureSet:this._idstates[e[t]]=i["b"].NotInFeatureSet}return"success"}const a=[];for(let t=0;t<l;t++){const r=this._parent._featureFromCache(e[t]);a.push(this.executeWhereClauseDeferred(r))}return Object(n["b"])(a).then(r=>{for(let n=0;n<t;n++)!0===r[n]?this._idstates[e[n]]=i["b"].InFeatureSet:this._idstates[e[n]]=i["b"].NotInFeatureSet;return"success"})})}_getFilteredSet(e,t,r,n,a){return null!==this._whereClauseFunction||(null!==r?null!==this._whereclause&&(r=Object(o["a"])(this._whereclause,r)):r=this._whereclause),this._ensureLoaded().then(()=>this._parent._getFilteredSet(e,t,r,n,a)).then(e=>{let t;return this._checkCancelled(a),t=null!==this._whereClauseFunction?new s["a"](e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,this._clonePageDefinition(e.pagesDefinition)):new s["a"](e._candidates.slice(0),e._known.slice(0),e._ordered,this._clonePageDefinition(e.pagesDefinition)),t})}_stat(e,t,r,a,i,s,l){if(null!==this._whereClauseFunction)return null===i&&""===r&&null===a?this._manualStat(e,t,s,l):Object(n["u"])({calculated:!1});let u=this._whereclause;return null!==i&&null!==this._whereclause&&(u=Object(o["a"])(this._whereclause,i)),this._parent._stat(e,t,r,a,u,s,l).then(n=>!1===n.calculated?null===i&&""===r&&null===a?this._manualStat(e,t,s,l):{calculated:!1}:n)}_canDoAggregates(e,t,r,a,i){return null!==this._whereClauseFunction?Object(n["u"])(!1):(null!==i?null!==this._whereclause&&(i=Object(o["a"])(this._whereclause,i)):i=this._whereclause,null===this._parent?Object(n["u"])(!1):this._parent._canDoAggregates(e,t,r,a,i))}_getAggregatePagesDataSourceDefinition(e,t,r,a,i,s,l){return null===this._parent?Object(n["t"])(new Error("Should never be called")):(null!==i?null!==this._whereclause&&(i=Object(o["a"])(this._whereclause,i)):i=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(e,t,r,a,i,s,l))}static registerAction(){u["a"]._featuresetFunctions.filter=function(e){if("function"==typeof e)return new c({parentfeatureset:this,whereclause:e});let t=null;return e instanceof l["WhereClause"]&&(t=e),new c({parentfeatureset:this,whereclause:t})}}}t["a"]=c},a2b1:function(e,t,r){"use strict";var n=r("a4ee"),a=(r("c120"),r("7ffa")),i=(r("e92d"),r("cea0"),r("59b2")),s=r("afcf"),l=r("d386"),o=r("09db"),u=(r("e041"),r("8eed"),r("f402"),r("6a0e")),c=r("4106"),h=r("b5a9"),d=r("df3d"),f=(r("5970"),r("ace4"));let p=class extends u["a"]{constructor(e){super(e),this.id=null,this.name=null,this.domains=null,this.templates=null}readDomains(e){const t={};for(const r in e)if(e.hasOwnProperty(r)){const n=e[r];switch(n.type){case"range":t[r]=d["a"].fromJSON(n);break;case"codedValue":t[r]=c["a"].fromJSON(n);break;case"inherited":t[r]=h["a"].fromJSON(n)}}return t}writeDomains(e,t){const r={};for(const n in e)e.hasOwnProperty(n)&&(r[n]=e[n]&&e[n].toJSON());Object(a["c"])(r),t.domains=r}readTemplates(e){return e&&e.map(e=>new f["a"](e))}writeTemplates(e,t){t.templates=e&&e.map(e=>e.toJSON())}};Object(n["a"])([Object(i["b"])({json:{write:!0}})],p.prototype,"id",void 0),Object(n["a"])([Object(i["b"])({json:{write:!0}})],p.prototype,"name",void 0),Object(n["a"])([Object(i["b"])({json:{write:!0}})],p.prototype,"domains",void 0),Object(n["a"])([Object(s["a"])("domains")],p.prototype,"readDomains",null),Object(n["a"])([Object(o["a"])("domains")],p.prototype,"writeDomains",null),Object(n["a"])([Object(i["b"])({json:{write:!0}})],p.prototype,"templates",void 0),Object(n["a"])([Object(s["a"])("templates")],p.prototype,"readTemplates",null),Object(n["a"])([Object(o["a"])("templates")],p.prototype,"writeTemplates",null),p=Object(n["a"])([Object(l["a"])("esri.layers.support.FeatureType")],p);var _=p;t["a"]=_},ace4:function(e,t,r){"use strict";var n=r("a4ee"),a=(r("c120"),r("7ffa")),i=(r("e92d"),r("cea0"),r("59b2")),s=r("fa8a"),l=r("d386"),o=r("09db"),u=(r("e041"),r("8eed"),r("f402"),r("6a0e"));const c=new s["a"]({esriFeatureEditToolAutoCompletePolygon:"auto-complete-polygon",esriFeatureEditToolCircle:"circle",esriFeatureEditToolEllipse:"ellipse",esriFeatureEditToolFreehand:"freehand",esriFeatureEditToolLine:"line",esriFeatureEditToolNone:"none",esriFeatureEditToolPoint:"point",esriFeatureEditToolPolygon:"polygon",esriFeatureEditToolRectangle:"rectangle",esriFeatureEditToolArrow:"arrow",esriFeatureEditToolTriangle:"triangle",esriFeatureEditToolLeftArrow:"left-arrow",esriFeatureEditToolRightArrow:"right-arrow",esriFeatureEditToolUpArrow:"up-arrow",esriFeatureEditToolDownArrow:"down-arrow"});let h=class extends u["a"]{constructor(e){super(e),this.name=null,this.description=null,this.drawingTool=null,this.prototype=null,this.thumbnail=null}writeDrawingTool(e,t){t.drawingTool=c.toJSON(e)}writePrototype(e,t){t.prototype=Object(a["c"])(Object(a["a"])(e),!0)}writeThumbnail(e,t){t.thumbnail=Object(a["c"])(Object(a["a"])(e))}};Object(n["a"])([Object(i["b"])({json:{write:!0}})],h.prototype,"name",void 0),Object(n["a"])([Object(i["b"])({json:{write:!0}})],h.prototype,"description",void 0),Object(n["a"])([Object(i["b"])({json:{read:c.read,write:c.write}})],h.prototype,"drawingTool",void 0),Object(n["a"])([Object(o["a"])("drawingTool")],h.prototype,"writeDrawingTool",null),Object(n["a"])([Object(i["b"])({json:{write:!0}})],h.prototype,"prototype",void 0),Object(n["a"])([Object(o["a"])("prototype")],h.prototype,"writePrototype",null),Object(n["a"])([Object(i["b"])({json:{write:!0}})],h.prototype,"thumbnail",void 0),Object(n["a"])([Object(o["a"])("thumbnail")],h.prototype,"writeThumbnail",null),h=Object(n["a"])([Object(l["a"])("esri.layers.support.FeatureTemplate")],h);var d=h;t["a"]=d},aefa:function(e,t,r){"use strict";r.d(t,"a",(function(){return a})),r.d(t,"b",(function(){return i})),r.d(t,"c",(function(){return s}));var n=r("8a44");const a=-3;class i{constructor(e,t,r){this._namespace=e,this._storage=t,this._removeFunc=!1,this._hit=0,this._miss=0,this._storage.register(this),this._namespace+=":",r&&(this._storage.registerRemoveFunc(this._namespace,r),this._removeFunc=!0)}get namespace(){return this._namespace.slice(0,-1)}get hitRate(){return this._hit/(this._hit+this._miss)}get size(){return this._storage.size}get maxSize(){return this._storage.maxSize}resetHitRate(){this._hit=this._miss=0}destroy(){this._storage.clear(this._namespace),this._removeFunc&&this._storage.deregisterRemoveFunc(this._namespace),this._storage.deregister(this)}put(e,t,r,n=0){this._storage.put(this._namespace+e,t,r,n)}get(e){const t=this._storage.get(this._namespace+e);return void 0===t?++this._miss:++this._hit,t}pop(e){const t=this._storage.pop(this._namespace+e);return void 0===t?++this._miss:++this._hit,t}updateSize(e,t,r){this._storage.updateSize(this._namespace+e,t,r)}clear(){this._storage.clear(this._namespace)}clearAll(){this._storage.clearAll()}getStats(){return this._storage.getStats()}resetStats(){this._storage.resetStats()}}class s{constructor(e=10485760){this._maxSize=e,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=[],this._users=new n["a"]}register(e){this._users.push(e)}deregister(e){this._users.removeUnordered(e)}registerRemoveFunc(e,t){this._removeFuncs.push([e,t])}deregisterRemoveFunc(e){this._removeFuncs=this._removeFuncs.filter(t=>t[0]!==e)}get size(){return this._size}get maxSize(){return this._maxSize}set maxSize(e){this._maxSize=Math.max(e,0),this._checkSizeLimit()}put(e,t,r,n){const a=this._db.get(e);if(a&&(this._size-=a.size,this._db.delete(e),a.entry!==t&&this._notifyRemoved(e,a.entry)),r>this._maxSize)return void this._notifyRemoved(e,t);if(void 0===t)return void console.warn("Refusing to cache undefined entry ");if(!r||r<0)return void console.warn("Refusing to cache entry with invalid size "+r);const i=1+Math.max(n,-3)- -3;this._db.set(e,{entry:t,size:r,lifetime:i,lives:i}),this._size+=r,this._checkSizeLimit()}updateSize(e,t,r){const n=this._db.get(e);n&&n.entry===t&&(this._size-=n.size,r>this._maxSize?this._notifyRemoved(e,t):(n.size=r,this._size+=r,this._checkSizeLimit()))}pop(e){const t=this._db.get(e);if(t)return this._size-=t.size,this._db.delete(e),++this._hit,t.entry;++this._miss}get(e){const t=this._db.get(e);if(void 0!==t)return this._db.delete(e),t.lives=t.lifetime,this._db.set(e,t),++this._hit,t.entry;++this._miss}getStats(){const e={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},t={},r=new Array;this._db.forEach((e,n)=>{const a=e.lifetime;r[a]=(r[a]||0)+e.size,this._users.forAll(r=>{const a=r.namespace;if(n.startsWith(a)){const r=t[a]||0;t[a]=r+e.size}})});const n={};this._users.forAll(e=>{const r=e.namespace;if(!isNaN(e.hitRate)&&e.hitRate>0){const a=t[r]||0;t[r]=a,n[r]=Math.round(100*e.hitRate)+"%"}else n[r]="0%"});const a=Object.keys(t);a.forEach(e=>t[e]=t[e]/this._size*100),a.sort((e,r)=>t[r]-t[e]),a.forEach(r=>e[r]=Math.round(t[r])+"% / "+n[r]);for(let i=r.length-1;i>=0;--i){const t=r[i];t&&(e["Priority "+(i+-3-1)]=Math.round(t/this.size*100)+"%")}return e}resetStats(){this._hit=this._miss=0,this._users.forAll(e=>e.resetHitRate())}clear(e){this._db.forEach((t,r)=>{r.startsWith(e)&&(this._size-=t.size,this._db.delete(r),this._notifyRemoved(r,t.entry))})}clearAll(){this._db.forEach((e,t)=>this._notifyRemoved(t,e.entry)),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemoved(e,t){this._removeFuncs.forEach(r=>{e.startsWith(r[0])&&r[1](t)})}_checkSizeLimit(){if(!(this._size<=this._maxSize))for(const[e,t]of this._db)if(this._db.delete(e),t.lives<=1?(this._size-=t.size,this._notifyRemoved(e,t.entry)):(--t.lives,this._db.set(e,t)),this._size<=.9*this.maxSize)return}}},b1dc:function(e,t,r){"use strict";r.d(t,"a",(function(){return d})),r.d(t,"b",(function(){return b})),r.d(t,"c",(function(){return h})),r.d(t,"d",(function(){return S})),r.d(t,"e",(function(){return p})),r.d(t,"f",(function(){return _})),r.d(t,"g",(function(){return f})),r.d(t,"h",(function(){return m})),r.d(t,"i",(function(){return y})),r.d(t,"j",(function(){return g}));var n=r("f4cc"),a=r("89da"),i=r("853c"),s=r("07c7");function l(e){let t=0;for(let r=0;r<e.length;r++)t+=e[r];return t/e.length}function o(e){const t=l(e);let r=0;for(let n=0;n<e.length;n++)r+=Math.pow(t-e[n],2);return r/e.length}function u(e){const t=l(e);let r=0;for(let n=0;n<e.length;n++)r+=Math.pow(t-e[n],2);return r/(e.length-1)}function c(e){let t=0;for(let r=0;r<e.length;r++)t+=e[r];return t}function h(e){switch(e.toLowerCase()){case"distinct":return"distinct";case"avg":case"mean":return"avg";case"min":return"min";case"sum":return"sum";case"max":return"max";case"stdev":case"stddev":return"stddev";case"var":case"variance":return"var";case"count":return"count"}return""}function d(e,t,r=1e3){switch(e.toLowerCase()){case"distinct":return function(e,t){const r=[],n={},a=[];for(let s=0;s<e.length;s++){if(void 0!==e[s]&&null!==e[s]){const t=e[s];if(Object(i["j"])(t)||Object(i["k"])(t))void 0===n[t]&&(r.push(t),n[t]=1);else{let e=!1;for(let r=0;r<a.length;r++)!0===Object(i["g"])(a[r],t)&&(e=!0);!1===e&&(a.push(t),r.push(t))}}if(r.length>=t&&-1!==t)return r}return r}(t,r);case"avg":case"mean":return l(t);case"min":return Math.min.apply(Math,t);case"sum":return c(t);case"max":return Math.max.apply(Math,t);case"stdev":case"stddev":return Math.sqrt(o(t));case"var":case"variance":return o(t);case"count":return t.length}return 0}function f(e,t,r){return w(e,t,r,!0).then(e=>0===e.length?null:Math.min.apply(Math,e))}function p(e,t,r){return w(e,t,r,!0).then(e=>0===e.length?null:Math.max.apply(Math,e))}function _(e,t,r){let n="";return!1===Object(s["c"])(t)&&(n=Object(s["f"])(t,e.fields,null)),w(e,t,r,!0).then(e=>{if(0===e.length)return null;const t=l(e);return null===t?t:"integer"===n?(r=+(r=t),isFinite(r)?r-r%1||(r<0?-0:0===r?r:0):r):t;var r})}function g(e,t,r){return w(e,t,r,!0).then(e=>0===e.length?null:u(e))}function m(e,t,r){return w(e,t,r,!0).then(e=>0===e.length?null:Math.sqrt(u(e)))}function y(e,t,r){return w(e,t,r,!0).then(e=>0===e.length?null:c(e))}function b(e,t){try{return e.iterator(t).count()}catch(e){return Object(n["t"])(e)}}function w(e,t,r,a=!1){try{const i=e.iterator(r);return Object(n["c"])((e,r)=>{v(i,[],t,a,e,r)})}catch(i){return Object(n["t"])(i)}}function v(e,t,r,n,i,s){Object(a["q"])(e.next().then(a=>{try{if(null!==a){const l=r.calculateValue(a);return null===l?!1===n&&(t[t.length]=l):t[t.length]=l,v(e,t,r,n,i,s)}i(t)}catch(e){s(e)}},s))}function S(e,t,r=1e3,a=null){return function(e,t,r,a){try{return F(e.iterator(a),{},[],t,r)}catch(e){return Object(n["t"])(e)}}(e,t,r,a)}function F(e,t,r,n,a){return e.next().then(i=>{if(null!==i){const s=n.calculateValue(i);return null!=s&&void 0===t[s]&&(r.push(s),t[s]=1),r.length>=a&&-1!==a?r:F(e,t,r,n,a)}return r})}},bb51:function(e,t,r){"use strict";r.d(t,"a",(function(){return E})),r.d(t,"b",(function(){return c})),r.d(t,"c",(function(){return d})),r.d(t,"d",(function(){return f})),r.d(t,"e",(function(){return h})),r.d(t,"f",(function(){return R})),r.d(t,"g",(function(){return O})),r.d(t,"h",(function(){return b})),r.d(t,"i",(function(){return p})),r.d(t,"j",(function(){return _})),r.d(t,"k",(function(){return A})),r.d(t,"l",(function(){return M})),r.d(t,"m",(function(){return C})),r.d(t,"n",(function(){return P})),r.d(t,"o",(function(){return G})),r.d(t,"p",(function(){return j})),r.d(t,"q",(function(){return g})),r.d(t,"r",(function(){return S})),r.d(t,"s",(function(){return x})),r.d(t,"t",(function(){return w})),r.d(t,"u",(function(){return k})),r.d(t,"v",(function(){return L})),r.d(t,"w",(function(){return v})),r.d(t,"x",(function(){return N})),r.d(t,"y",(function(){return F})),r.d(t,"z",(function(){return I})),r.d(t,"A",(function(){return m})),r.d(t,"B",(function(){return T})),r.d(t,"C",(function(){return y}));r("4ae5");var n=r("a9ab"),a=(r("e06a"),r("dfa0"));function i(e){var t;return Array.isArray(e)?null==(t=e[0])?void 0:t.spatialReference:null==e?void 0:e.spatialReference}function s(e){return e?Array.isArray(e)?e.map(s):e.toJSON?e.toJSON():e:e}function l(e){return Array.isArray(e)?e.map(e=>Object(n["a"])(e)):Object(n["a"])(e)}let o;async function u(e,t){return(await async function(){return o||(o=Object(a["b"])("geometryEngineWorker",{strategy:"distributed"})),o}()).invoke("executeGEOperation",{operation:e,parameters:s(t)})}async function c(e,t){return l(await u("clip",[i(e),e,t]))}async function h(e,t){return l(await u("cut",[i(e),e,t]))}function d(e,t){return u("contains",[i(e),e,t])}function f(e,t){return u("crosses",[i(e),e,t])}function p(e,t,r){return u("distance",[i(e),e,t,r])}function _(e,t){return u("equals",[i(e),e,t])}function g(e,t){return u("intersects",[i(e),e,t])}function m(e,t){return u("touches",[i(e),e,t])}function y(e,t){return u("within",[i(e),e,t])}function b(e,t){return u("disjoint",[i(e),e,t])}function w(e,t){return u("overlaps",[i(e),e,t])}function v(e,t,r){return u("relate",[i(e),e,t,r])}function S(e){return u("isSimple",[i(e),e])}async function F(e){return l(await u("simplify",[i(e),e]))}async function O(e,t){return l(await u("difference",[i(e),e,t]))}async function I(e,t){return l(await u("symmetricDifference",[i(e),e,t]))}async function j(e,t){return l(await u("intersect",[i(e),e,t]))}async function T(e,t=null){const r=function(e,t){let r;return Array.isArray(e)?r=e:(r=[],r.push(e),null!=t&&r.push(t)),r}(e,t);return l(await u("union",[i(r),r]))}async function x(e,t,r,n,a,s){return l(await u("offset",[i(e),e,t,r,n,a,s]))}async function E(e,t,r,n=!1){const a=[i(e),e,t,r,n];return l(await u("buffer",a))}async function C(e,t,r,n,a,s){const o=[i(e),e,t,r,n,a,s];return l(await u("geodesicBuffer",o))}function D(e){return"xmin"in e?e.center:"x"in e?e:e.extent.center}async function N(e,t,r){var n;if(null==e)throw new Error("Illegal Argument Exception");const a=e.spatialReference;r=null!=(n=r)?n:D(e);const i=e.constructor.fromJSON(await u("rotate",[a,e,t,r]));return i.spatialReference=a,i}async function A(e,t,r,n){return l(await u("generalize",[i(e),e,t,r,n]))}async function R(e,t,r){return l(await u("densify",[i(e),e,t,r]))}async function P(e,t,r,n=0){return l(await u("geodesicDensify",[i(e),e,t,r,n]))}function k(e,t){return u("planarArea",[i(e),e,t])}function L(e,t){return u("planarLength",[i(e),e,t])}function M(e,t,r){return u("geodesicArea",[i(e),e,t,r])}function G(e,t,r){return u("geodesicLength",[i(e),e,t,r])}},d297:function(e,t,r){"use strict";r.d(t,"a",(function(){return F})),r.d(t,"b",(function(){return p})),r.d(t,"c",(function(){return _})),r.d(t,"d",(function(){return g})),r.d(t,"e",(function(){return m})),r.d(t,"f",(function(){return v})),r.d(t,"g",(function(){return f}));var n=r("6c97"),a=r("b2b2"),i=r("e92d"),s=r("9ef0"),l=r("8d60"),o=r("9b40"),u=r("86f2");const c=i["a"].getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),h=new l["a"],d=Math.PI,f=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function p(e,t,r){const n="visualVariables"in e&&e.visualVariables?e.visualVariables.filter(e=>"color"===e.type)[0]:e;if(!n)return;if("esri.renderers.visualVariables.ColorVariable"!==n.declaredClass)return void c.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");const i="number"==typeof t,l=i?null:t,o=l&&l.attributes;let u=i?t:null;const h=n.field,{ipData:d,hasExpression:f}=n.cache;let p=n.cache.compiledFunc;if(!h&&!f){const e=n.stops;return e&&e[0]&&e[0].color}if("number"!=typeof u)if(f){if(!Object(a["h"])(r)||!Object(a["h"])(r.arcade))return void c.error("Use of arcade expressions requires an arcade context");const e={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},t=r.arcade.arcadeUtils,i=t.getViewInfo(e),s=t.createExecContext(l,i);if(!p){const e=t.createSyntaxTree(n.valueExpression);p=t.createFunction(e),n.cache.compiledFunc=p}u=t.executeFunction(p,s)}else o&&(u=o[h]);const _=n.normalizationField,g=o?parseFloat(o[_]):void 0;if(null!=u&&(!_||i||!isNaN(g)&&0!==g)){isNaN(g)||i||(u/=g);const e=S(u,d);if(e){const t=e[0],i=e[1],l=t===i?n.stops[t].color:s["a"].blendColors(n.stops[t].color,n.stops[i].color,e[2],Object(a["h"])(r)?r.color:void 0);return new s["a"](l)}}}function _(e,t,r){const n="visualVariables"in e&&e.visualVariables?e.visualVariables.filter(e=>"opacity"===e.type)[0]:e;if(!n)return;if("esri.renderers.visualVariables.OpacityVariable"!==n.declaredClass)return void c.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");const i="number"==typeof t,s=i?null:t,l=s&&s.attributes;let o=i?t:null;const u=n.field,{ipData:h,hasExpression:d}=n.cache;let f=n.cache.compiledFunc;if(!u&&!d){const e=n.stops;return e&&e[0]&&e[0].opacity}if("number"!=typeof o)if(d){if(Object(a["g"])(r)||Object(a["g"])(r.arcade))return void c.error("Use of arcade expressions requires an arcade context");const e={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},t=r.arcade.arcadeUtils,i=t.getViewInfo(e),l=t.createExecContext(s,i);if(!f){const e=t.createSyntaxTree(n.valueExpression);f=t.createFunction(e),n.cache.compiledFunc=f}o=t.executeFunction(f,l)}else l&&(o=l[u]);const p=n.normalizationField,_=l?parseFloat(l[p]):void 0;if(null!=o&&(!p||i||!isNaN(_)&&0!==_)){isNaN(_)||i||(o/=_);const e=S(o,h);if(e){const t=e[0],r=e[1];if(t===r)return n.stops[t].opacity;{const a=n.stops[t].opacity;return a+(n.stops[r].opacity-a)*e[2]}}}}function g(e,t,r){const n="visualVariables"in e&&e.visualVariables?e.visualVariables.filter(e=>"rotation"===e.type)[0]:e;if(!n)return;if("esri.renderers.visualVariables.RotationVariable"!==n.declaredClass)return void c.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");const i=n.axis||"heading",s="heading"===i&&"arithmetic"===n.rotationType?90:0,l="heading"===i&&"arithmetic"===n.rotationType?-1:1,o="number"==typeof t?null:t,u=o&&o.attributes,h=n.field,{hasExpression:d}=n.cache;let f=n.cache.compiledFunc,p=0;if(!h&&!d)return p;if(d){if(Object(a["g"])(r)||Object(a["g"])(r.arcade))return void c.error("Use of arcade expressions requires an arcade context");const e={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},t=r.arcade.arcadeUtils,i=t.getViewInfo(e),s=t.createExecContext(o,i);if(!f){const e=t.createSyntaxTree(n.valueExpression);f=t.createFunction(e),n.cache.compiledFunc=f}p=t.executeFunction(f,s)}else u&&(p=u[h]||0);return p="number"!=typeof p||isNaN(p)?null:s+l*p,p}function m(e,t,r){const n="visualVariables"in e&&e.visualVariables?e.visualVariables.filter(e=>"size"===e.type)[0]:e;if(!n)return;if("esri.renderers.visualVariables.SizeVariable"!==n.declaredClass)return void c.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");const i=w(function(e,t,r){const n="number"==typeof t,i=n?null:t,s=i&&i.attributes;let l=n?t:null;const{isScaleDriven:o}=e.cache;let h=e.cache.compiledFunc;if(o){const t=Object(a["h"])(r)?r.scale:void 0,n=Object(a["h"])(r)?r.view:void 0;l=null==t||"3d"===n?function(e){let t=null,r=null;const n=e.stops;return n?(t=n[0].value,r=n[n.length-1].value):(t=e.minDataValue||0,r=e.maxDataValue||0),(t+r)/2}(e):t}else if(!n)switch(e.inputValueType){case"expression":{if(Object(a["g"])(r)||Object(a["g"])(r.arcade))return void c.error("Use of arcade expressions requires an arcade context");const t={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},n=r.arcade.arcadeUtils,s=n.getViewInfo(t),o=n.createExecContext(i,s);if(!h){const t=n.createSyntaxTree(e.valueExpression);h=n.createFunction(t),e.cache.compiledFunc=h}l=n.executeFunction(h,o);break}case"field":s&&(l=s[e.field]);break;case"unknown":l=null}if(!Object(u["d"])(l))return null;if(n||!e.normalizationField)return l;const d=s?parseFloat(s[e.normalizationField]):null;return Object(u["d"])(d)&&0!==d?l/d:null}(n,t,r),n,t,r,n.cache.ipData);return null==i||isNaN(i)?0:i}function y(e,t,r){return null==e?null:Object(u["c"])(e)?m(e,t,r):Object(u["d"])(e)?e:null}function b(e,t,r){return Object(u["d"])(r)&&e>r?r:Object(u["d"])(t)&&e<t?t:e}function w(e,t,r,n,i){switch(t.transformationType){case"additive":return function(e,t,r,n){return e+(y(t.minSize,r,n)||t.minDataValue)}(e,t,r,n);case"constant":return function(e,t,r){const n=e.stops;let a=n&&n.length&&n[0].size;return null==a&&(a=e.minSize),y(a,t,r)}(t,r,n);case"clamped-linear":return function(e,t,r,n){const i=(e-t.minDataValue)/(t.maxDataValue-t.minDataValue),s=y(t.minSize,r,n),l=y(t.maxSize,r,n),o=Object(a["h"])(n)?n.shape:void 0;if(e<=t.minDataValue)return s;if(e>=t.maxDataValue)return l;if("area"===t.scaleBy&&o){const e="circle"===o,t=e?d*Math.pow(s/2,2):s*s,r=t+i*((e?d*Math.pow(l/2,2):l*l)-t);return e?2*Math.sqrt(r/d):Math.sqrt(r)}return s+i*(l-s)}(e,t,r,n);case"proportional":return function(e,t,r,n){const i=Object(a["h"])(n)?n.shape:void 0,s=e/t.minDataValue,l=y(t.minSize,r,n),o=y(t.maxSize,r,n);let u=null;return u="circle"===i?2*Math.sqrt(s*Math.pow(l/2,2)):"square"===i||"diamond"===i||"image"===i?Math.sqrt(s*Math.pow(l,2)):s*l,b(u,l,o)}(e,t,r,n);case"stops":return function(e,t,r,n,a){const[i,s,l]=S(e,a);if(i===s)return y(t.stops[i].size,r,n);{const e=y(t.stops[i].size,r,n);return e+(y(t.stops[s].size,r,n)-e)*l}}(e,t,r,n,i);case"real-world-size":return function(e,t,r,n){const i=(Object(a["h"])(n)&&n.resolution?n.resolution:1)*o["a"][t.valueUnit],s=y(t.minSize,r,n),l=y(t.maxSize,r,n),{valueRepresentation:u}=t;let c=null;return c="area"===u?2*Math.sqrt(e/d)/i:"radius"===u||"distance"===u?2*e/i:e/i,b(c,s,l)}(e,t,r,n);case"identity":return e;case"unknown":return null}}function v(e,t,r){const{isScaleDriven:n}=e.cache;if(!(n&&"3d"===r||t))return null;const a={scale:t,view:r};let i=y(e.minSize,h,a),s=y(e.maxSize,h,a);if(null!=i||null!=s){if(i>s){const e=s;s=i,i=e}return{minSize:i,maxSize:s}}}function S(e,t){if(!t)return;let r=0,n=t.length-1;return t.some((t,a)=>e<t?(n=a,!0):(r=a,!1)),[r,n,(e-t[r])/(t[n]-t[r])]}function F(e,t,r){const a=["proportional","proportional","proportional"];for(const i of e){const e=i.useSymbolValue?"symbol-value":m(i,t,r);switch(i.axis){case"width":a[0]=e;break;case"depth":a[1]=e;break;case"height":a[2]=e;break;case"width-and-depth":a[0]=e,a[1]=e;break;case"all":case void 0:case null:a[0]=e,a[1]=e,a[2]=e;break;default:Object(n["a"])(i.axis)}}return a}},e335:function(e,t,r){"use strict";r.r(t),r.d(t,"constructAssociationMetaDataFeatureSetFromUrl",(function(){return X})),r.d(t,"constructFeatureSet",(function(){return K})),r.d(t,"constructFeatureSetFromPortalItem",(function(){return le})),r.d(t,"constructFeatureSetFromRelationship",(function(){return ee})),r.d(t,"constructFeatureSetFromUrl",(function(){return Q})),r.d(t,"createFeatureSetCollectionFromMap",(function(){return ne})),r.d(t,"createFeatureSetCollectionFromService",(function(){return ae})),r.d(t,"getPortal",(function(){return ie})),r.d(t,"initialiseMetaDataCache",(function(){return H})),r.d(t,"lookupUser",(function(){return se}));var n=r("f4cc"),a=r("f7be"),i=r("2eab"),s=r("0224"),l=r("a7e1"),o=r("853c"),u=r("94dc"),c=r("1fbd"),h=r("66a2"),d=r("9c2d"),f=r("5db9"),p=r("5996"),_=r("8d60"),g=r("89da"),m=r("a1f3"),y=r("64fc"),b=r("07c7"),w=r("b1dc"),v=r("80b7"),S=r("4f73"),F=r("2cad"),O=r("96af");class I{clone(){const e=new I;return e.field=this.field,e.tofieldname=this.tofieldname,e.typeofstat=this.typeofstat,e.workingexpr=this.workingexpr,e}static parseStatField(e,t,r){const n=new I;n.field=e;const a=h["WhereClause"].create(t,r),i=function(e){if("function"===e.parseTree.type){if(0===e.parseTree.args.value.length)return{name:e.parseTree.name,expr:null};if(e.parseTree.args.value.length>1)throw new Error("Statistic does not have 1 or 0 Parameters");const t=h["WhereClause"].create(Object(b["j"])(e.parseTree.args.value[0],o["a"].Standardised,e.parameters),e.fieldsIndex);return{name:e.parseTree.name,expr:t}}return null}(a);if(null===i)throw new Error("Invalid Statistic Function");const s=i.name.toUpperCase().trim();if("MIN"===s){if(n.typeofstat="MIN",n.workingexpr=i.expr,null===a)throw new Error("Invalid Statistic Function Parameters")}else if("MAX"===s){if(n.typeofstat="MAX",n.workingexpr=i.expr,null===a)throw new Error("Invalid Statistic Function Parameters")}else if("COUNT"===s)n.typeofstat="COUNT",n.workingexpr=i.expr;else if("STDEV"===s){if(n.typeofstat="STDDEV",n.workingexpr=i.expr,null===a)throw new Error("Invalid Statistic Function Parameters")}else if("SUM"===s){if(n.typeofstat="SUM",n.workingexpr=i.expr,null===a)throw new Error("Invalid Statistic Function Parameters")}else if("MEAN"===s){if(n.typeofstat="AVG",n.workingexpr=i.expr,null===a)throw new Error("Invalid Statistic Function Parameters")}else if("AVG"===s){if(n.typeofstat="AVG",n.workingexpr=i.expr,null===a)throw new Error("Invalid Statistic Function Parameters")}else{if("VAR"!==s)throw new Error("Invalid Statistic Function");if(n.typeofstat="VAR",n.workingexpr=i.expr,null===a)throw new Error("Invalid Statistic Function Parameters")}return n}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg";default:return"count"}}}var j=I,T=r("7efa");function x(e){if(!e)return"COUNT";switch(e.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}class E extends S["a"]{constructor(e){super(e),this._decodedStatsfield=[],this._decodedGroupbyfield=[],this._candosimplegroupby=!0,this.phsyicalgroupbyfields=[],this.objectIdField="ROW__ID",this._internalObjectIdField="ROW__ID",this._adaptedFields=[],this.declaredClass="esri.arcade.featureset.actions.Aggregate",this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=e.parentfeatureset,this._config=e}isTable(){return!0}_getSet(e){return null===this._wset?this._getFilteredSet("",null,null,null,e).then(e=>(this._wset=e,this._wset)):Object(n["u"])(this._wset)}_isInFeatureSet(){return o["b"].InFeatureSet}nextUniqueName(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;const t="T"+this._uniqueIds.toString();return e[t]=1,t}convertToEsriFieldType(e){return e}_initialiseFeatureSet(){const e={};let t=!1,r=1;const n=this._parent?this._parent.getFieldsIndex():new v["a"]([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===t;){let e=!1;for(let t=0;t<this._config.groupbyfields.length;t++)if(this._config.groupbyfields[t].name.toLowerCase()===this.objectIdField.toLowerCase()){e=!0;break}if(!1===e)for(let t=0;t<this._config.statsfields.length;t++)if(this._config.statsfields[t].name.toLowerCase()===this.objectIdField.toLowerCase()){e=!0;break}!1===e?t=!0:(this.objectIdField="ROW__ID"+r.toString(),r++)}for(const i of this._config.statsfields){const e=new j;e.field=i.name,e.tofieldname=i.name,e.workingexpr=i.expression instanceof h["WhereClause"]?i.expression:h["WhereClause"].create(i.expression,n),e.typeofstat=x(i.statistic),this._decodedStatsfield.push(e)}this._decodedGroupbyfield=[];for(const i of this._config.groupbyfields){const e={name:i.name,singlefield:null,tofieldname:i.name,expression:i.expression instanceof h["WhereClause"]?i.expression:h["WhereClause"].create(i.expression,n)};this._decodedGroupbyfield.push(e)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(const t of this._parent.fields)e[t.name.toUpperCase()]=1;this.types=null}else this.geometryType=o["m"].point,this.typeIdField="",this.types=null,this.spatialReference=new p["a"]({wkid:4326});this.fields=[];const a=new j;a.field=this.nextUniqueName(e),a.tofieldname=this.objectIdField,a.workingexpr=h["WhereClause"].create(this._parent.objectIdField,this._parent.getFieldsIndex()),a.typeofstat="MIN",this._decodedStatsfield.push(a);for(const i of this._decodedGroupbyfield){const t=new m["a"];if(i.name=this.nextUniqueName(e),t.name=i.tofieldname,t.alias=t.name,Object(b["c"])(i.expression)){const e=this._parent.getField(Object(b["i"])(i.expression,o["a"].Standardised));if(!e)throw new Error("Field is not present for Aggregation");i.name=e.name,i.singlefield=e.name,this.phsyicalgroupbyfields.push(e.name),t.type=e.type}else{t.type=this.convertToEsriFieldType(Object(b["f"])(i.expression,this._parent.fields));const e=new m["a"];e.name=i.name,e.alias=e.name,this.phsyicalgroupbyfields.push(i.name),this._adaptedFields.push(new F["d"](e,i.expression)),this._candosimplegroupby=!1}this.fields.push(t)}if(this._adaptedFields.length>0)for(const i of this._parent.fields)this._adaptedFields.push(new F["c"](i));for(let i=0;i<this._decodedStatsfield.length;i++){const t=new m["a"];let r=null;const n=this._decodedStatsfield[i];n.field=this.nextUniqueName(e),n.tofieldname===this.objectIdField&&(this._internalObjectIdField=n.field),t.name=n.tofieldname,t.alias=t.name;const a=null!==n.workingexpr&&Object(b["c"])(n.workingexpr)?Object(b["i"])(n.workingexpr,o["a"].Standardised):"";switch(this._decodedStatsfield[i].typeofstat){case"SUM":if(""!==a){if(r=this._parent.getField(a),!r)throw new Error("Field is not present for Aggregation");t.type=r.type}else t.type="double";break;case"MIN":case"MAX":if(""!==a){if(r=this._parent.getField(a),!r)throw new Error("Field is not present for Aggregation");t.type=r.type}else t.type="double";break;case"COUNT":t.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==a&&(r=this._parent.getField(a),!r))throw new Error("Field is not present for Aggregation");t.type="double"}this.fields.push(t)}}_canDoAggregates(){return Object(n["u"])(!1)}_getFeatures(e,t,r,a){-1!==t&&this._featureCache[t];const i=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(e,i)?this._expandPagedSet(e,i,0,0,a).then(()=>this._getFeatures(e,t,r,a)):Object(n["u"])("success")}_getFilteredSet(e,t,r,a,i){if(""!==e)return Object(n["u"])(new y["a"]([],[],!0,null));let s=null;const l={ordered:!1,nowhereclause:!1};return this._ensureLoaded().then(()=>{if(null!==r)for(let e=0;e<this._decodedStatsfield.length;e++)if(!0===Object(b["h"])(r,this._decodedStatsfield[e].tofieldname)){l.nowhereclause=!0,r=null;break}if(null!==a){l.ordered=!0;for(let e=0;e<this._decodedStatsfield.length;e++)if(!0===a.scanForField(this._decodedStatsfield[e].tofieldname)){a=null,l.ordered=!1;break}if(null!==a)for(const e of this._decodedGroupbyfield)if(null===e.singlefield&&!0===a.scanForField(e.tofieldname)){a=null,l.ordered=!1;break}}return!1===this._candosimplegroupby?Object(n["u"])(!1):this._parent._canDoAggregates(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,null)}).then(e=>{if(e){let e=null;r&&(e=this._reformulateWhereClauseWithoutGroupByFields(r));let t=null;return a&&(t=this._reformulateOrderClauseWithoutGroupByFields(a)),this._parent._getAggregatePagesDataSourceDefinition(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,e,t,this._internalObjectIdField).then(e=>(this._checkCancelled(i),s=!0===l.nowhereclause?new y["a"](e._candidates.slice(0).concat(e._known.slice(0)),[],!0===l.ordered&&e._ordered,this._clonePageDefinition(e.pagesDefinition)):new y["a"](e._candidates.slice(0),e._known.slice(0),!0===l.ordered&&e._ordered,this._clonePageDefinition(e.pagesDefinition)),s))}let t=this._parent;if(this._adaptedFields.length>0&&(t=new F["a"]({parentfeatureset:this._parent,adaptedFields:this._adaptedFields,extraFilter:null})),!0===l.nowhereclause)s=new y["a"](["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new f["a"]({parentfeatureset:t,orderbyclause:new O["a"](this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}});else{let e=t;if(null!==r){let t=null;r&&(t=this._reformulateWhereClauseWithoutGroupByFields(r)),e=new d["a"]({parentfeatureset:e,whereclause:t})}s=new y["a"](["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new f["a"]({parentfeatureset:e,orderbyclause:new O["a"](this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}})}return s})}_reformulateWhereClauseWithoutStatsFields(e){for(const t of this._decodedStatsfield)e=Object(b["g"])(e,t.tofieldname,Object(b["i"])(t.workingexpr,o["a"].Standardised),this._parent.getFieldsIndex());return e}_reformulateWhereClauseWithoutGroupByFields(e){for(const t of this._decodedGroupbyfield)t.tofieldname!==t.name&&(e=Object(b["g"])(e,t.tofieldname,Object(b["i"])(t.expression,o["a"].Standardised),this._parent.getFieldsIndex()));return e}_reformulateOrderClauseWithoutGroupByFields(e){const t=[];for(const r of this._decodedGroupbyfield)r.tofieldname!==r.name&&t.push({field:r.tofieldname,newfield:r.name});return t.length>0?e.replaceFields(t):e}_clonePageDefinition(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)}_refineSetBlock(e,t,r){try{if(!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQuery))return this._expandPagedSet(e,this._maxQuery,0,0,r).then(()=>this._refineSetBlock(e,t,r));this._checkCancelled(r);e._candidates.length;return this._refineKnowns(e,t),e._candidates.length,e._candidates.length,Object(n["u"])(e)}catch(a){return Object(n["t"])(a)}}_expandPagedSet(e,t,r,n,a){return this._expandPagedSetFeatureSet(e,t,r,n,a)}_getPhysicalPage(e,t,r){return!0===e.pagesDefinition.aggregatefeaturesetpagedefinition?Object(n["c"])((t,n)=>{this._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,r,[]).then(e=>{t(e)},n)}):this._getAgregagtePhysicalPage(e,t,r).then(e=>{for(const t of e){const e={geometry:t.geometry,attributes:{}};for(const r of this._decodedGroupbyfield)e.attributes[r.tofieldname]=t.attributes[r.name];for(const r of this._decodedStatsfield)e.attributes[r.tofieldname]=t.attributes[r.field];this._featureCache[e.attributes[this.objectIdField]]=new _["a"](e)}return e.length})}_sequentialGetPhysicalItem(e,t,r,a){return Object(n["c"])((n,i)=>{null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(r)),!0===e.pagesDefinition.internal.fullyResolved||0===t?n(a.length):this._nextAggregateItem(e,t,r,a,i=>{null===i?n(a.length):(t-=1,n(this._sequentialGetPhysicalItem(e,t,r,a)))},i)})}_nextAggregateItem(e,t,r,n,a,i){try{Object(g["q"])(e.pagesDefinition.internal.iterator.next()).then(s=>{if(null===s)if(null!==e.pagesDefinition.internal.workingItem){const t=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);n.push(t),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(t.attributes[this.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,a(null)}else e.pagesDefinition.internal.fullyResolved=!0,a(null);else{const l=this._generateAggregateHash(s);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[s],id:l};else{if(l!==e.pagesDefinition.internal.workingItem.id){const r=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);return n.push(r),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(r.attributes[this.objectIdField]),t-=1,e.pagesDefinition.internal.workingItem={features:[s],id:l},void a(r)}e.pagesDefinition.internal.workingItem.features.push(s)}this._nextAggregateItem(e,t,r,n,a,i)}},i)}catch(e){i(e)}}_calculateFieldStat(e,t,r){const n=[];for(let a=0;a<e.features.length;a++)if(null!==t.workingexpr){const r=t.workingexpr.calculateValue(e.features[a]);null!==r&&n.push(r)}else n.push(null);switch(t.typeofstat){case"MIN":r.attributes[t.tofieldname]=Object(w["a"])("min",n,-1);break;case"MAX":r.attributes[t.tofieldname]=Object(w["a"])("max",n,-1);break;case"SUM":r.attributes[t.tofieldname]=Object(w["a"])("sum",n,-1);break;case"COUNT":r.attributes[t.tofieldname]=n.length;break;case"VAR":r.attributes[t.tofieldname]=Object(w["a"])("var",n,-1);break;case"STDDEV":r.attributes[t.tofieldname]=Object(w["a"])("stddev",n,-1);break;case"AVG":r.attributes[t.tofieldname]=Object(w["a"])("avg",n,-1)}return!0}_calculateAndAppendAggregateItem(e){const t={attributes:{},geometry:null};for(const n of this._decodedGroupbyfield){const r=n.singlefield?e.features[0].attributes[n.singlefield]:n.expression.calculateValue(e.features[0]);t.attributes[n.tofieldname]=r}for(const n of this._decodedStatsfield)this._calculateFieldStat(e,n,t);const r=[];for(let n=0;n<this._decodedStatsfield.length;n++)r.push(this._calculateFieldStat(e,this._decodedStatsfield[n],t));return this._featureCache[t.attributes[this.objectIdField]]=new _["a"]({attributes:t.attributes,geometry:t.geometry}),t}_generateAggregateHash(e){let t="";for(const r of this._decodedGroupbyfield){const n=r.singlefield?e.attributes[r.singlefield]:r.expression.calculateValue(e);t+=null==n?":":":"+n.toString()}return Object(T["a"])(t,T["b"].String)}_stat(){return Object(n["u"])({calculated:!1})}getFeatureByObjectId(){return Object(n["u"])(null)}static registerAction(){S["a"]._featuresetFunctions.groupby=function(e,t){return new E({parentfeatureset:this,groupbyfields:e,statsfields:t})}}}var C=E,D=r("8016"),N=r("60fd"),A=r("5bd5"),R=r("a9ab"),P=r("75bf"),k=r("6655"),L=r("f29a"),M=r("f3be"),G=r("c64f"),B=r("dd5c"),U=r("3341"),q=r("feec");class V extends S["a"]{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",this._removeGeometry=!1,this._overrideFields=null,this.formulaCredential=null,this._pageJustIds=!1,this._requestStandardised=!1,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return o["f"]}end(){return this._layer}optimisePagingFeatureQueries(e){this._pageJustIds=e}convertQueryToLruCacheKey(e){const t=Object(o["q"])(e.toJSON());return Object(T["a"])(t,T["b"].String)}load(){return null===this._loadPromise&&(this._loadPromise=Object(n["c"])((e,t)=>{try{if(!0===this._layer.loaded)return this._initialiseFeatureSet(),void e(this);this._layer.when().then(()=>{try{this._initialiseFeatureSet(),e(this)}catch(e){t(e)}},t),this._layer.load()}catch(e){t(e)}})),this._loadPromise}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{const e=[];for(const t of this.fields)if("oid"===t.type)e.push(t);else for(const r of this._layer.outFields)if(r.toLowerCase()===t.name.toLowerCase()){e.push(t);break}this.fields=e}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const r of this.fields)if("oid"===r.type)e.push(r),t.push(r.name);else for(const n of this._overrideFields)if(n.toLowerCase()===r.name.toLowerCase()){e.push(r),t.push(r.name);break}this.fields=e,this._overrideFields=t}if(this._layer.source&&this._layer.source.sourceJSON){const e=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=o["a"].StandardisedNoInterval,null!=e&&e>=10.61&&(this._databaseType=o["a"].Standardised)):null!=e&&(e>=10.5&&(this._databaseType=o["a"].StandardisedNoInterval,this._requestStandardised=!0),e>=10.61&&(this._databaseType=o["a"].Standardised))}this.objectIdField=this._layer.objectIdField;for(const e of this.fields)"global-id"===e.type&&(this.globalIdField=e.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}_isInFeatureSet(){return o["b"].InFeatureSet}_refineSetBlock(e){return Object(n["u"])(e)}_candidateIdTransform(e){return e}_getSet(e){return null===this._wset?this._ensureLoaded().then(()=>this._getFilteredSet("",null,null,null,e)).then(e=>(this._wset=e,e)):Object(n["u"])(this._wset)}_runDatabaseProbe(e){return Object(n["c"])((t,r)=>{try{this._ensureLoaded().then(()=>{try{const n=new G["a"];n.where=e.replace("OBJECTID",this._layer.objectIdField),this._layer.queryObjectIds(n).then(()=>{t(!0)},()=>{try{t(!1)}catch(t){r(t)}})}catch(t){r(t)}})}catch(t){r(t)}})}_canUsePagination(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}_cacheableFeatureSetSourceKey(){return this._layer.url}pbfSupportedForQuery(e){return!e.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode}queryPBF(e){return e.quantizationParameters={mode:"edit"},Object(U["executeQueryPBF"])(this._layer.parsedUrl,e,new B["b"]({})).then(e=>L["default"].fromJSON(Object(k["j"])(e.data)).unquantize())}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}nativeCapabilities(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}executeQuery(e,t){const r=new q["a"]({url:this._layer.parsedUrl.path}),n="execute"===t&&this.pbfSupportedForQuery(e);let a=null;if(this.recentlyUsedQueries){const i=this.convertQueryToLruCacheKey(e);a=this.recentlyUsedQueries.getFromCache(i),null===a&&(a=!0!==n?r[t](e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(i,a),a=a.catch(e=>{throw this.recentlyUsedQueries.removeFromCache(i),e}))}return null===a&&(a=!0!==n?r[t](e):this.queryPBF(e)),a}_getFilteredSet(e,t,r,n,a){return this.databaseType().then(i=>{if(this.isTable()&&t&&null!==e&&""!==e)return new y["a"]([],[],!0,null);if(this._canUsePagination())return this._getFilteredSetUsingPaging(e,t,r,n,a);let s="",l=!1;null!==n&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(s=n.constructClause(),l=!0);const o=new G["a"];return o.where=null===r?null===t?"1=1":"":Object(b["i"])(r,i),this._requestStandardised&&(o.sqlFormat="standard"),o.spatialRelationship=this._makeRelationshipEnum(e),o.outSpatialReference=this.spatialReference,o.orderByFields=""!==s?s.split(","):null,o.geometry=null===t?null:t,o.relationParameter=this._makeRelationshipParam(e),this.executeQuery(o,"executeForIds").then(e=>(null===e&&(e=[]),this._checkCancelled(a),new y["a"]([],e,l,null)))})}_expandPagedSet(e,t,r,n,a){return this._expandPagedSetFeatureSet(e,t,r,n,a)}_getFilteredSetUsingPaging(e,t,r,a,i){try{let n="",s=!1;return null!==a&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(n=a.constructClause(),s=!0),this.databaseType().then(a=>{let l=null===r?null===t?"1=1":"":Object(b["i"])(r,a);this._layer.definitionExpression&&(l=""!==l?"(("+this._layer.definitionExpression+") AND ("+l+"))":this._layer.definitionExpression);let o=this._maxQueryRate();const u=this._layer.capabilities.query.maxRecordCount;void 0!==u&&u<o&&(o=u);let c=null;if(!0===this._pageJustIds)c=new y["a"]([],["GETPAGES"],s,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:this._layer.objectIdField,resultRecordCount:o,resultOffset:0,geometry:null===t?null:t,where:l,orderByFields:n,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{let r=!0;!0===this._removeGeometry&&(r=!1);const a=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]);c=new y["a"]([],["GETPAGES"],s,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:a.join(","),resultRecordCount:o,resultOffset:0,geometry:null===t?null:t,where:l,orderByFields:n,returnGeometry:r,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return this._expandPagedSet(c,o,0,1,i).then(()=>c)})}catch(e){return Object(n["t"])(e)}}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,r){try{const t=e.pagesDefinition.internal.lastRetrieved,n=t,a=e.pagesDefinition.internal.lastPage,i=new G["a"];return this._requestStandardised&&(i.sqlFormat="standard"),i.spatialRelationship=e.pagesDefinition.spatialRel,i.relationParameter=e.pagesDefinition.relationParam,i.outFields=e.pagesDefinition.outFields.split(","),i.num=e.pagesDefinition.resultRecordCount,i.start=e.pagesDefinition.internal.lastPage,i.geometry=e.pagesDefinition.geometry,i.where=e.pagesDefinition.where,i.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,i.returnGeometry=e.pagesDefinition.returnGeometry,i.outSpatialReference=this.spatialReference,this.executeQuery(i,"execute").then(i=>{if(this._checkCancelled(r),e.pagesDefinition.internal.lastPage!==a)return"done";for(let t=0;t<i.features.length;t++)e.pagesDefinition.internal.set[n+t]=i.features[t].attributes[this._layer.objectIdField];if(!1===this._pageJustIds)for(let e=0;e<i.features.length;e++)this._featureCache[i.features[e].attributes[this._layer.objectIdField]]=i.features[e];return(void 0===i.exceededTransferLimit&&i.features.length!==e.pagesDefinition.resultRecordCount||!1===i.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=t+i.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"})}catch(e){return Object(n["t"])(e)}}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.indexOf("*")>-1)return t;let r=!1;for(const n of t)if(n.toUpperCase()===this.objectIdField.toUpperCase()){r=!0;break}return!1===r&&t.push(this.objectIdField),t}_getFeatures(e,t,r,a){const i=[];try{if(-1!==t&&void 0===this._featureCache[t]&&i.push(t),!0===this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate()))return this._expandPagedSet(e,this._maxProcessingRate(),0,0,a).then(()=>this._getFeatures(e,t,r,a));let s=0;for(let n=e._lastFetchedIndex;n<e._known.length;n++){if(e._lastFetchedIndex+=1,s++,void 0===this._featureCache[e._known[n]]){let r=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){const t=this._layer._mode;if(void 0!==t._featureMap[e._known[n]]){const a=t._featureMap[e._known[n]];null!==a&&(r=!0,this._featureCache[e._known[n]]=a)}}if(!1===r&&(e._known[n]!==t&&i.push(e._known[n]),i.length>=this._maxProcessingRate()-1))break}if(s>=r&&0===i.length)break}if(0===i.length)return Object(n["u"])("success");try{const e=new G["a"];return this._requestStandardised&&(e.sqlFormat="standard"),e.objectIds=i,e.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]),e.returnGeometry=!0,!0===this._removeGeometry&&(e.returnGeometry=!1),e.outSpatialReference=this.spatialReference,this.executeQuery(e,"execute").then(e=>{if(this._checkCancelled(a),void 0!==e.error)return Object(n["t"])(new Error(e.error));for(let t=0;t<e.features.length;t++)this._featureCache[e.features[t].attributes[this._layer.objectIdField]]=e.features[t];return"success"})}catch(e){return Object(n["t"])(e)}}catch(e){return Object(n["t"])(e)}}_getDistinctPages(e,t,r,a,i,s,l,o,u){return this._ensureLoaded().then(()=>this.databaseType()).then(c=>{let h=r.parseTree.column;for(let e=0;e<this._layer.fields.length;e++)if(this._layer.fields[e].name.toLowerCase()===h.toLowerCase()){h=this._layer.fields[e].name;break}const d=new G["a"];this._requestStandardised&&(d.sqlFormat="standard");let f=null===s?null===i?"1=1":"":Object(b["i"])(s,c);return this._layer.definitionExpression&&(f=""!==f?"(("+this._layer.definitionExpression+") AND ("+f+"))":this._layer.definitionExpression),d.where=f,d.spatialRelationship=this._makeRelationshipEnum(a),d.relationParameter=this._makeRelationshipParam(a),d.geometry=null===i?null:i,d.returnDistinctValues=!0,d.returnGeometry=!1,d.outFields=[h],this.executeQuery(d,"execute").then(c=>{if(this._checkCancelled(u),!c.hasOwnProperty("features"))return Object(n["t"])(new Error("Unnexected Result querying statistics from layer"));let d=!1;for(let e=0;e<this._layer.fields.length;e++)if(this._layer.fields[e].name===h){"date"===this._layer.fields[e].type&&(d=!0);break}for(let e=0;e<c.features.length;e++){if(d){const t=c.features[e].attributes[h];null!==t?o.push(new Date(t)):o.push(t)}else o.push(c.features[e].attributes[h]);if(o.length>=l)break}return 0===c.features.length?o:c.features.length===this._layer.capabilities.query.maxRecordCount&&o.length<l?this._getDistinctPages(e+c.features.length,t,r,a,i,s,l,o,u).then(e=>({calculated:!0,result:e})):o})})}_distinctStat(e,t,r,n,a,i,s){return this._getDistinctPages(0,e,t,r,n,a,i,[],s).then(e=>({calculated:!0,result:e}))}isTable(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType}_countstat(e,t,r,n){return this.databaseType().then(e=>{const a=new G["a"];if(this._requestStandardised&&(a.sqlFormat="standard"),this.isTable()&&r&&null!==t&&""!==t)return{calculated:!0,result:0};let i=null===n?null===r?"1=1":"":Object(b["i"])(n,e);return this._layer.definitionExpression&&(i=""!==i?"(("+this._layer.definitionExpression+") AND ("+i+"))":this._layer.definitionExpression),a.where=i,a.where=i,a.spatialRelationship=this._makeRelationshipEnum(t),a.relationParameter=this._makeRelationshipParam(t),a.geometry=null===r?null:r,a.returnGeometry=!1,this.executeQuery(a,"executeForCount").then(e=>({calculated:!0,result:e}))})}_stats(e,t,r,a,i,s,l){return this._ensureLoaded().then(()=>{const o=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression,u=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics,c=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsDistinct;return"count"===e?c?this._countstat(e,r,a,i):{calculated:!1}:!1===u||!1===Object(b["c"])(t)&&!1===o||!1===t.isStandardized?""!==r||null!==i?{calculated:!1}:this._manualStat(e,t,s,l):"distinct"===e?!1===c?""!==r||null!==i?{calculated:!1}:this._manualStat(e,t,s,l):this._distinctStat(e,t,r,a,i,s,l):this.databaseType().then(s=>{if(this.isTable()&&a&&null!==r&&""!==r)return{calculated:!0,result:null};const l=new G["a"];this._requestStandardised&&(l.sqlFormat="standard");let o=null===i?null===a?"1=1":"":Object(b["i"])(i,s);this._layer.definitionExpression&&(o=""!==o?"(("+this._layer.definitionExpression+") AND ("+o+"))":this._layer.definitionExpression),l.where=o,l.spatialRelationship=this._makeRelationshipEnum(r),l.relationParameter=this._makeRelationshipParam(r),l.geometry=null===a?null:a;const u=new M["a"];u.statisticType=Object(w["c"])(e),u.onStatisticField=Object(b["i"])(t,s),u.outStatisticFieldName="ARCADE_STAT_RESULT",l.returnGeometry=!1;let c="ARCADE_STAT_RESULT";return l.outStatistics=[u],this.executeQuery(l,"execute").then(e=>{if(!e.hasOwnProperty("features")||0===e.features.length)return Object(n["t"])(new Error("Unnexected Result querying statistics from layer"));let t=!1;for(let r=0;r<e.fields.length;r++)if("ARCADE_STAT_RESULT"===e.fields[r].name.toUpperCase()){c=e.fields[r].name,"date"===e.fields[r].type&&(t=!0);break}if(t){let t=e.features[0].attributes[c];return null!==t&&(t=new Date(e.features[0].attributes[c])),{calculated:!0,result:t}}return{calculated:!0,result:e.features[0].attributes[c]}})})})}_stat(e,t,r,n,a,i,s){return this._stats(e,t,r,n,a,i,s)}_canDoAggregates(e,t){return this._ensureLoaded().then(()=>{let e=!1;const r=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression;if(void 0!==this._layer.capabilities&&null!==this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics&&!0===this._layer.capabilities.query.supportsOrderBy&&(e=!0),e)for(let n=0;n<t.length-1;n++)null!==t[n].workingexpr&&(!1===t[n].workingexpr.isStandardized||!1===Object(b["c"])(t[n].workingexpr)&&!1===r)&&(e=!1);return!1!==e})}_makeRelationshipEnum(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}_makeRelationshipParam(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""}_getAggregatePagesDataSourceDefinition(e,t,r,n,a,i,s){return this._ensureLoaded().then(()=>this.databaseType()).then(l=>{let o="",u=!1,c=!1;null!==i&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(o=i.constructClause(),c=!0),this._layer.capabilities&&this._layer.capabilities.query&&!1===this._layer.capabilities.query.supportsPagination&&(c=!1,u=!0,o=this._layer.objectIdField);const h=[];for(let e=0;e<t.length;e++){const r=new M["a"];r.onStatisticField=null!==t[e].workingexpr?Object(b["i"])(t[e].workingexpr,l):"",r.outStatisticFieldName=t[e].field,r.statisticType=t[e].toStatisticsName(),h.push(r)}""===o&&(o=e.join(","));let d=this._maxQueryRate();const f=this._layer.capabilities.query.maxRecordCount;void 0!==f&&f<d&&(d=f);let p=null===a?null===n?"1=1":"":Object(b["i"])(a,l);return this._layer.definitionExpression&&(p=""!==p?"(("+this._layer.definitionExpression+") AND ("+p+"))":this._layer.definitionExpression),new y["a"]([],["GETPAGES"],c,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(r),relationParam:this._makeRelationshipParam(r),outFields:["*"],useOIDpagination:u,generatedOid:s,resultRecordCount:d,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:h,geometry:null===n?null:n,where:p,orderByFields:o,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})})}_getAgregagtePhysicalPage(e,t,r){try{let t=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(t=""!==t?"("+t+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());const a=e.pagesDefinition.internal.lastRetrieved,i=a,s=e.pagesDefinition.internal.lastPage,l=new G["a"];return this._requestStandardised&&(l.sqlFormat="standard"),l.where=t,l.spatialRelationship=e.pagesDefinition.spatialRel,l.relationParameter=e.pagesDefinition.relationParam,l.outFields=e.pagesDefinition.outFields,l.outStatistics=e.pagesDefinition.outStatistics,l.geometry=e.pagesDefinition.geometry,l.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,l.num=e.pagesDefinition.resultRecordCount,l.start=e.pagesDefinition.internal.lastPage,l.returnGeometry=e.pagesDefinition.returnGeometry,l.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&l.geometry&&l.spatialRelationship?Object(n["u"])([]):this.executeQuery(l,"execute").then(t=>{if(this._checkCancelled(r),!t.hasOwnProperty("features"))return Object(n["t"])(new Error("Unnexected Result querying aggregates from layer"));const l=[];if(e.pagesDefinition.internal.lastPage!==s)return[];for(let r=0;r<t.features.length;r++)e.pagesDefinition.internal.set[i+r]=t.features[r].attributes[e.pagesDefinition.generatedOid];for(let e=0;e<t.features.length;e++)l.push(new _["a"]({attributes:t.features[e].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===t.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=t.features[t.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===t.exceededTransferLimit&&t.features.length!==e.pagesDefinition.resultRecordCount||!1===t.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=a+t.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,l})}catch(e){return Object(n["t"])(e)}}static create(e,t,r,n){const a=new A["default"]({url:e,outFields:null===t?["*"]:t});return new V({layer:a,spatialReference:r,lrucache:n})}relationshipMetaData(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]}serviceUrl(){return Object(o["i"])(this._layer.parsedUrl.path)}queryAttachments(e,t,r,a){if(this._layer.capabilities.data.supportsAttachment&&this._layer.capabilities.operations.supportsQueryAttachments){const n={objectIds:[e]};return(t&&t>0||r&&r>0)&&(n.size=[t&&t>0?t:0,r&&r>0?r:t+1]),a&&a.length>0&&(n.attachmentTypes=a),this._layer.queryAttachments(n).then(t=>{const r=[];return t&&t[e]&&t[e].forEach(t=>{const n=this._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+t.id.toString();r.push(new P["a"](t.id,t.name,t.contentType,t.size,n))}),r})}return Object(n["u"])([])}queryRelatedFeatures(e){const t={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()};return void 0!==e.resultOffset&&null!==e.resultOffset&&(t.resultOffset=e.resultOffset.toString()),void 0!==e.resultRecordCount&&null!==e.resultRecordCount&&(t.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(t.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(t.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(t.outSR=JSON.stringify(e.outSpatialReference.toJSON())),Object(i["default"])(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:t}).then(e=>{if(e.data){const t={},r=e.data;if(r&&r.relatedRecordGroups){const e=r.spatialReference;for(const n of r.relatedRecordGroups){const a=n.objectId,i=[];for(const t of n.relatedRecords){t.geometry&&(t.geometry.spatialReference=e);const r=new _["a"]({geometry:t.geometry?Object(R["a"])(t.geometry):null,attributes:t.attributes});i.push(r)}t[a]={features:i,exceededTransferLimit:!0===r.exceededTransferLimit}}}return t}return Object(n["t"])("Invalid Request")})}getFeatureByObjectId(e,t){const r=new q["a"]({url:this._layer.parsedUrl.path}),n=new G["a"];return n.outFields=t,n.returnGeometry=!1,n.outSpatialReference=this.spatialReference,n.where=this.objectIdField+"="+e.toString(),r.execute(n).then(e=>1===e.features.length?e.features[0]:null)}getIdentityUser(){return this.load().then(()=>{var e;const t=null==(e=a["b"])?void 0:e.findCredential(this._layer.url);return t?t.userId:null})}getOwningSystemUrl(){return this.load().then(()=>{var e;const t=null==(e=a["b"])?void 0:e.findServerInfo(this._layer.url);if(t)return Object(n["u"])(t.owningSystemUrl);let r=this._layer.url;const s=r.toLowerCase().indexOf("/rest/services");return r=s>-1?r.substring(0,s):r,r?(r+="/rest/info",Object(n["c"])((e,t)=>{Object(i["default"])(r,{query:{f:"json"}}).then(t=>{let r="";t.data&&t.data.owningSystemUrl&&(r=t.data.owningSystemUrl),e(r)},t=>{e("")})})):Object(n["u"])("")})}}var W=V,z=r("3802"),J=r("9fa3"),$=class extends S["a"]{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",this._findObjectId=-1,this._requestStandardised=!1,this._removeGeometry=!1,this._overrideFields=null,this.featureObjectId=null,this.relatedLayer=null,this.relationship=null,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,this._findObjectId=e.objectId,this.featureObjectId=e.objectId,this.relationship=e.relationship,this.relatedLayer=e.relatedLayer,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return o["f"]}end(){return this._layer}optimisePagingFeatureQueries(){}load(){return null===this._loadPromise&&(this._loadPromise=Object(n["c"])((e,t)=>{Object(n["b"])([this._layer.load(),this.relatedLayer.load()]).then(()=>{this._initialiseFeatureSet(),e(this)},t)})),this._loadPromise}nativeCapabilities(){return this.relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this.relatedLayer.geometryType,this.fields=this.relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const r of this.fields)if("oid"===r.type)e.push(r),t.push(r.name);else for(const n of this._overrideFields)if(n.toLowerCase()===r.name.toLowerCase()){e.push(r),t.push(r.name);break}this.fields=e,this._overrideFields=t}const e=this._layer.nativeCapabilities();e&&(this._databaseType=e.databaseType,this._requestStandardised=e.requestStandardised),this.objectIdField=this.relatedLayer.objectIdField,this.globalIdField=this.relatedLayer.globalIdField,this.hasM=this.relatedLayer.supportsM,this.hasZ=this.relatedLayer.supportsZ,this.typeIdField=this.relatedLayer.typeIdField,this.types=this.relatedLayer.types}databaseType(){return this.relatedLayer.databaseType().then(()=>(this._databaseType=this.relatedLayer._databaseType,this._databaseType))}isTable(){return this.relatedLayer.isTable()}_isInFeatureSet(){return o["b"].InFeatureSet}_candidateIdTransform(e){return e}_getSet(e){return null===this._wset?this._ensureLoaded().then(()=>this._getFilteredSet("",null,null,null,e)).then(e=>(this._wset=e,e)):Object(n["u"])(this._wset)}_changeFeature(e){const t={};for(const r of this.fields)t[r.name]=e.attributes[r.name];return new _["a"]({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})}_getFilteredSet(e,t,r,n,a){return this.databaseType().then(()=>{if(this.isTable()&&t&&null!==e&&""!==e)return new y["a"]([],[],!0,null);const i=this._layer.nativeCapabilities();if(!1===i.canQueryRelated)return new y["a"]([],[],!0,null);if(i.capabilities.queryRelated&&i.capabilities.queryRelated.supportsPagination)return this._getFilteredSetUsingPaging(e,t,r,n,a);let s="",l=!1;null!==n&&i.capabilities&&i.capabilities.queryRelated&&!0===i.capabilities.queryRelated.supportsOrderBy&&(s=n.constructClause(),l=!0);const o=new J["a"];o.objectIds=[this._findObjectId];const u=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this.relatedLayer.fields?this.relatedLayer.fields.map(e=>e.name):["*"]);o.outFields=u,o.relationshipId=this.relationship.id,o.where="1=1";let c=!0;return!0===this._removeGeometry&&(c=!1),o.returnGeometry=c,this._requestStandardised&&(o.sqlFormat="standard"),o.outSpatialReference=this.spatialReference,o.orderByFields=""!==s?s.split(","):null,i.source.queryRelatedFeatures(o).then(n=>{this._checkCancelled(a);const i=n[this._findObjectId]?n[this._findObjectId].features:[],s=[];for(let e=0;e<i.length;e++)this._featureCache[i[e].attributes[this._layer.objectIdField]]=i[e],s.push(i[e].attributes[this._layer.objectIdField]);const o=t&&null!==e&&""!==e,u=null!=r;return new y["a"](o||u?s:[],o||u?[]:s,l,null)})})}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.indexOf("*")>-1)return t;let r=!1;for(const n of t)if(n.toUpperCase()===this.objectIdField.toUpperCase()){r=!0;break}return!1===r&&t.push(this.objectIdField),t}_getFilteredSetUsingPaging(e,t,r,a,i){try{let n="",s=!1;const l=this._layer.nativeCapabilities();return null!==a&&l&&l.capabilities.queryRelated&&!0===l.capabilities.queryRelated.supportsOrderBy&&(n=a.constructClause(),s=!0),this.databaseType().then(()=>{let a=this._maxQueryRate();const o=l.capabilities.query.maxRecordCount;void 0!==o&&o<a&&(a=o);const u=t&&null!==e&&""!==e,c=null!=r;let h=null,d=!0;!0===this._removeGeometry&&(d=!1);const f=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this.relatedLayer.fields?this.relatedLayer.fields.map(e=>e.name):["*"]);return h=new y["a"](u||c?["GETPAGES"]:[],u||c?[]:["GETPAGES"],s,{outFields:f.join(","),resultRecordCount:a,resultOffset:0,objectIds:[this._findObjectId],where:"1=1",orderByFields:n,returnGeometry:d,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),this._expandPagedSet(h,a,0,0,i).then(()=>h)})}catch(e){return Object(n["t"])(e)}}_expandPagedSet(e,t,r,n,a){return this._expandPagedSetFeatureSet(e,t,r,n,a)}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,r){try{const t=e.pagesDefinition.internal.lastRetrieved,n=t,a=e.pagesDefinition.internal.lastPage,i=this._layer.nativeCapabilities(),s=new J["a"];return!0===this._requestStandardised&&(s.sqlFormat="standard"),s.relationshipId=this.relationship.id,s.objectIds=e.pagesDefinition.objectIds,s.resultOffset=e.pagesDefinition.internal.lastPage,s.resultRecordCount=e.pagesDefinition.resultRecordCount,s.outFields=e.pagesDefinition.outFields.split(","),s.where=e.pagesDefinition.where,s.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,s.returnGeometry=e.pagesDefinition.returnGeometry,s.outSpatialReference=this.spatialReference,i.source.queryRelatedFeatures(s).then(i=>{if(this._checkCancelled(r),e.pagesDefinition.internal.lastPage!==a)return 0;const s=i[this._findObjectId]?i[this._findObjectId].features:[];for(let t=0;t<s.length;t++)e.pagesDefinition.internal.set[n+t]=s[t].attributes[this._layer.objectIdField];for(let e=0;e<s.length;e++)this._featureCache[s[e].attributes[this._layer.objectIdField]]=s[e];const l=!i[this._findObjectId]||!1===i[this._findObjectId].exceededTransferLimit;return s.length!==e.pagesDefinition.resultRecordCount&&l&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=t+s.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,s.length})}catch(e){return Object(n["t"])(e)}}_getFeatures(e,t,r,a){const i=[];-1!==t&&void 0===this._featureCache[t]&&i.push(t);const s=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,s))return this._expandPagedSet(e,s,0,0,a).then(()=>this._getFeatures(e,t,r,a));let l=0;for(let n=e._lastFetchedIndex;n<e._known.length&&(l++,l<=r&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[n]&&void 0===this._featureCache[e._known[n]]&&(e._known[n]!==t&&i.push(e._known[n]),i.length>r)))&&!(l>=r&&0===i.length);n++);return 0===i.length?Object(n["u"])("success"):Object(n["t"])(new Error("Unaccounted for Features. Not in Feature Collection"))}_refineSetBlock(e,t,r){return Object(n["u"])(e)}_stat(e,t,r,a,i,s,l){return Object(n["u"])({calculated:!1})}get gdbVersion(){return this.relatedLayer.gdbVersion}_canDoAggregates(e,t,r,a,i){return Object(n["u"])(!1)}relationshipMetaData(){return this.relatedLayer.relationshipMetaData()}serviceUrl(){return this.relatedLayer.serviceUrl()}queryAttachments(e,t,r,n){return this.relatedLayer.queryAttachments(e,t,r,n)}getFeatureByObjectId(e,t){return this.relatedLayer.getFeatureByObjectId(e,t)}getOwningSystemUrl(){return this.relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this.relatedLayer.getIdentityUser()}};function H(){null===c["a"].applicationCache&&(c["a"].applicationCache=new c["a"])}function Y(e,t){if(c["a"].applicationCache){const r=c["a"].applicationCache.getLayerInfo(e);if(r)return r.then(r=>Object(n["u"])(new A["default"]({url:e,outFields:t,sourceJSON:r})));const a=new A["default"]({url:e,outFields:t});let i=Object(n["c"])((e,t)=>{a.load().then(()=>{e(a.sourceJSON)},e=>{t(e)})});return c["a"].applicationCache&&(c["a"].applicationCache.setLayerInfo(e,i),i=i.catch(t=>{throw c["a"].applicationCache.clearLayerInfo(e),t})),i.then(()=>Object(n["u"])(a))}return Object(n["u"])(new A["default"]({url:e,outFields:t}))}function Q(e,t,r,a,i){return Y(e,["*"]).then(e=>Object(n["u"])(K(e,t,r,a,i)))}function K(e,t=null,r=null,n=!0,a=null){return!0===e._hasMemorySource()?new z["a"]({layer:e,spatialReference:t,outFields:r,includeGeometry:n,lrucache:a}):new W({layer:e,spatialReference:t,outFields:r,includeGeometry:n,lrucache:a})}function Z(e){if(null!==c["a"].applicationCache){const t=c["a"].applicationCache.getLayerInfo(e);if(null!==t)return t}let t=Object(i["default"])(e,{responseType:"json",query:{f:"json"}}).then(e=>{if(e.data){const t=e.data;return t.layers||(t.layers=[]),t.tables||(t.tables=[]),Object(n["u"])(t)}return Object(n["u"])({layers:[],tables:[]})});return null!==c["a"].applicationCache&&(c["a"].applicationCache.setLayerInfo(e,t),t=t.catch(t=>{throw c["a"].applicationCache.clearLayerInfo(e),t})),t}function X(e,t){const r={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return Z(e).then(a=>{if(r.metadata=a,a.controllerDatasetLayers&&void 0!==a.controllerDatasetLayers.utilityNetworkLayerId&&null!==a.controllerDatasetLayers.utilityNetworkLayerId){if(a.layers)for(const e of a.layers)r.layerNameLkp[e.id]=e.name;if(a.tables)for(const e of a.tables)r.layerNameLkp[e.id]=e.name;const s=a.controllerDatasetLayers.utilityNetworkLayerId;return r.networkId=s,function(e,t){const r="QUERYDATAELEMTS:"+t.toString()+":"+e;if(null!==c["a"].applicationCache){const e=c["a"].applicationCache.getLayerInfo(r);if(null!==e)return e}let n=Object(i["default"])(e+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([t.toString()]),f:"json"}}).then(e=>{if(e.data){const t=e.data;if(t.layerDataElements&&t.layerDataElements[0])return t.layerDataElements[0]}throw new Error("Not Found")});return null!==c["a"].applicationCache&&(c["a"].applicationCache.setLayerInfo(r,n),n=n.catch(e=>{throw c["a"].applicationCache.clearLayerInfo(r),e})),n}(e,s).then(a=>{if(a){r.queryelem=a,r.queryelem&&r.queryelem.dataElement&&void 0!==r.queryelem.dataElement.schemaGeneration&&(r.unVersion=r.queryelem.dataElement.schemaGeneration),r.lkp={},r.queryelem.dataElement.domainNetworks||(r.queryelem.dataElement.domainNetworks=[]);for(const e of r.queryelem.dataElement.domainNetworks){for(const t of e.edgeSources?e.edgeSources:[]){const e={layerId:t.layerId,sourceId:t.sourceId,className:r.layerNameLkp[t.layerId]?r.layerNameLkp[t.layerId]:null};e.className&&(r.lkp[e.className]=e)}for(const t of e.junctionSources?e.junctionSources:[]){const e={layerId:t.layerId,sourceId:t.sourceId,className:r.layerNameLkp[t.layerId]?r.layerNameLkp[t.layerId]:null};e.className&&(r.lkp[e.className]=e)}}if(r.queryelem.dataElement.terminalConfigurations)for(const e of r.queryelem.dataElement.terminalConfigurations)for(const t of e.terminals)r.terminals.push({terminalId:t.terminalId,terminalName:t.terminalName});return function(e){if(null!==c["a"].applicationCache){const t=c["a"].applicationCache.getLayerInfo(e);if(null!==t)return t}let t=Object(i["default"])(e,{responseType:"json",query:{f:"json"}}).then(e=>{if(e.data){const t=e.data;return Object(n["u"])(t)}return Object(n["u"])(null)});return null!==c["a"].applicationCache&&(c["a"].applicationCache.setLayerInfo(e,t),t=t.catch(t=>{throw c["a"].applicationCache.clearLayerInfo(e),t})),t}(e+"/"+s).then(n=>{if(n.systemLayers&&void 0!==n.systemLayers.associationsTableId&&null!==n.systemLayers.associationsTableId){const a=[];return r.unVersion>=4&&(a.push("STATUS"),a.push("PERCENTALONG")),Q(e+"/"+n.systemLayers.associationsTableId.toString(),t,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...a],!1,null).then(e=>e.load()).then(e=>r.unVersion>=4?(e=e.filter(h["WhereClause"].create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",e.getFieldsIndex()))).load():e).then(e=>({lkp:r.lkp,associations:e,unVersion:r.unVersion,terminals:r.terminals}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}})}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}})}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}})}function ee(e,t,r,n=null,a=null,i=!0,s=null){let l=e.serviceUrl();return l?(l="/"===l.charAt(l.length-1)?l+t.relatedTableId.toString():l+"/"+t.relatedTableId.toString(),Q(l,n,a,i,s).then(l=>new $({layer:e,relatedLayer:l,relationship:t,objectId:r,spatialReference:n,outFields:a,includeGeometry:i,lrucache:s}))):null}d["a"].registerAction(),C.registerAction(),f["a"].registerAction(),D["a"].registerAction(),N["a"].registerAction();class te extends u["a"]{constructor(e,t=null,r=null){super(),this._map=e,this._overridespref=t,this.lrucache=r,this._instantLayers=[]}makeAndAddFeatureSet(e,t=!0,r=null){const n=K(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n}featureSetByName(e,t=!0,r=null){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then(()=>{try{return this.featureSetByName(e,t,r)}catch(e){return Object(n["t"])(e)}});null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const a=JSON.stringify(r);for(let n=0;n<this._instantLayers.length;n++){const r=this._instantLayers[n];if(r.opitem.title===e&&r.includeGeometry===t&&r.outFields===a)return this.resolvePromise(this._instantLayers[n].featureset)}const i=this._map.layers.find(t=>t instanceof A["default"]&&t.title===e);if(i)return this.resolvePromise(this.makeAndAddFeatureSet(i,t,r));if(this._map.tables){const n=this._map.tables.find(t=>!!(t.title&&t.title===e||t.title&&t.title===e));if(n){if(n instanceof A["default"])return this.resolvePromise(this.makeAndAddFeatureSet(n,t,r));if(n._materializedTable);else{const e=n.outFields?n:{...n,outFields:["*"]};n._materializedTable=new A["default"](e)}return n._materializedTable.load().then(()=>this.resolvePromise(this.makeAndAddFeatureSet(n._materializedTable,t,r)))}}return this.resolvePromise(null)}featureSetById(e,t=!0,r=["*"]){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then(()=>{try{return this.featureSetById(e,t,r)}catch(e){return Object(n["t"])(e)}});null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const a=JSON.stringify(r);for(let n=0;n<this._instantLayers.length;n++){const r=this._instantLayers[n];if(r.opitem.id===e&&r.includeGeometry===t&&r.outFields===a)return this.resolvePromise(this._instantLayers[n].featureset)}const i=this._map.layers.find(t=>t instanceof A["default"]&&t.id===e);if(i)return this.resolvePromise(this.makeAndAddFeatureSet(i,t,r));if(this._map.tables){const n=this._map.tables.find(t=>t.id===e);if(n){if(n instanceof A["default"])return this.resolvePromise(this.makeAndAddFeatureSet(n,t,r));if(n._materializedTable);else{const e={...n,outFields:["*"]};n._materializedTable=new A["default"](e)}return n._materializedTable.load().then(()=>this.resolvePromise(this.makeAndAddFeatureSet(n._materializedTable,t,r)))}}return this.resolvePromise(null)}}class re extends u["a"]{constructor(e,t=null,r=null){super(),this._url=e,this._overridespref=t,this.lrucache=r,this.metadata=null,this._instantLayers=[]}get url(){return this._url}makeAndAddFeatureSet(e,t=!0,r=null){const n=K(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n}_loadMetaData(){return Z(this._url).then(e=>(this.metadata=e,e))}load(){return this._loadMetaData()}clone(){return new re(this._url,this._overridespref,this.lrucache)}featureSetByName(e,t=!0,r=null){null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const n=JSON.stringify(r);for(let a=0;a<this._instantLayers.length;a++){const r=this._instantLayers[a];if(r.opitem.title===e&&r.includeGeometry===t&&r.outFields===n)return this.resolvePromise(this._instantLayers[a].featureset)}return this._loadMetaData().then(n=>{let a=null;for(const t of n.layers?n.layers:[])t.name===e&&(a=t);if(!a)for(const t of n.tables?n.tables:[])t.name===e&&(a=t);return a?Y(this._url+"/"+a.id,["*"]).then(e=>this.makeAndAddFeatureSet(e,t,r)):this.resolvePromise(null)})}featureSetById(e,t=!0,r=["*"]){null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const n=JSON.stringify(r);e=null!=e?e.toString():"";for(let a=0;a<this._instantLayers.length;a++){const r=this._instantLayers[a];if(r.opitem.id===e&&r.includeGeometry===t&&r.outFields===n)return this.resolvePromise(this._instantLayers[a].featureset)}return this._loadMetaData().then(n=>{let a=null;for(const t of n.layers?n.layers:[])null!==t.id&&void 0!==t.id&&t.id.toString()===e&&(a=t);if(!a)for(const t of n.tables?n.tables:[])null!==t.id&&void 0!==t.id&&t.id.toString()===e&&(a=t);return a?Y(this._url+"/"+a.id,["*"]).then(e=>this.makeAndAddFeatureSet(e,t,r)):this.resolvePromise(null)})}}function ne(e,t,r=null){return new te(e,t,r)}function ae(e,t,r=null){return new re(e,t,r)}function ie(e,t){return null===e?t:new s["a"]({url:e.field("url")})}function se(e,t,r){return a["b"].findCredential(e.restUrl)?"loaded"===e.loadStatus&&""===t&&e.user&&e.user.sourceJSON&&!1===r?Object(n["u"])(e.user.sourceJSON):""===t?Object(i["default"])(e.restUrl+"/community/self",{responseType:"json",query:{f:"json",...!1===r?{}:{returnUserLicenseTypeExtensions:!0}}}).then(e=>{if(e.data){const t=e.data;if(t&&t.username)return Object(n["u"])(t)}return Object(n["u"])(null)}):Object(i["default"])(e.restUrl+"/community/users/"+t,{responseType:"json",query:{f:"json"}}).then(e=>{if(e.data){const t=e.data;return t.error?null:Object(n["u"])(t)}return Object(n["u"])(null)}):Object(n["u"])(null)}function le(e,t,r,a,i,s,u){if(c["a"].applicationCache){const l=c["a"].applicationCache.getLayerInfo(e+":"+s.url);if(l)return l.then(e=>{try{const s=new A["default"]({url:Object(o["i"])(e.url)+"/"+t,outFields:["*"]});return Object(n["u"])(K(s,r,a,i,u))}catch(s){return Object(n["t"])(s)}},e=>Object(n["t"])(e))}return Object(n["c"])((n,h)=>{const d=new l["default"]({id:e,portal:s}).load();c["a"].applicationCache&&c["a"].applicationCache.setLayerInfo(e+":"+s.url,d),d.then(e=>{try{const s=new A["default"]({url:Object(o["i"])(e.url)+"/"+t,outFields:["*"]});n(K(s,r,a,i,u))}catch(n){h(n)}},t=>{c["a"].applicationCache&&c["a"].applicationCache.clearLayerInfo(e+":"+s.url),h(t)})})}}}]);
//# sourceMappingURL=chunk-3dd3b289.bb1cb8fb.js.map